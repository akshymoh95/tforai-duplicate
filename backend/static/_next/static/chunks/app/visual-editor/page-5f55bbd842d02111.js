(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[213],{8354:function(e,t,a){Promise.resolve().then(a.bind(a,9392))},9392:function(e,t,a){"use strict";a.r(t),a.d(t,{default:function(){return L}});var s=a(7437),l=a(2265),r=a(2892);let n={entity:"from-[#0f172a] to-[#1e293b] text-white",derived:"from-[#0f766e] to-[#14b8a6] text-white",reasoner:"from-[#b45309] to-[#f59e0b] text-white"},i={relation:"#0ea5e9",derived:"#14b8a6",reasoner:"#f59e0b",reasoner_signal:"#f97316",reasoner_output:"#ec4899",dependency:"#64748b"},o=["summary_full","summary_full_single","summary_chunk","summary_reduce"],d=(e,t)=>"derived::".concat(e,"::").concat(t),c=e=>"reasoner::".concat(e),x=e=>e?{entities:e.entities||[],relationships:(e.relationships||[]).map(e=>({...e,join_on:Array.isArray(e.join_on)?e.join_on:[]})),reasoners:e.reasoners||[],derived_rel_rules:e.derived_rel_rules||[],prompt_templates:e.prompt_templates||{},analysis_config:e.analysis_config||{},config:e.config||{}}:{entities:[],relationships:[],reasoners:[],derived_rel_rules:[],prompt_templates:{},analysis_config:{},config:{}},m=e=>{let t=(e.join_on||[]).filter(e=>Array.isArray(e)&&e.length>=2).map(e=>"".concat(e[0],"=").concat(e[1])).join(", ");return t?t.length<=80?t:"".concat(t.slice(0,77),"..."):""},p=e=>{let t=x(e),a=[],s=[],l=new Set,r=new Map,n=t.derived_rel_rules||[],i=e=>{l.has(e.id)||(l.add(e.id),s.push(e))},o=[],p=[],u=[],f=new Map,h=(e,t,a)=>{let s="".concat(e,"::").concat(t),l=f.get(s)||[];l.includes(a)||(l.push(a),f.set(s,l))};return t.reasoners.forEach(e=>{let a=e.outputs||[];a.length&&t.entities.forEach(t=>{((t.applicable_reasoners||[]).includes(e.id)||t.entity_type&&t.entity_type===e.entity_type)&&a.forEach(a=>{let s=(t.fields||[]).find(e=>e.name===a);s&&s.derived&&(h(t.name,a,e.id),i({id:"reasoner-output:".concat(e.id,":").concat(t.name,":").concat(a),from:c(e.id),to:d(t.name,a),label:"output",type:"reasoner_output"}))})})}),t.entities.forEach(e=>{r.set(e.name,e),o.push({id:e.name,label:e.name,kind:"entity",description:e.description||"",tags:[e.entity_type||"entity",e.table||""].filter(Boolean),inputs:e.join_keys||[],outputs:(e.fields||[]).map(e=>e.name),x:0,y:0,ref:{type:"entity",entityName:e.name}});let t=(e.fields||[]).filter(e=>e.derived);t.filter(e=>e.derived).forEach(t=>{let a=(f.get("".concat(e.name,"::").concat(t.name))||[]).length?["reasoner-output"]:[],s=n.some(a=>a.entity===e.name&&a.field===t.name);p.push({id:d(e.name,t.name),label:t.name,kind:"derived",description:t.description||"",tags:["derived",t.default_agg||t.role,s?"rule:ok":"rule:missing",...a].filter(Boolean),inputs:t.depends_on||[],outputs:[t.name],x:0,y:0,ref:{type:"derived",entityName:e.name,fieldName:t.name}}),i({id:"derived:".concat(e.name,":").concat(t.name),from:e.name,to:d(e.name,t.name),label:"derived",type:"derived"})}),t.forEach(a=>{(a.depends_on||[]).forEach(s=>{t.some(e=>e.name===s)&&i({id:"dep:".concat(e.name,":").concat(s,":").concat(a.name),from:d(e.name,s),to:d(e.name,a.name),label:"depends_on",type:"dependency"})})})}),t.reasoners.forEach(e=>{u.push({id:c(e.id),label:e.name||e.id,kind:"reasoner",description:e.description||"",tags:["reasoner",e.entity_type].filter(Boolean),inputs:(e.signals||[]).map(e=>e.metric_field),outputs:e.outputs||[],x:0,y:0,ref:{type:"reasoner",reasonerId:e.id}})}),t.relationships.forEach(e=>{r.has(e.from_entity)&&r.has(e.to_entity)&&i({id:"rel:".concat(e.name,":").concat(e.from_entity,":").concat(e.to_entity),from:e.from_entity,to:e.to_entity,label:m(e),type:"relation"})}),t.entities.forEach(e=>{t.reasoners.forEach(t=>{((e.applicable_reasoners||[]).includes(t.id)||e.entity_type&&e.entity_type===t.entity_type)&&i({id:"reasoner:".concat(e.name,":").concat(t.id),from:e.name,to:c(t.id),label:t.id,type:"reasoner"})})}),t.reasoners.forEach(e=>{let a=e.signals||[];a.length&&t.entities.forEach(t=>{if(!((t.applicable_reasoners||[]).includes(e.id)||t.entity_type&&t.entity_type===e.entity_type))return;let s=new Set((t.fields||[]).filter(e=>e.derived).map(e=>e.name));a.forEach(a=>{let l=(a.metric_field||"").trim();if(!l)return;let r=null,n=l;if(l.includes(".")){let e=l.split(".");r=e.slice(0,-1).join("."),n=e[e.length-1]}(!r||r===t.name)&&s.has(n)&&i({id:"reasoner-signal:".concat(t.name,":").concat(n,":").concat(e.id),from:d(t.name,n),to:c(e.id),label:a.name||n,type:"reasoner_signal"})})})}),a.push(...o,...p,...u),{nodes:a,edges:s}},u=(e,t)=>{let a=["entity","derived","reasoner"],s=[...e].sort((e,t)=>{let s=a.indexOf(e.kind)-a.indexOf(t.kind);return 0!==s?s:e.label.localeCompare(t.label)}),l={entity:0,derived:0,reasoner:0},r={entity:120,derived:520,reasoner:900};return s.map(e=>{let a=t.get(e.id);if(a)return{...e,x:a.x,y:a.y};let s=l[e.kind]++;return{...e,x:r[e.kind],y:90+190*s}})},f=(e,t)=>{let a=e.filter(e=>"entity"===e.kind),s=new Map(a.map(e=>[e.id,e])),l=new Map;a.forEach(e=>l.set(e.id,new Set)),t.filter(e=>"relation"===e.type).forEach(e=>{l.has(e.from)&&l.has(e.to)&&(l.get(e.from).add(e.to),l.get(e.to).add(e.from))});let r=new Map,n=new Set,i=90;return[...a].sort((e,t)=>{var a,s;let r=(null===(a=l.get(e.id))||void 0===a?void 0:a.size)||0,n=(null===(s=l.get(t.id))||void 0===s?void 0:s.size)||0;return r!==n?n-r:e.label.localeCompare(t.label)}).forEach(e=>{if(n.has(e.id))return;let t=[e.id],a=[];for(n.add(e.id);t.length;){let e=t.shift();a.push(e),(l.get(e)||new Set).forEach(e=>{n.has(e)||(n.add(e),t.push(e))})}let o=a.map(e=>{var t,a;return{id:e,degree:(null===(t=l.get(e))||void 0===t?void 0:t.size)||0,label:(null===(a=s.get(e))||void 0===a?void 0:a.label)||e}}).sort((e,t)=>t.degree-e.degree||e.label.localeCompare(t.label))[0],d=new Map,c=[o.id];for(d.set(o.id,0);c.length;){let e=c.shift(),t=d.get(e)||0;(l.get(e)||new Set).forEach(e=>{d.has(e)||(d.set(e,t+1),c.push(e))})}a.forEach(e=>{d.has(e)||d.set(e,0)});let x=new Map;d.forEach((e,t)=>{let a=x.get(e)||[];a.push(t),x.set(e,a)});let m=i;Array.from(x.keys()).sort((e,t)=>e-t).forEach(e=>{let t=x.get(e)||[];t.sort((e,t)=>{var a,l;let r=(null===(a=s.get(e))||void 0===a?void 0:a.label)||e,n=(null===(l=s.get(t))||void 0===l?void 0:l.label)||t;return r.localeCompare(n)}),t.forEach((t,a)=>{let s=i+180*a;r.set(t,{x:120+320*e,y:s}),s>m&&(m=s)})}),i=m+220}),e.map(e=>{if("entity"===e.kind){let t=r.get(e.id);if(t)return{...e,x:t.x,y:t.y}}return e})},h=(e,t)=>{let a=1,s=e;for(;t.has(s);)a+=1,s="".concat(e,"_").concat(a);return s},b=(e,t,a)=>Math.min(a,Math.max(t,e)),y=e=>e.map(e=>{let[t,a]=e;return"".concat(t,"=").concat(a)}).join("\n"),g=e=>e.split(/\n+/).map(e=>e.trim()).filter(Boolean).map(e=>e.split(/[=,:]/).map(e=>e.trim())).filter(e=>e.length>=2&&e[0]&&e[1]).map(e=>[e[0],e[1]]),v=new Set(["select","from","where","case","when","then","else","end","and","or","not","nullif","coalesce","lag","lead","over","partition","order","by","as","in","on","join","left","right","inner","outer","sum","avg","min","max","count","year","month","date_from_parts"].map(e=>e.toLowerCase())),N=(e,t,a)=>{let s=[...e.match(/[A-Za-z_][A-Za-z0-9_]*(?:\.[A-Za-z_][A-Za-z0-9_]*)+/g)||[],...e.match(/[A-Za-z_][A-Za-z0-9_]*/g)||[]],l=new Set(t.map(e=>e.toLowerCase())),r=(a||"").toLowerCase(),n=new Set;return s.forEach(e=>{var t;let a=(null===(t=e.split(".").pop())||void 0===t?void 0:t.toLowerCase())||"";l.has(a)&&a!==r&&(v.has(a)||n.add(a))}),Array.from(n)},j=[{label:"number",value:"number"},{label:"string",value:"varchar"},{label:"date",value:"date"},{label:"timestamp",value:"timestamp"},{label:"boolean",value:"boolean"}],w=["","sum","avg","min","max","last"],_=(e,t)=>Array.from(new Set([...e,...(t||[]).map(e=>e.field).filter(Boolean)])),k=(e,t,a)=>e&&(e.derived_rel_rules||[]).find(e=>e.entity===t&&e.field===a)||null,C=(e,t)=>{let a=(e.derived_rel_rules||[]).filter(e=>!(e.entity===t.entity&&e.field===t.field));return a.push(t),a},S=e=>{if(!e||!Array.isArray(e.rules))return"";let t=e.rules.map(e=>{let t=String(e.expr||"").trim();if(!t)return"";let a=String(e.when||"").trim();return a?"".concat(a," -> ").concat(t):t}).filter(Boolean).join("; ");return t?t.length>200?"".concat(t.slice(0,197),"..."):t:""},M=(e,t,a)=>{let s=String(a.expr||"").trim();if(s)return s;let l=S(k(e,t,a.name));return l?"rule: ".concat(l):"No expression."},E=(e,t,a)=>({entity:e,field:t,rules:[{expr:a}]}),O=(e,t,a)=>N((e.rules||[]).map(e=>[e.expr,e.when].filter(Boolean).join(" ")).join(" "),t,a),R=e=>{let t=(e||"").toLowerCase();return["char","text","string","varchar","date","time","timestamp","boolean"].some(e=>t.includes(e))?"dimension":"metric"},D=(e,t)=>{let a=(e||"").toLowerCase(),s=(t||"").toLowerCase();return["percent","pct","ratio","rate","avg","mean","score","trend"].some(e=>a.includes(e))?"avg":["float","number","decimal","numeric","int"].some(e=>s.includes(e))?"sum":""},A=e=>[e.database,e.schema,e.table].filter(Boolean).join(".");function L(){var e,t,a,m,v,S,L,J,I,T,P,B,F,Y,z,q,X,U,G,Q,V;let W=(0,l.useRef)(null),Z=(0,l.useRef)(null),H=(0,l.useMemo)(()=>"https://api.tulapi.ai",[]),[K,$]=(0,l.useState)(null),[ee,et]=(0,l.useState)([]),[ea,es]=(0,l.useState)([]),[el,er]=(0,l.useState)(null),[en,ei]=(0,l.useState)(null),[eo,ed]=(0,l.useState)(null),[ec,ex]=(0,l.useState)({entity:!0,derived:!0,reasoner:!0}),[em,ep]=(0,l.useState)(""),[eu,ef]=(0,l.useState)(""),[eh,eb]=(0,l.useState)(""),[ey,eg]=(0,l.useState)(!1),[ev,eN]=(0,l.useState)(""),[ej,ew]=(0,l.useState)(""),[e_,ek]=(0,l.useState)(1),[eC,eS]=(0,l.useState)({x:0,y:0}),[eM,eE]=(0,l.useState)(null),[eO,eR]=(0,l.useState)(!1),[eD,eA]=(0,l.useState)(""),[eL,eJ]=(0,l.useState)(""),[eI,eT]=(0,l.useState)(""),[eP,eB]=(0,l.useState)(""),[eF,eY]=(0,l.useState)(""),[ez,eq]=(0,l.useState)([]),[eX,eU]=(0,l.useState)(""),[eG,eQ]=(0,l.useState)(""),[eV,eW]=(0,l.useState)(!1),[eZ,eH]=(0,l.useState)(""),[eK,e$]=(0,l.useState)([]),[e0,e2]=(0,l.useState)(null),[e1,e3]=(0,l.useState)("base"),[e6,e4]=(0,l.useState)(!1),[e5,e9]=(0,l.useState)(!0),[e7,e8]=(0,l.useState)([]),[te,tt]=(0,l.useState)(null),[ta,ts]=(0,l.useState)("add"),[tl,tr]=(0,l.useState)({}),[tn,ti]=(0,l.useState)(null),[to,td]=(0,l.useState)({entities:{},relationships:{},reasoners:{}}),tc=(0,l.useRef)(""),tx=(0,l.useMemo)(()=>ee.length?{width:Math.max(Math.max(...ee.map(e=>e.x+240))+420,1600),height:Math.max(Math.max(...ee.map(e=>e.y+148))+420,900)}:{width:1600,height:900},[ee]),tm=(0,l.useMemo)(()=>ee.find(e=>e.id===el)||null,[ee,el]),tp=(0,l.useMemo)(()=>ee.find(e=>e.id===tn)||null,[tn,ee]),tu=(0,l.useMemo)(()=>{let e=x(K);return{entities:e.entities,reasoners:e.reasoners,relationships:e.relationships,entityMap:new Map(e.entities.map(e=>[e.name,e])),reasonerMap:new Map(e.reasoners.map(e=>[e.id,e]))}},[K]),tf=(0,l.useMemo)(()=>(null==K?void 0:K.prompt_templates)||{},[K]),th=(0,l.useMemo)(()=>[...o].sort(),[]),tb=(0,l.useMemo)(()=>{var e,t,a,s,l;let r=((null==K?void 0:K.analysis_config)||{}).prompt_context;return{business:String(null!==(t=null!==(e=null==r?void 0:r.business_context)&&void 0!==e?e:null==r?void 0:r.business)&&void 0!==t?t:""),data:String(null!==(s=null!==(a=null==r?void 0:r.data_context)&&void 0!==a?a:null==r?void 0:r.data)&&void 0!==s?s:""),expectations:String(null!==(l=null==r?void 0:r.expectations)&&void 0!==l?l:"")}},[K]),ty=(0,l.useCallback)((e,t)=>{var a,s,l,r,n;if(!K)return;let i={...K.analysis_config||{}},o=i.prompt_context||{},d={business_context:String(null!==(s=null!==(a=o.business_context)&&void 0!==a?a:o.business)&&void 0!==s?s:""),data_context:String(null!==(r=null!==(l=o.data_context)&&void 0!==l?l:o.data)&&void 0!==r?r:""),expectations:String(null!==(n=o.expectations)&&void 0!==n?n:"")};"business"===e&&(d.business_context=t),"data"===e&&(d.data_context=t),"expectations"===e&&(d.expectations=t),i.prompt_context=d,$({...K,analysis_config:i})},[K]),tg=(0,l.useCallback)(e=>{if(!K)return;let t={...K.prompt_templates||{}};e in t&&(delete t[e],$({...K,prompt_templates:t}))},[K]),tv=(0,l.useCallback)(()=>{if(!K)return;let e={...K.prompt_templates||{}};o.forEach(t=>{delete e[t]}),$({...K,prompt_templates:e}),eb("Prompt templates reset to defaults.")},[K]),tN=(0,l.useCallback)(async()=>{if(K){if(!(tb.business.trim()||tb.data.trim()||tb.expectations.trim())){eb("Add business/data/expectations to generate prompts.");return}eg(!0),eb("Generating prompt templates...");try{let e=await fetch("".concat(H,"/api/registry/prompts/customize"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({business_context:tb.business,data_context:tb.data,expectations:tb.expectations,prompt_keys:o})});if(!e.ok){eb("Prompt generation failed.");return}let t=(await e.json()).templates||{},a={...K.prompt_templates||{},...t};$({...K,prompt_templates:a}),eb("Prompt templates generated.")}catch(e){eb("Prompt generation failed.")}finally{eg(!1)}}},[H,tb.business,tb.data,tb.expectations,K]),tj=(0,l.useMemo)(()=>{if(!te)return{entities:[],relationships:[],reasoners:[]};let e=x(K),t=(e,t)=>JSON.stringify(e)!==JSON.stringify(t),a=(e,t)=>new Map(e.map(e=>[String(e[t]||""),e])),s=a(e.entities,"name"),l=a(e.relationships,"name"),r=a(e.reasoners,"id");return{entities:(te.entities||[]).map(e=>({name:e.name,status:s.has(e.name)?t(s.get(e.name),e)?"update":"same":"add"})),relationships:(te.relationships||[]).map(e=>({name:e.name,status:l.has(e.name)?t(l.get(e.name),e)?"update":"same":"add"})),reasoners:(te.reasoners||[]).map(e=>({name:e.id,status:r.has(e.id)?t(r.get(e.id),e)?"update":"same":"add"}))}},[te,K]),tw=(0,l.useMemo)(()=>{let e=new Set;return((null==K?void 0:K.relationships)||[]).forEach(t=>{e.add(t.from_entity),e.add(t.to_entity)}),e},[K]),t_=(0,l.useMemo)(()=>{if(!tn||!ee.some(e=>e.id===tn))return null;let e=new Map,t=new Map,a=(a,s)=>{e.has(a)||e.set(a,new Set),t.has(s)||t.set(s,new Set),e.get(a).add(s),t.get(s).add(a)};ea.forEach(e=>{a(e.from,e.to),"relation"===e.type&&a(e.to,e.from)});let s=(e,t)=>{let a=new Set,s=[e];for(a.add(e);s.length;){let e=s.pop(),l=t.get(e);l&&l.forEach(e=>{a.has(e)||(a.add(e),s.push(e))})}return a};return{nodes:new Set([...s(tn,e)||[],...s(tn,t)||[]])}},[ea,tn,ee]),tk=(0,l.useMemo)(()=>{let e;if(e6){let t=ee.filter(e=>"entity"===e.kind);e=0===tw.size?t:t.filter(e=>tw.has(e.id))}else e=ee.filter(e=>ec[e.kind]);return t_?e.filter(e=>t_.nodes.has(e.id)):e},[t_,tw,e6,ee,ec]),tC=(0,l.useMemo)(()=>new Set(tk.map(e=>e.id)),[tk]),tS=(0,l.useMemo)(()=>Object.values(ec).every(Boolean),[ec]),tM=(0,l.useMemo)(()=>tS?"all":Object.keys(ec).filter(e=>ec[e]).join(", "),[tS,ec]),tE=(0,l.useMemo)(()=>{if(!K)return[];let e=[],t=new Map(K.entities.map(e=>[e.name,e]));K.reasoners.map(e=>e.id),K.entities.forEach(t=>{let a=new Set(t.fields.map(e=>e.name));t.fields.forEach(s=>{let l=(s.dtype||"").toLowerCase();if(l&&"any"!==l&&"unknown"!==l||e.push({level:"warn",message:"Missing dtype for ".concat(t.name,".").concat(s.name)}),s.derived&&(s.depends_on||[]).forEach(l=>{a.has(l)||e.push({level:"error",message:"Missing dependency ".concat(l," for ").concat(t.name,".").concat(s.name)})}),"last"===s.default_agg){let l=s.order_by||[];l.length||e.push({level:"warn",message:"Missing order_by for ".concat(t.name,".").concat(s.name," (last agg)")}),l.forEach(l=>{l.field&&!a.has(l.field)&&e.push({level:"error",message:"Invalid order_by ".concat(l.field," for ").concat(t.name,".").concat(s.name)})})}})}),K.relationships.forEach(a=>{let s=t.get(a.from_entity),l=t.get(a.to_entity);if(!s||!l){e.push({level:"error",message:"Relationship ".concat(a.name," references missing entity")});return}if(!a.join_on||0===a.join_on.length){e.push({level:"error",message:"Relationship ".concat(a.name," is missing join_on pairs")});return}let r=new Set(s.fields.map(e=>e.name)),n=new Set(l.fields.map(e=>e.name));(a.join_on||[]).forEach(t=>{let[s,l]=t;r.has(s)&&n.has(l)||e.push({level:"error",message:"Invalid join ".concat(a.name,": ").concat(s,"=").concat(l)})})});let a=new Set(K.entities.map(e=>e.entity_type));return K.reasoners.forEach(t=>{K.entities.some(e=>(e.applicable_reasoners||[]).includes(t.id))||a.has(t.entity_type)||e.push({level:"warn",message:"Orphan reasoner ".concat(t.id)})}),K.entities.forEach(t=>{let a=K.relationships.some(e=>e.from_entity===t.name||e.to_entity===t.name),s=(t.applicable_reasoners||[]).length>0;a||s||e.push({level:"warn",message:"Unused entity ".concat(t.name)})}),e},[K]),tO=(0,l.useMemo)(()=>{if(!tm||"derived"!==tm.kind)return null;let e=ea.filter(e=>"dependency"===e.type),t=new Set,a=new Set,s=new Set,l=new Map,r=new Map;e.forEach(e=>{l.set(e.from,[...l.get(e.from)||[],e.to]),r.set(e.to,[...r.get(e.to)||[],e.from])});let n=(e,t,a)=>{let s=[e];for(;s.length;){let e=s.pop();(t.get(e)||[]).forEach(e=>{a.has(e)||(a.add(e),s.push(e))})}};return n(tm.id,l,a),n(tm.id,r,t),e.forEach(e=>{(e.from===tm.id||t.has(e.from)||a.has(e.from))&&(e.to===tm.id||t.has(e.to)||a.has(e.to))&&s.add(e.id)}),{nodes:new Set([tm.id,...t,...a]),edges:s}},[ea,tm]),tR=(0,l.useCallback)(e=>{let t=W.current;if(!t||0===e.length)return;let a=t.getBoundingClientRect(),s=Math.min(...e.map(e=>e.x)),l=Math.min(...e.map(e=>e.y)),r=Math.max(...e.map(e=>e.x+240)),n=Math.max(...e.map(e=>e.y+148)),i=Math.max(1,r-s),o=Math.max(1,n-l),d=b(Math.min((a.width-120)/i,(a.height-120)/o),.4,1.6),c=(a.width-i*d)/2-s*d,x=(a.height-o*d)/2-l*d;ek(d),eS({x:c,y:x})},[]),tD=function(e){let t=!(arguments.length>1)||void 0===arguments[1]||arguments[1],a=x(e),{nodes:s,edges:l}=p(a),r=u(s,t?new Map(ee.map(e=>[e.id,{x:e.x,y:e.y}])):new Map);if($(a),et(r),es(l),t||requestAnimationFrame(()=>tR(r)),!r.some(e=>e.id===el)){var n;er((null===(n=r[0])||void 0===n?void 0:n.id)||null)}},tA=(0,l.useCallback)(()=>{if(!eZ.trim()){eb("Paste registry JSON to import.");return}try{let e=JSON.parse(eZ);if(!e||"object"!=typeof e){eb("Registry JSON is invalid.");return}tD(e,!1),tt(null),eb("Registry imported from JSON.")}catch(e){eb("Registry JSON is invalid.")}},[eZ]),tL=async()=>{eg(!0),eb("Loading registry...");try{let e=await fetch("".concat(H,"/api/registry/load"));if(!e.ok){eb("Failed to load registry.");return}let t=await e.json();if(eN(t.path||""),t.registry){tD(t.registry,!1);let e=t.source||(t.exists?"file":"active");eb("Registry loaded (".concat(e,").")),tt(null),tc.current=JSON.stringify(t.registry)}else $(null),et([]),es([]),eb("No registry data available yet.");await tJ()}catch(e){eb("Registry load failed.")}finally{eg(!1)}},tJ=async()=>{try{let e=await fetch("".concat(H,"/api/registry/versions"));if(!e.ok)return;let t=await e.json();e8(t.versions||[])}catch(e){}},tI=async()=>{eg(!0),eb("Reloading API registry...");try{if(!(await fetch("".concat(H,"/api/registry/reload"),{method:"POST"})).ok){eb("Reload failed.");return}eb("API registry reloaded.")}catch(e){eb("Reload failed.")}finally{eg(!1)}},tT=async()=>{let e=em.split(/[\n,]+/).map(e=>e.trim()).filter(Boolean);if(!e.length){eb("Enter at least one Snowflake table.");return}eg(!0),eb("Drafting registry from Snowflake...");try{let l=await fetch("".concat(H,"/api/registry/draft"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({tables:e,instructions:eu})});if(!l.ok){eb("Draft failed.");return}let r=await l.json();if(r.registry){var t,a,s;(null==K?void 0:null===(t=K.entities)||void 0===t?void 0:t.length)||(null==K?void 0:null===(a=K.relationships)||void 0===a?void 0:a.length)||(null==K?void 0:null===(s=K.reasoners)||void 0===s?void 0:s.length)?(tt(r.registry),eb("Draft ready for merge.")):(tD(r.registry,!1),eb("Draft loaded into canvas."))}else eb("Draft returned empty registry.")}catch(e){eb("Draft failed.")}finally{eg(!1)}},tP=async function(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(!K){e||eb("Nothing to save yet.");return}e||(eg(!0),eb("Saving registry..."));try{let t=await fetch("".concat(H,"/api/registry/save"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({registry:K})});if(!t.ok){e||eb("Save failed.");return}let a=await t.json();eN(a.path||""),ew(a.yaml||""),tc.current=JSON.stringify(K),e||eb("Registry saved."),await tJ(),e||await tI()}catch(t){e||eb("Save failed.")}finally{e||eg(!1)}};(0,l.useEffect)(()=>{tL()},[H]),(0,l.useEffect)(()=>{if(!e5||!K)return;let e=JSON.stringify(K);if(e===tc.current)return;let t=window.setTimeout(async()=>{tc.current=e,await tP(!0),eb("Auto-saved.")},1500);return()=>window.clearTimeout(t)},[e5,K]),(0,l.useEffect)(()=>{if(!ee.length){er(null);return}el&&ee.find(e=>e.id===el)||er(ee[0].id)},[ee,el]),(0,l.useEffect)(()=>{if(!te)return;let e={};tj.entities.forEach(t=>{e[t.name]="same"!==t.status});let t={};tj.relationships.forEach(e=>{t[e.name]="same"!==e.status});let a={};tj.reasoners.forEach(e=>{a[e.name]="same"!==e.status}),td({entities:e,relationships:t,reasoners:a})},[tj,te]),(0,l.useEffect)(()=>{if(!K||!tm){eA(""),eJ(""),e$([]),eT(""),eq([]),eY(""),eU(""),eQ(""),eB("");return}if("derived"===tm.kind){let e=K.entities.find(e=>e.name===tm.ref.entityName),t=null==e?void 0:e.fields.find(e=>e.name===tm.ref.fieldName);eA((null==t?void 0:t.expr)||""),eJ(((null==t?void 0:t.depends_on)||[]).join(", "));let a=k(K,tm.ref.entityName||"",tm.ref.fieldName||"");eT(a?JSON.stringify(a,null,2):""),eq([]),eY(""),eU(""),eQ(""),eB(""),e$([]);return}if("reasoner"===tm.kind){let e=K.reasoners.find(e=>e.id===tm.ref.reasonerId);e$((null==e?void 0:e.signals)||[]),eA(""),eJ(""),eT(""),eq([]),eY(""),eU(""),eQ(""),eB("");return}eA(""),eJ(""),e$([]),eT(""),eq([]),eY(""),eU(""),eQ(""),eB("")},[K,tm]);let tB=(e,t)=>{let a=W.current;if(!a)return{x:0,y:0};let s=a.getBoundingClientRect();return{x:(e-s.left-eC.x)/e_,y:(t-s.top-eC.y)/e_}},tF=(e,t)=>{if(e.stopPropagation(),!W.current)return;let a=ee.find(e=>e.id===t);if(!a)return;let s=tB(e.clientX,e.clientY);ed({id:t,offsetX:s.x-a.x,offsetY:s.y-a.y})};(0,l.useEffect)(()=>{if(!eo||!W.current)return;let e=e=>{let t=tB(e.clientX,e.clientY),a=t.x-eo.offsetX,s=t.y-eo.offsetY;et(e=>e.map(e=>e.id===eo.id?{...e,x:Math.max(24,a),y:Math.max(24,s)}:e))},t=()=>ed(null);return window.addEventListener("pointermove",e),window.addEventListener("pointerup",t),()=>{window.removeEventListener("pointermove",e),window.removeEventListener("pointerup",t)}},[eo]),(0,l.useEffect)(()=>{if(!eM)return;let e=e=>{eS({x:eM.originX+(e.clientX-eM.startX),y:eM.originY+(e.clientY-eM.startY)})},t=()=>eE(null);return window.addEventListener("pointermove",e),window.addEventListener("pointerup",t),()=>{window.removeEventListener("pointermove",e),window.removeEventListener("pointerup",t)}},[eM]),(0,l.useEffect)(()=>{let e=()=>{eR(document.fullscreenElement===Z.current),requestAnimationFrame(()=>tR(ee))};return document.addEventListener("fullscreenchange",e),()=>{document.removeEventListener("fullscreenchange",e)}},[tR,ee]);let tY=(0,l.useMemo)(()=>{let e=new Map;ea.forEach(t=>{let a=e.get(t.from)||[];a.push(t),e.set(t.from,a)});let t=new Map;e.forEach(e=>{let a=(e.length-1)/2;e.forEach((e,s)=>{t.set(e.id,(s-a)*10)})});let a=e6?ea.filter(e=>"relation"===e.type):ea;return(e6||tS?a.filter(e=>tC.has(e.from)&&tC.has(e.to)):a.filter(e=>tC.has(e.from)&&tC.has(e.to))).map(e=>{let a=ee.find(t=>t.id===e.from),s=ee.find(t=>t.id===e.to);if(!a||!s)return null;let l=a.y+74,r=s.y+74,n=a.x+120,i=s.x+120-n,o=t.get(e.id)||0,d=0,c=0,x=0,m=0;if(144>Math.abs(i)){d=a.x+240+0,c=s.x+240+0;let e=Math.max(a.x,s.x)+240+140+o;x=e,m=e}else if(i>0){d=a.x+240+0,c=s.x-0;let e=Math.min(160,.4*Math.abs(i));x=d+e+o,m=c-e+o}else{d=a.x-0,c=s.x+240+0;let e=Math.min(160,.4*Math.abs(i));x=d-e+o,m=c+e+o}let p="M ".concat(d," ").concat(l," C ").concat(x," ").concat(l,", ").concat(m," ").concat(r,", ").concat(c," ").concat(r),u=(d+c)/2,f=(l+r)/2-12;return{...e,path:p,labelX:u,labelY:f}}).filter(Boolean)},[tS,ea,e6,ee,tC]),tz=e=>{ei(e)},tq=()=>ti(null),tX=e=>{let t=e.target;null!=t&&t.closest('[data-node="true"]')||tq()},tU=(e,t)=>{if((null==t?void 0:t.detail)===2||(null==t?void 0:t.shiftKey)){tG(e);return}if(en&&en!==e){let t=ee.find(e=>e.id===en),a=ee.find(t=>t.id===e);if((null==t?void 0:t.kind)==="entity"&&(null==a?void 0:a.kind)==="entity"&&K){let e=tu.entityMap.get(t.id),s=tu.entityMap.get(a.id),l=((null==e?void 0:e.join_keys)||[]).filter(e=>((null==s?void 0:s.join_keys)||[]).includes(e)),r="".concat(t.id,"_to_").concat(a.id);e2({from:t.id,to:a.id,name:r,description:"User defined relationship",joinText:y(l.map(e=>[e,e])),mode:"create"})}else es(t=>[...t,{id:"edge-".concat(Date.now()),from:en,to:e,label:"custom_link",type:"relation"}]);ei(null)}er(e)},tG=e=>{ti(t=>t===e?null:e)},tQ=e=>{tm&&et(t=>t.map(t=>t.id===tm.id?{...t,...e}:t))},tV=(e,t)=>{if(tQ({description:t}),K){if("entity"===e.kind&&e.ref.entityName){$({...K,entities:K.entities.map(a=>a.name===e.ref.entityName?{...a,description:t}:a)});return}if("derived"===e.kind&&e.ref.entityName&&e.ref.fieldName){$({...K,entities:K.entities.map(a=>a.name!==e.ref.entityName?a:{...a,fields:a.fields.map(a=>a.name===e.ref.fieldName?{...a,description:t}:a)})});return}"reasoner"===e.kind&&e.ref.reasonerId&&$({...K,reasoners:K.reasoners.map(a=>a.id===e.ref.reasonerId?{...a,description:t}:a)})}},tW=(e,t)=>{if(!K||!e.ref.entityName)return;let a=t.trim();if(!a)return;let s=e.ref.entityName;if(a===s){tQ({label:a});return}let l=new Map;l.set(s,a);let r=ee.map(e=>{if(e.ref.entityName!==s)return e;let t={...e.ref,entityName:a};if("entity"===e.kind)return{...e,id:a,label:a,ref:t};if("derived"===e.kind&&e.ref.fieldName){let s=d(a,e.ref.fieldName);return l.set(e.id,s),{...e,id:s,ref:t}}return{...e,ref:t}}),n=ea.map(e=>({...e,from:l.get(e.from)||e.from,to:l.get(e.to)||e.to}));$({...K,entities:K.entities.map(e=>e.name===s?{...e,name:a}:e),relationships:K.relationships.map(e=>({...e,from_entity:e.from_entity===s?a:e.from_entity,to_entity:e.to_entity===s?a:e.to_entity}))}),et(r),es(n),er(a)},tZ=(e,t)=>{if(!K||!e.ref.entityName||!e.ref.fieldName)return;let a=t.trim();if(!a)return;let s=e.ref.fieldName;if(a===s){tQ({label:a});return}let l=ee.map(t=>t.id!==e.id?t:{...t,id:d(e.ref.entityName,a),label:a,ref:{...t.ref,fieldName:a}}),r=ea.map(t=>t.from!==e.id&&t.to!==e.id?t:{...t,from:t.from===e.id?d(e.ref.entityName,a):t.from,to:t.to===e.id?d(e.ref.entityName,a):t.to});$({...K,entities:K.entities.map(t=>t.name!==e.ref.entityName?t:{...t,default_metric:t.default_metric===s?a:t.default_metric,fields:t.fields.map(e=>{let t=(e.depends_on||[]).map(e=>e===s?a:e);if(e.name!==s)return t===e.depends_on?e:{...e,depends_on:t};let l={...e,name:a,depends_on:t};return e.expr===s&&(l.expr=a),l})})}),et(l),es(r),er(d(e.ref.entityName,a))},tH=(e,t)=>{if(!K||!e.ref.reasonerId)return;let a=t.trim();a&&(tQ({label:a}),$({...K,reasoners:K.reasoners.map(t=>t.id===e.ref.reasonerId?{...t,name:a}:t)}))},tK=e=>{if(tm){if("entity"===tm.kind){tW(tm,e);return}if("derived"===tm.kind){tZ(tm,e);return}tH(tm,e)}},t$=e=>{if(!K){eb("Load or draft a registry first.");return}if("entity"===e){let e=h("NewEntity",new Set(K.entities.map(e=>e.name)));tD({...K,entities:[...K.entities,{name:e,description:"Describe this entity.",database:"",schema:"",table:"",fields:[],join_keys:[],default_metric:"",entity_type:"generic",applicable_reasoners:[],applicable_derived_metrics:[]}]},!0),er(e);return}if("derived"===e){var t;let e=(null==tm?void 0:tm.ref.entityName)||(null===(t=K.entities[0])||void 0===t?void 0:t.name);if(!e)return;let a=K.entities.find(t=>t.name===e);if(!a)return;let s=h("derived_metric",new Set(a.fields.map(e=>e.name)));tD({...K,entities:K.entities.map(t=>t.name!==e?t:{...t,fields:[...t.fields,{name:s,dtype:"number",role:"metric",expr:"",description:"Describe the derived metric.",derived:!0,default_agg:"avg",depends_on:[]}]})},!0),er(d(e,s));return}let a=h("reasoner",new Set(K.reasoners.map(e=>e.id)));tD({...K,reasoners:[...K.reasoners,{id:a,name:"New Reasoner",description:"Describe this reasoner.",entity_type:"generic",type:"signal_based",signals:[],outputs:[]}]},!0),er(c(a))},t0=async()=>{let e=Z.current;if(e)try{document.fullscreenElement===e?await document.exitFullscreen():await e.requestFullscreen()}catch(e){eb("Fullscreen request failed.")}},t2=()=>{if(K&&tm){if("derived"===tm.kind){if(!tm.ref.entityName||!tm.ref.fieldName)return;let e=K.entities.find(e=>e.name===tm.ref.entityName),t=null==e?void 0:e.fields.find(e=>e.name===tm.ref.fieldName),a=((null==e?void 0:e.fields)||[]).map(e=>e.name),s=E(tm.ref.entityName,tm.ref.fieldName,eD||""),l=_(O(s,a,tm.ref.fieldName),null==t?void 0:t.order_by);$({...K,derived_rel_rules:C(K,s),entities:K.entities.map(e=>e.name!==tm.ref.entityName?e:{...e,fields:e.fields.map(e=>e.name===tm.ref.fieldName?{...e,expr:eD,depends_on:l}:e)})}),eJ(l.join(", ")),eT(JSON.stringify(s,null,2)),eU(""),eQ(""),eb("Derived rule updated.");return}if("reasoner"===tm.kind){if(!tm.ref.reasonerId)return;let e=eK.filter(e=>e.name&&e.metric_field);$({...K,reasoners:K.reasoners.map(t=>t.id===tm.ref.reasonerId?{...t,signals:e}:t)}),eb("Reasoner signals updated.")}}},t1=async()=>{if(K&&(null==tm?void 0:tm.ref.entityName)&&(null==tm?void 0:tm.ref.fieldName)&&"derived"===tm.kind){if(!eP.trim()){eb("Enter a natural-language rule description.");return}eg(!0),eY("Generating rule with LLM...");try{let e=await fetch("".concat(H,"/api/registry/rules/generate"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({entity:tm.ref.entityName,field:tm.ref.fieldName,instruction:eP,registry:K})});if(!e.ok){eY("Rule generation failed.");return}let t=await e.json();t.rule?(eT(JSON.stringify(t.rule,null,2)),eY("Rule generated. Review and apply."),eU(""),eQ("")):eY("No rule generated.")}catch(e){eY("Rule generation failed.")}finally{eg(!1)}}},t3=async()=>{if(!eI.trim()){eq(["Rule JSON is empty."]);return}let e=null;try{e=JSON.parse(eI||"")}catch(e){eq(["Rule JSON is invalid."]);return}eg(!0),eY("Validating rule...");try{let t=await fetch("".concat(H,"/api/registry/rules/validate"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({rule:e,registry:K})});if(!t.ok){eY("Validation failed.");return}let a=await t.json(),s=Array.isArray(a.issues)?a.issues:[];eq(s),eY(a.valid?"Rule is valid.":"Rule has issues.")}catch(e){eY("Validation failed.")}finally{eg(!1)}},t6=async()=>{if(!K)return;if(!eI.trim()){eQ("Rule JSON is empty.");return}let e=null;try{e=JSON.parse(eI||"")}catch(e){eQ("Rule JSON is invalid.");return}eg(!0),eQ("Generating Snowflake SQL...");try{let t=await fetch("".concat(H,"/api/registry/rules/sql"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({rule:e,registry:K})});if(!t.ok){eQ("SQL generation failed.");return}let a=await t.json();eU(a.sql||""),eQ(a.sql?"SQL generated.":"SQL generation failed.")}catch(e){eQ("SQL generation failed.")}finally{eg(!1)}},t4=e=>{K&&(null==tm?void 0:tm.ref.entityName)&&tD({...K,entities:K.entities.map(t=>t.name===tm.ref.entityName?{...t,...e}:t)},!0)},t5=e=>{K&&(null==tm?void 0:tm.ref.entityName)&&(null==tm?void 0:tm.ref.fieldName)&&tD({...K,entities:K.entities.map(t=>t.name!==tm.ref.entityName?t:{...t,fields:t.fields.map(t=>t.name===tm.ref.fieldName?{...t,...e}:t)})},!0)},t9=e=>{K&&(null==tm?void 0:tm.ref.reasonerId)&&tD({...K,reasoners:K.reasoners.map(t=>t.id===tm.ref.reasonerId?{...t,...e}:t)},!0)},t7=(e,t,a)=>{if(!K)return;let s=(a.name||t).trim(),l=a.name&&s&&s!==t;tD({...K,entities:K.entities.map(r=>{if(r.name!==e)return r;let n=r.fields.map(e=>{if(e.name===t)return{...e,...a,name:s||e.name};if(l){let a=(e.depends_on||[]).map(e=>e===t?s:e);return a===e.depends_on?e:{...e,depends_on:a}}return e}),i=l?(r.join_keys||[]).map(e=>e===t?s:e):r.join_keys,o=l&&r.default_metric===t?s:r.default_metric,d=l?(r.applicable_derived_metrics||[]).map(e=>e===t?s:e):r.applicable_derived_metrics;return{...r,fields:n,join_keys:i,default_metric:o,applicable_derived_metrics:d}}),derived_rel_rules:l?(K.derived_rel_rules||[]).map(a=>a.entity===e&&a.field===t?{...a,field:s}:a):K.derived_rel_rules,relationships:l?K.relationships.map(a=>{if(a.from_entity!==e&&a.to_entity!==e)return a;let l=(a.join_on||[]).map(l=>{let[r,n]=l;return[a.from_entity===e&&r===t?s:r,a.to_entity===e&&n===t?s:n]});return{...a,join_on:l}}):K.relationships},!0)},t8=(e,t,a)=>{if(!K)return;let s=K.entities.find(t=>t.name===e),l=null==s?void 0:s.fields.find(e=>e.name===t);if(!s||!l)return;let r=l.depends_on;if(l.derived){let e=s.fields.map(e=>e.name);r=_(N(l.expr||"",e,l.name),a)}t7(e,t,{order_by:a,depends_on:r}),(null==tm?void 0:tm.kind)==="derived"&&tm.ref.entityName===e&&tm.ref.fieldName===t&&l.derived&&eJ((r||[]).join(", "))},ae=e=>{if(!K)return;let t=K.entities.find(t=>t.name===e);if(!t)return;let a=h("new_column",new Set(t.fields.map(e=>e.name)));tD({...K,entities:K.entities.map(t=>t.name!==e?t:{...t,fields:[...t.fields,{name:a,dtype:"",role:"dimension",expr:"",description:"",derived:!1,default_agg:"",depends_on:[]}]})},!0)},at=(e,t)=>{K&&window.confirm('Delete field "'.concat(t,'"?'))&&tD({...K,entities:K.entities.map(a=>a.name!==e?a:{...a,fields:a.fields.filter(e=>e.name!==t),join_keys:(a.join_keys||[]).filter(e=>e!==t),default_metric:a.default_metric===t?"":a.default_metric,applicable_derived_metrics:(a.applicable_derived_metrics||[]).filter(e=>e!==t)})},!0)},aa=(e,t)=>{if(!K)return;let a=K.entities.find(t=>t.name===e);if(!a)return;let s=a.fields||[],l=new Map(s.map(e=>[e.name,e])),r=["posyear","posmon","meet_year","meet_mon","month_date","positiondate","month_date"].filter(e=>l.has(e)),n=["rmid","mandateid","meeting_id","meetingid"].filter(e=>l.has(e)),i=n.length?n:(a.join_keys||[]).filter(e=>!r.includes(e));if(!r.length){eb("No time keys found (posyear/posmon/meet_year/meet_mon/month_date).");return}let o=s.filter(e=>"metric"===e.role&&!e.derived&&!e.name.startsWith("prev_")),d=new Set(t),c=o.filter(e=>d.has(e.name));if(!c.length){eb("Select one or more metrics for prev_ fields.");return}let x=[];for(let e of c){let t="prev_".concat(e.name);if(l.has(t))continue;let a=e.expr||e.name.toUpperCase(),s=i.map(e=>{var t;return(null===(t=l.get(e))||void 0===t?void 0:t.expr)||e.toUpperCase()}).filter(Boolean),n=r.map(e=>{var t;return(null===(t=l.get(e))||void 0===t?void 0:t.expr)||e.toUpperCase()}).filter(Boolean),o=[s.length?"PARTITION BY ".concat(s.join(", ")):"",n.length?"ORDER BY ".concat(n.join(", ")):""].filter(Boolean).join(" ");x.push({name:t,dtype:e.dtype,role:"metric",expr:"LAG(".concat(a,") OVER (").concat(o,")"),description:"Previous ".concat(e.name," by ").concat(i.join(", ")||"entity"," over time."),derived:!0,default_agg:"avg",depends_on:[e.name,...i,...r]})}if(!x.length){eb("No new prev_ fields to add.");return}tD({...K,entities:K.entities.map(t=>t.name===e?{...t,fields:[...t.fields,...x]}:t)},!0),eb("Added ".concat(x.length," prev_ fields."))},as=async e=>{if(!K)return;let t=K.entities.find(t=>t.name===e);if(!t)return;let a=A(t);if(!a){eb("Set database/schema/table before importing.");return}eg(!0),eb("Importing fields from ".concat(a,"..."));try{let s=await fetch("".concat(H,"/api/registry/describe"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({table:a})});if(!s.ok){eb("Describe failed.");return}let l=((await s.json()).columns||[]).map(e=>{let t=String(e.name||"").toLowerCase(),a=String(e.type||""),s=R(a);return{name:t,dtype:a,role:s,expr:t,description:String(e.comment||""),derived:!1,default_agg:"metric"===s?D(t,a):"",depends_on:[]}}),r=(t.fields||[]).filter(e=>e.derived),n=l.map(e=>e.name).filter(e=>e.endsWith("id")||["rmid","mandateid","meeting_id"].includes(e)),i=Array.from(new Set([...t.join_keys||[],...n])),o=l.filter(e=>"metric"===e.role),d=o.length?o[0].name:t.default_metric,c={...K,entities:K.entities.map(t=>t.name===e?{...t,fields:[...l,...r],join_keys:i,default_metric:d||""}:t)};tD(c,!0),eb("Imported ".concat(l.length," fields."))}catch(e){eb("Describe failed.")}finally{eg(!1)}},al=(e,t)=>{e$(a=>a.map((a,s)=>s===e?{...a,...t}:a))},ar=()=>{if(!(null==tm?void 0:tm.ref.reasonerId))return;let e=tu.reasonerMap.get(tm.ref.reasonerId);t9({outputs:[...(null==e?void 0:e.outputs)||[],""]})},an=(e,t)=>{if(!(null==tm?void 0:tm.ref.reasonerId))return;let a=tu.reasonerMap.get(tm.ref.reasonerId),s=[...(null==a?void 0:a.outputs)||[]];s[e]=t.trim(),t9({outputs:s})},ai=e=>{if(!(null==tm?void 0:tm.ref.reasonerId))return;let t=tu.reasonerMap.get(tm.ref.reasonerId);t9({outputs:((null==t?void 0:t.outputs)||[]).filter((t,a)=>a!=e)})},ao=(e,t)=>{tr(a=>{let s=new Set(a[e]||[]);return s.has(t)?s.delete(t):s.add(t),{...a,[e]:Array.from(s)}})},ad=(e,t)=>{tr(a=>({...a,[e]:t}))},ac=()=>{e$(e=>[...e,{name:"",description:"",metric_field:"",threshold:0,direction:"below"}])},ax=e=>{e$(t=>t.filter((t,a)=>a!==e))},am=e=>{e2({from:e.from_entity,to:e.to_entity,name:e.name,description:e.description||"",joinText:y(e.join_on||[]),mode:"edit",originalName:e.name})},ap=e=>{K&&window.confirm('Delete relationship "'.concat(e,'"?'))&&tD({...K,relationships:K.relationships.filter(t=>t.name!==e)},!0)},au=e=>{let t=(e.fields||[]).map(e=>e.name);return(e.fields||[]).map(e=>{if(!e.derived)return e;let a=_(N(e.expr||"",t,e.name),e.order_by);return{...e,depends_on:a}})},af=async e=>{eg(!0),eb("Rolling back to ".concat(e,"..."));try{if(!(await fetch("".concat(H,"/api/registry/rollback"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({version:e})})).ok){eb("Rollback failed.");return}await tL(),eb("Rollback complete.")}catch(e){eb("Rollback failed.")}finally{eg(!1)}},ah=async()=>{eg(!0),eb("Exporting ontology...");try{let e=await fetch("".concat(H,"/api/registry/ontology/export"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({registry:K,format:"json",write_file:!0})});if(!e.ok){eb("Export failed.");return}let t=await e.json();eb("Ontology exported".concat(t.path?": ".concat(t.path):"","."))}catch(e){eb("Export failed.")}finally{eg(!1)}},ab=()=>{if(!K||!tm)return;let e=tm.label||tm.id;if(window.confirm("Delete ".concat(tm.kind,' "').concat(e,'"?'))){if("entity"===tm.kind&&tm.ref.entityName){tD({...K,entities:K.entities.filter(e=>e.name!==tm.ref.entityName),relationships:K.relationships.filter(e=>e.from_entity!==tm.ref.entityName&&e.to_entity!==tm.ref.entityName)},!0),er(null);return}if("derived"===tm.kind&&tm.ref.entityName&&tm.ref.fieldName){tD({...K,entities:K.entities.map(e=>e.name!==tm.ref.entityName?e:{...e,fields:e.fields.filter(e=>e.name!==tm.ref.fieldName)})},!0),er(null);return}"reasoner"===tm.kind&&tm.ref.reasonerId&&(tD({...K,reasoners:K.reasoners.filter(e=>e.id!==tm.ref.reasonerId),entities:K.entities.map(e=>({...e,applicable_reasoners:(e.applicable_reasoners||[]).filter(e=>e!==tm.ref.reasonerId)}))},!0),er(null))}},ay=(null==tm?void 0:tm.kind)==="entity"?tu.entityMap.get(tm.ref.entityName||""):null,ag=ay?(ay.fields||[]).filter(e=>"metric"===e.role&&!e.derived&&!e.name.startsWith("prev_")):[],av=ay&&tl[ay.name]||[],aN=(null==tm?void 0:tm.kind)==="reasoner"?tu.reasonerMap.get(tm.ref.reasonerId||""):null,aj=(0,l.useMemo)(()=>{if(!K||!aN)return null;let e=K.entities.filter(e=>e.entity_type===aN.entity_type),t=new Map;return e.forEach(e=>{(e.fields||[]).forEach(a=>{t.has(a.name)||t.set(a.name,{field:a,entity:e})})}),{entityNames:e.map(e=>e.name),fieldMap:t,options:Array.from(t.keys()).sort()}},[K,aN]);return(0,s.jsxs)("div",{className:"min-h-screen bg-gradient-to-br from-slate-50 via-white to-blue-50",children:[(0,s.jsx)("datalist",{id:"dtype-presets",children:j.map(e=>(0,s.jsx)("option",{value:e.value},e.value))}),(0,s.jsx)("div",{className:"border-b border-slate-200/70 bg-white/60 backdrop-blur",children:(0,s.jsxs)("div",{className:"mx-auto flex max-w-7xl items-center justify-between px-6 py-6",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("p",{className:"text-xs font-semibold uppercase tracking-[0.3em] text-slate-400",children:"Registry Studio"}),(0,s.jsx)("h1",{className:"mt-2 text-2xl font-semibold text-slate-900",children:"Visual Semantic Builder"}),(0,s.jsx)("p",{className:"mt-1 text-sm text-slate-500",children:"Draft from Snowflake, refine visually, and export a registry for any client."})]}),(0,s.jsxs)("div",{className:"flex items-center gap-3",children:[(0,s.jsx)("button",{onClick:()=>tP(),disabled:ey,className:"rounded-full border border-slate-200 bg-white px-4 py-2 text-xs font-semibold text-slate-700 shadow-sm",type:"button",children:"Save registry"}),(0,s.jsx)("button",{onClick:tT,disabled:ey,className:"rounded-full bg-slate-900 px-5 py-2 text-xs font-semibold text-white shadow-lg transition hover:-translate-y-0.5",type:"button",children:"Draft from Snowflake"})]})]})}),(0,s.jsxs)("main",{className:"mx-auto flex w-full max-w-7xl flex-col gap-6 px-6 py-8 lg:flex-row",children:[(0,s.jsxs)(r.E.aside,{initial:{opacity:0,x:-20},animate:{opacity:1,x:0},className:"flex w-full flex-col gap-5 rounded-3xl border border-white/60 bg-white/70 p-5 shadow-xl lg:w-80",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("h2",{className:"text-sm font-semibold uppercase tracking-[0.25em] text-slate-400",children:"Snowflake Source"}),(0,s.jsx)("p",{className:"mt-2 text-xs text-slate-500",children:"Paste fully qualified tables (db.schema.table). Drafting will call DESCRIBE and Cortex."}),(0,s.jsx)("textarea",{value:em,onChange:e=>ep(e.target.value),placeholder:"TFO_TEST.ML_TEST.RAI_MANDATE_MONTHLY_SUMMARY_MODEL",className:"mt-3 h-24 w-full rounded-2xl border border-slate-200 bg-white px-3 py-2 text-xs text-slate-600"}),(0,s.jsx)("label",{className:"mt-4 block text-xs font-semibold uppercase tracking-[0.2em] text-slate-400",children:"Draft Notes"}),(0,s.jsx)("textarea",{value:eu,onChange:e=>ef(e.target.value),placeholder:"Focus on mandate risk + RM performance relationships.",className:"mt-2 h-20 w-full rounded-2xl border border-slate-200 bg-white px-3 py-2 text-xs text-slate-600"}),(0,s.jsxs)("div",{className:"mt-4 flex flex-wrap gap-2",children:[(0,s.jsx)("button",{onClick:tT,disabled:ey,className:"rounded-full bg-slate-900 px-4 py-2 text-xs font-semibold text-white shadow",type:"button",children:"Draft registry"}),(0,s.jsx)("button",{onClick:tL,disabled:ey,className:"rounded-full border border-slate-200 bg-white px-4 py-2 text-xs font-semibold text-slate-600",type:"button",children:"Reload"})]})]}),(0,s.jsxs)("div",{className:"rounded-2xl border border-white/60 bg-white/90 p-4 shadow-sm",children:[(0,s.jsx)("p",{className:"text-xs font-semibold uppercase tracking-[0.2em] text-slate-400",children:"Registry"}),(0,s.jsx)("p",{className:"mt-2 text-xs text-slate-500",children:ev?"Path: ".concat(ev):"Registry path not set yet."}),(0,s.jsxs)("p",{className:"mt-3 text-xs text-slate-500",children:[(null==K?void 0:null===(e=K.entities)||void 0===e?void 0:e.length)||0," entities - ",(null==K?void 0:null===(t=K.relationships)||void 0===t?void 0:t.length)||0," relationships -"," ",(null==K?void 0:null===(a=K.reasoners)||void 0===a?void 0:a.length)||0," reasoners"]}),(0,s.jsx)("button",{onClick:()=>tP(),disabled:ey,className:"mt-3 w-full rounded-2xl bg-slate-900 px-3 py-2 text-xs font-semibold text-white shadow",type:"button",children:"Save registry"}),(0,s.jsx)("button",{onClick:()=>{K&&(tD({...K,entities:K.entities.map(e=>({...e,fields:au(e)}))},!0),eb("Dependencies computed for all derived fields."))},disabled:ey,className:"mt-2 w-full rounded-2xl border border-slate-200 bg-white px-3 py-2 text-xs font-semibold text-slate-600",type:"button",children:"Compute deps (all derived)"}),(0,s.jsx)("button",{onClick:ah,disabled:ey,className:"mt-2 w-full rounded-2xl border border-slate-200 bg-white px-3 py-2 text-xs font-semibold text-slate-600",type:"button",children:"Export ontology triples"}),(0,s.jsxs)("div",{className:"mt-3 flex items-center justify-between rounded-2xl border border-slate-200 bg-white px-3 py-2",children:[(0,s.jsx)("span",{className:"text-xs font-semibold text-slate-600",children:"Auto-save"}),(0,s.jsx)("button",{type:"button",onClick:()=>e9(e=>!e),className:"rounded-full px-3 py-1 text-[11px] font-semibold ".concat(e5?"bg-slate-900 text-white":"bg-slate-100 text-slate-500"),children:e5?"On":"Off"})]}),(0,s.jsxs)("div",{className:"mt-3 grid grid-cols-2 gap-2",children:[(0,s.jsx)("button",{onClick:tI,disabled:ey,className:"rounded-2xl border border-slate-200 bg-white px-3 py-2 text-xs font-semibold text-slate-600",type:"button",children:"Reload API"}),(0,s.jsx)("button",{onClick:()=>{$({entities:[],relationships:[],reasoners:[],derived_rel_rules:[],prompt_templates:{},analysis_config:{},config:{}}),et([]),es([]),er(null),ew(""),tt(null),eb("Started fresh registry.")},disabled:ey,className:"rounded-2xl border border-slate-200 bg-white px-3 py-2 text-xs font-semibold text-slate-600",type:"button",children:"Start fresh"})]})]}),(0,s.jsxs)("div",{className:"rounded-2xl border border-white/60 bg-white/90 p-4 shadow-sm",children:[(0,s.jsxs)("div",{className:"flex items-center justify-between",children:[(0,s.jsx)("p",{className:"text-xs font-semibold uppercase tracking-[0.2em] text-slate-400",children:"Import JSON"}),(0,s.jsx)("button",{type:"button",onClick:()=>eH(""),className:"rounded-full border border-slate-200 bg-white px-3 py-1 text-[11px] font-semibold text-slate-600",children:"Clear"})]}),(0,s.jsx)("p",{className:"mt-2 text-xs text-slate-500",children:"Paste a full registry JSON to replace the current draft."}),(0,s.jsx)("textarea",{value:eZ,onChange:e=>eH(e.target.value),placeholder:'{"entities":[...],"relationships":[...],"reasoners":[...]}',className:"mt-2 h-32 w-full rounded-2xl border border-slate-200 bg-white px-3 py-2 text-xs text-slate-600"}),(0,s.jsx)("button",{type:"button",onClick:tA,className:"mt-2 w-full rounded-2xl bg-slate-900 px-3 py-2 text-xs font-semibold text-white shadow",children:"Import registry JSON"})]}),(0,s.jsxs)("div",{className:"rounded-2xl border border-white/60 bg-white/90 p-4 shadow-sm",children:[(0,s.jsxs)("div",{className:"flex items-center justify-between",children:[(0,s.jsx)("p",{className:"text-xs font-semibold uppercase tracking-[0.2em] text-slate-400",children:"Prompt Customization"}),(0,s.jsx)("button",{type:"button",onClick:()=>eW(e=>!e),className:"rounded-full border border-slate-200 bg-white px-3 py-1 text-[11px] font-semibold text-slate-600",children:eV?"Hide previews":"Preview prompts"})]}),(0,s.jsx)("p",{className:"mt-2 text-xs text-slate-500",children:"Provide business, data, and expectations so the LLM can generate customized prompts from the defaults. Full prompt templates are not directly editable."}),(0,s.jsxs)("div",{className:"mt-3 space-y-3",children:[(0,s.jsxs)("div",{className:"rounded-2xl border border-slate-200 bg-white px-3 py-2",children:[(0,s.jsx)("p",{className:"text-xs font-semibold text-slate-700",children:"Business context"}),(0,s.jsx)("textarea",{value:tb.business,onChange:e=>ty("business",e.target.value),placeholder:"e.g., Wealth management, mandate profitability, RM performance",className:"mt-2 h-20 w-full rounded-2xl border border-slate-200 bg-white px-3 py-2 text-xs text-slate-600"})]}),(0,s.jsxs)("div",{className:"rounded-2xl border border-slate-200 bg-white px-3 py-2",children:[(0,s.jsx)("p",{className:"text-xs font-semibold text-slate-700",children:"Data context"}),(0,s.jsx)("textarea",{value:tb.data,onChange:e=>ty("data",e.target.value),placeholder:"e.g., Monthly mandate snapshots, meeting sentiment, revenue/cost metrics",className:"mt-2 h-20 w-full rounded-2xl border border-slate-200 bg-white px-3 py-2 text-xs text-slate-600"})]}),(0,s.jsxs)("div",{className:"rounded-2xl border border-slate-200 bg-white px-3 py-2",children:[(0,s.jsx)("p",{className:"text-xs font-semibold text-slate-700",children:"Expectations"}),(0,s.jsx)("textarea",{value:tb.expectations,onChange:e=>ty("expectations",e.target.value),placeholder:"e.g., Focus on executive summaries, highlight risk, avoid speculation",className:"mt-2 h-20 w-full rounded-2xl border border-slate-200 bg-white px-3 py-2 text-xs text-slate-600"})]}),(0,s.jsxs)("div",{className:"flex flex-wrap items-center gap-2",children:[(0,s.jsx)("button",{type:"button",onClick:tN,disabled:ey,className:"rounded-2xl bg-slate-900 px-3 py-2 text-xs font-semibold text-white shadow",children:"Generate prompts"}),(0,s.jsx)("button",{type:"button",onClick:tv,disabled:ey,className:"rounded-2xl border border-slate-200 bg-white px-3 py-2 text-xs font-semibold text-slate-600",children:"Reset to defaults"})]})]}),eV&&(0,s.jsx)("div",{className:"mt-3 space-y-3",children:th.map(e=>{let t=Object.prototype.hasOwnProperty.call(tf,e);return(0,s.jsxs)("div",{className:"rounded-2xl border border-slate-200 bg-white px-3 py-2",children:[(0,s.jsxs)("div",{className:"flex items-center justify-between",children:[(0,s.jsx)("p",{className:"text-xs font-semibold text-slate-700",children:e}),(0,s.jsxs)("div",{className:"flex items-center gap-2",children:[(0,s.jsx)("span",{className:"rounded-full px-2 py-1 text-[10px] font-semibold ".concat(t?"bg-emerald-50 text-emerald-700":"bg-slate-100 text-slate-500"),children:t?"Custom":"Default"}),t&&(0,s.jsx)("button",{type:"button",onClick:()=>tg(e),className:"rounded-full border border-rose-200 bg-rose-50 px-2 py-1 text-[11px] text-rose-600",children:"Clear"})]})]}),t?(0,s.jsx)("textarea",{value:tf[e]||"",readOnly:!0,className:"mt-2 h-28 w-full rounded-2xl border border-slate-200 bg-slate-50 px-3 py-2 text-xs text-slate-600"}):(0,s.jsx)("p",{className:"mt-2 text-[11px] text-slate-500",children:"Using default prompt (not shown here)."})]},e)})})]}),(0,s.jsxs)("div",{className:"rounded-2xl border border-white/60 bg-white/90 p-4 shadow-sm",children:[(0,s.jsxs)("div",{className:"flex items-center justify-between",children:[(0,s.jsx)("p",{className:"text-xs font-semibold uppercase tracking-[0.2em] text-slate-400",children:"Relationships"}),(0,s.jsx)("button",{onClick:()=>{if(!K)return;if(K.entities.length<2){eb("Add at least two entities before creating relationships.");return}let[e,t]=K.entities.map(e=>e.name);e2({from:e,to:t,name:"".concat(e,"_to_").concat(t),description:"",joinText:"",mode:"create"})},className:"rounded-full border border-slate-200 bg-white px-3 py-1 text-[11px] font-semibold text-slate-600",type:"button",children:"+ Add"})]}),(0,s.jsxs)("div",{className:"mt-3 max-h-40 space-y-2 overflow-auto pr-1",children:[((null==K?void 0:K.relationships)||[]).map(e=>(0,s.jsxs)("div",{className:"rounded-2xl border border-slate-200 bg-white px-3 py-2",children:[(0,s.jsx)("p",{className:"text-xs font-semibold text-slate-700",children:e.name}),(0,s.jsxs)("p",{className:"text-[11px] text-slate-500",children:[e.from_entity,"  ",e.to_entity]}),(0,s.jsxs)("div",{className:"mt-2 flex gap-2",children:[(0,s.jsx)("button",{type:"button",onClick:()=>am(e),className:"rounded-full border border-slate-200 bg-white px-2 py-1 text-[11px] text-slate-600",children:"Edit"}),(0,s.jsx)("button",{type:"button",onClick:()=>ap(e.name),className:"rounded-full border border-rose-200 bg-rose-50 px-2 py-1 text-[11px] text-rose-600",children:"Delete"})]})]},e.name)),!(null==K?void 0:null===(m=K.relationships)||void 0===m?void 0:m.length)&&(0,s.jsx)("p",{className:"text-xs text-slate-500",children:"No relationships yet."})]})]}),te&&(0,s.jsxs)("div",{className:"rounded-2xl border border-white/60 bg-white/90 p-4 shadow-sm",children:[(0,s.jsx)("p",{className:"text-xs font-semibold uppercase tracking-[0.2em] text-slate-400",children:"Draft Diff"}),(0,s.jsx)("p",{className:"mt-2 text-xs text-slate-500",children:"Select what to merge from the draft."}),(0,s.jsxs)("div",{className:"mt-3 space-y-3",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("p",{className:"text-xs font-semibold text-slate-600",children:"Entities"}),(0,s.jsx)("div",{className:"mt-2 space-y-1",children:tj.entities.map(e=>(0,s.jsxs)("label",{className:"flex items-center gap-2 text-xs text-slate-600",children:[(0,s.jsx)("input",{type:"checkbox",checked:to.entities[e.name]||!1,onChange:t=>td(a=>({...a,entities:{...a.entities,[e.name]:t.target.checked}}))}),e.name," (",e.status,")"]},e.name))})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("p",{className:"text-xs font-semibold text-slate-600",children:"Relationships"}),(0,s.jsx)("div",{className:"mt-2 space-y-1",children:tj.relationships.map(e=>(0,s.jsxs)("label",{className:"flex items-center gap-2 text-xs text-slate-600",children:[(0,s.jsx)("input",{type:"checkbox",checked:to.relationships[e.name]||!1,onChange:t=>td(a=>({...a,relationships:{...a.relationships,[e.name]:t.target.checked}}))}),e.name," (",e.status,")"]},e.name))})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("p",{className:"text-xs font-semibold text-slate-600",children:"Reasoners"}),(0,s.jsx)("div",{className:"mt-2 space-y-1",children:tj.reasoners.map(e=>(0,s.jsxs)("label",{className:"flex items-center gap-2 text-xs text-slate-600",children:[(0,s.jsx)("input",{type:"checkbox",checked:to.reasoners[e.name]||!1,onChange:t=>td(a=>({...a,reasoners:{...a.reasoners,[e.name]:t.target.checked}}))}),e.name," (",e.status,")"]},e.name))})]}),(0,s.jsxs)("div",{className:"mt-2 flex items-center gap-2",children:[(0,s.jsx)("label",{className:"text-xs text-slate-600",children:"Merge mode"}),(0,s.jsxs)("select",{value:ta,onChange:e=>ts(e.target.value),className:"rounded-xl border border-slate-200 px-2 py-1 text-xs text-slate-600",children:[(0,s.jsx)("option",{value:"add",children:"add only"}),(0,s.jsx)("option",{value:"replace",children:"replace existing"})]})]}),(0,s.jsxs)("div",{className:"flex gap-2",children:[(0,s.jsx)("button",{type:"button",onClick:()=>{if(!K||!te)return;let e=x(K),t=x(te),a=new Map(e.entities.map(e=>[e.name,e])),s=new Map(e.relationships.map(e=>[e.name,e])),l=new Map(e.reasoners.map(e=>[e.id,e]));(t.entities||[]).forEach(e=>{to.entities[e.name]&&(a.has(e.name)?"replace"===ta&&a.set(e.name,e):a.set(e.name,e))}),(t.relationships||[]).forEach(e=>{to.relationships[e.name]&&(s.has(e.name)?"replace"===ta&&s.set(e.name,e):s.set(e.name,e))}),(t.reasoners||[]).forEach(e=>{to.reasoners[e.id]&&(l.has(e.id)?"replace"===ta&&l.set(e.id,e):l.set(e.id,e))}),tD({entities:Array.from(a.values()),relationships:Array.from(s.values()),reasoners:Array.from(l.values())},!0),tt(null),eb("Draft merged.")},className:"flex-1 rounded-2xl bg-slate-900 px-3 py-2 text-xs font-semibold text-white shadow",children:"Merge selected"}),(0,s.jsx)("button",{type:"button",onClick:()=>{te&&(tD(te,!1),tt(null),eb("Draft applied (replaced)."))},className:"flex-1 rounded-2xl border border-slate-200 bg-white px-3 py-2 text-xs font-semibold text-slate-600",children:"Replace"})]}),(0,s.jsx)("button",{type:"button",onClick:()=>{tt(null),eb("Draft discarded.")},className:"w-full rounded-2xl border border-slate-200 bg-white px-3 py-2 text-xs font-semibold text-slate-600",children:"Discard draft"})]})]}),(0,s.jsxs)("div",{className:"rounded-2xl border border-white/60 bg-white/90 p-4 shadow-sm",children:[(0,s.jsx)("p",{className:"text-xs font-semibold uppercase tracking-[0.2em] text-slate-400",children:"Validation"}),(0,s.jsxs)("p",{className:"mt-2 text-xs text-slate-500",children:[tE.length," issues"]}),(0,s.jsxs)("div",{className:"mt-3 max-h-40 space-y-2 overflow-auto pr-1",children:[tE.map((e,t)=>(0,s.jsxs)("div",{className:"rounded-2xl border border-slate-200 bg-white px-3 py-2",children:[(0,s.jsx)("p",{className:"text-xs font-semibold ".concat("error"===e.level?"text-rose-600":"text-amber-600"),children:e.level.toUpperCase()}),(0,s.jsx)("p",{className:"text-[11px] text-slate-600",children:e.message})]},"".concat(e.message,"-").concat(t))),!tE.length&&(0,s.jsx)("p",{className:"text-xs text-slate-500",children:"No validation issues."})]})]}),(0,s.jsxs)("div",{className:"rounded-2xl border border-white/60 bg-white/90 p-4 shadow-sm",children:[(0,s.jsx)("p",{className:"text-xs font-semibold uppercase tracking-[0.2em] text-slate-400",children:"Versions"}),(0,s.jsxs)("div",{className:"mt-3 max-h-40 space-y-2 overflow-auto pr-1",children:[e7.map(e=>(0,s.jsxs)("div",{className:"rounded-2xl border border-slate-200 bg-white px-3 py-2",children:[(0,s.jsx)("p",{className:"text-xs font-semibold text-slate-700",children:e.name}),(0,s.jsx)("p",{className:"text-[11px] text-slate-500",children:e.created_at}),(0,s.jsx)("button",{type:"button",onClick:()=>af(e.name),className:"mt-2 rounded-full border border-slate-200 bg-white px-2 py-1 text-[11px] text-slate-600",children:"Rollback"})]},e.name)),!e7.length&&(0,s.jsx)("p",{className:"text-xs text-slate-500",children:"No versions yet."})]})]}),(0,s.jsxs)("div",{className:"rounded-2xl border border-white/60 bg-white/90 p-4 shadow-sm",children:[(0,s.jsx)("p",{className:"text-xs font-semibold uppercase tracking-[0.2em] text-slate-400",children:"YAML Preview"}),(0,s.jsx)("textarea",{value:ej,readOnly:!0,placeholder:"Save to generate YAML preview.",className:"mt-3 h-32 w-full rounded-2xl border border-slate-200 bg-white px-3 py-2 text-xs text-slate-600"})]}),(0,s.jsxs)("div",{className:"rounded-2xl border border-white/60 bg-white/90 p-4 shadow-sm",children:[(0,s.jsx)("p",{className:"text-xs font-semibold uppercase tracking-[0.2em] text-slate-400",children:"Filters"}),(0,s.jsx)("div",{className:"mt-3 flex flex-wrap gap-2",children:["entity","derived","reasoner"].map(e=>(0,s.jsx)("button",{onClick:()=>ex(t=>({...t,[e]:!t[e]})),className:"rounded-full px-3 py-1 text-xs font-semibold ".concat(ec[e]?"bg-slate-900 text-white":"bg-slate-100 text-slate-500"),type:"button",children:e},e))}),(0,s.jsx)("button",{onClick:()=>e4(e=>!e),className:"mt-3 rounded-full px-3 py-1 text-xs font-semibold ".concat(e6?"bg-slate-900 text-white":"border border-slate-200 bg-white text-slate-600"),type:"button",children:"Joins view"}),(0,s.jsx)("button",{onClick:()=>ex({entity:!0,derived:!0,reasoner:!0}),className:"mt-3 rounded-full border border-slate-200 bg-white px-3 py-1 text-xs font-semibold text-slate-600",type:"button",children:"Show all"}),(0,s.jsx)("div",{className:"mt-4 grid grid-cols-2 gap-2",children:["entity","derived","reasoner"].map(e=>(0,s.jsxs)("button",{onClick:()=>t$(e),className:"rounded-2xl border border-slate-200 bg-white px-3 py-2 text-xs font-semibold text-slate-600",type:"button",children:["Add ",e]},e))})]}),eh&&(0,s.jsx)("p",{className:"text-xs text-slate-500",children:eh})]}),(0,s.jsxs)(r.E.section,{ref:Z,initial:{opacity:0,y:10},animate:{opacity:1,y:0},className:"flex min-h-[560px] w-full flex-1 flex-col gap-4 rounded-3xl border border-white/60 p-4 shadow-2xl ".concat(eO?"bg-white":"bg-white/70"),children:[(0,s.jsxs)("div",{className:"flex flex-wrap items-center justify-between gap-3 px-2",children:[(0,s.jsxs)("div",{className:"flex items-center gap-2 text-xs font-semibold uppercase tracking-[0.2em] text-slate-400",children:["Canvas",en&&(0,s.jsx)("span",{className:"rounded-full bg-amber-100 px-3 py-1 text-[11px] font-semibold text-amber-700",children:"Linking mode"}),!tS&&(0,s.jsxs)("span",{className:"rounded-full bg-slate-200 px-3 py-1 text-[11px] font-semibold text-slate-600",children:["Filter: ",tM||"none"]})]}),(0,s.jsxs)("div",{className:"flex flex-wrap items-center gap-2",children:[(0,s.jsx)("button",{onClick:t0,className:"rounded-full border border-slate-200 bg-white px-3 py-1 text-xs font-semibold text-slate-600",type:"button",children:eO?"Exit full screen":"Full screen"}),(0,s.jsx)("button",{onClick:()=>e4(e=>!e),className:"rounded-full px-3 py-1 text-xs font-semibold ".concat(e6?"bg-slate-900 text-white":"border border-slate-200 bg-white text-slate-600"),type:"button",children:"Joins view"}),(0,s.jsx)("div",{className:"flex items-center gap-1 rounded-full border border-slate-200 bg-white px-2 py-1",children:["entity","derived","reasoner"].map(e=>(0,s.jsx)("button",{onClick:()=>ex(t=>({...t,[e]:!t[e]})),className:"rounded-full px-2 py-1 text-[11px] font-semibold ".concat(ec[e]?"bg-slate-900 text-white":"text-slate-500"),type:"button",children:e},e))}),(0,s.jsx)("div",{className:"flex items-center gap-1 rounded-full border border-slate-200 bg-white px-2 py-1",children:["entity","derived","reasoner"].map(e=>(0,s.jsxs)("button",{onClick:()=>t$(e),className:"rounded-full px-2 py-1 text-[11px] font-semibold text-slate-600",type:"button",children:["+ ",e]},e))}),!tS&&(0,s.jsx)("button",{onClick:()=>{ex({entity:!0,derived:!0,reasoner:!0}),requestAnimationFrame(()=>tR(ee))},className:"rounded-full border border-slate-200 bg-white px-3 py-1 text-xs font-semibold text-slate-600",type:"button",children:"Show all"}),(0,s.jsx)("button",{onClick:()=>ei(null),className:"rounded-full border border-slate-200 bg-white px-3 py-1 text-xs font-semibold text-slate-600",type:"button",children:"Cancel link"}),(0,s.jsx)("button",{onClick:()=>{if(e6){et(e=>f(e,ea));return}let e=new Map;et(t=>u(t,e))},className:"rounded-full bg-slate-900 px-3 py-1 text-xs font-semibold text-white shadow transition hover:-translate-y-0.5",type:"button",children:"Auto layout"}),(0,s.jsx)("button",{onClick:()=>tR(tk.length?tk:ee),className:"rounded-full border border-slate-200 bg-white px-3 py-1 text-xs font-semibold text-slate-600",type:"button",children:"Fit"}),(0,s.jsx)("button",{onClick:()=>{ek(1),eS({x:0,y:0})},className:"rounded-full border border-slate-200 bg-white px-3 py-1 text-xs font-semibold text-slate-600",type:"button",children:"Reset"}),tp&&(0,s.jsx)("button",{onClick:tq,className:"rounded-full border border-emerald-200 bg-emerald-50 px-3 py-1 text-xs font-semibold text-emerald-700",type:"button",children:"Clear focus"}),(0,s.jsxs)("div",{className:"flex items-center gap-2 rounded-full border border-slate-200 bg-white px-3 py-1",children:[(0,s.jsx)("button",{onClick:()=>ek(e=>b(e-.1,.4,2)),className:"text-xs font-semibold text-slate-600",type:"button",children:"-"}),(0,s.jsx)("input",{type:"range",min:.4,max:2,step:.05,value:e_,onChange:e=>ek(Number(e.target.value)),className:"h-1 w-24 accent-slate-700"}),(0,s.jsx)("button",{onClick:()=>ek(e=>b(e+.1,.4,2)),className:"text-xs font-semibold text-slate-600",type:"button",children:"+"}),(0,s.jsxs)("span",{className:"text-[11px] font-semibold text-slate-500",children:[Math.round(100*e_),"%"]})]})]})]}),(0,s.jsxs)("div",{ref:W,onPointerDown:e=>{e.target.closest("[data-node]")||eE({startX:e.clientX,startY:e.clientY,originX:eC.x,originY:eC.y})},onDoubleClick:tX,onClick:e=>{2===e.detail&&tX(e)},onWheel:e=>{e.preventDefault();let t=b(e_+-(.0015*e.deltaY),.4,2),a=W.current;if(!a){ek(t);return}let s=a.getBoundingClientRect(),l=e.clientX-s.left,r=e.clientY-s.top,n=(l-eC.x)/e_,i=(r-eC.y)/e_,o=l-n*t,d=r-i*t;ek(t),eS({x:o,y:d})},className:"relative flex-1 overflow-hidden rounded-2xl border border-white/70 ".concat(eO?"bg-white":"bg-gradient-to-br from-white/70 via-white/30 to-white/90"),style:{backgroundImage:"radial-gradient(circle at 1px 1px, rgba(15, 23, 42, 0.08) 1px, transparent 0)",backgroundSize:"28px 28px",cursor:eM?"grabbing":"grab"},children:[(0,s.jsxs)("div",{className:"absolute left-0 top-0",style:{width:tx.width,height:tx.height,transform:"translate(".concat(eC.x,"px, ").concat(eC.y,"px) scale(").concat(e_,")"),transformOrigin:"0 0"},children:[(0,s.jsxs)("svg",{className:"pointer-events-none absolute left-0 top-0 z-20",width:tx.width,height:tx.height,children:[(0,s.jsx)("defs",{children:(0,s.jsx)("marker",{id:"arrow",markerWidth:"10",markerHeight:"10",refX:"10",refY:"3",orient:"auto",markerUnits:"strokeWidth",children:(0,s.jsx)("path",{d:"M0,0 L0,6 L9,3 z",fill:"#64748b"})})}),tY.map(e=>(0,s.jsxs)("g",{children:[(0,s.jsx)("path",{d:e.path,fill:"none",stroke:i[e.type],strokeWidth:2.2,strokeDasharray:"dependency"===e.type?"5 6":"reasoner_signal"===e.type||"reasoner_output"===e.type?"3 6":void 0,markerEnd:"url(#arrow)",opacity:tO?"dependency"===e.type&&tO.edges.has(e.id)?.9:.12:.75}),(0,s.jsx)("text",{x:e.labelX,y:e.labelY,textAnchor:"middle",className:"fill-slate-500 text-[11px] font-semibold uppercase tracking-[0.15em]",opacity:tO?"dependency"===e.type&&tO.edges.has(e.id)?.9:.12:.75,children:e.label})]},e.id))]}),tk.map(e=>(0,s.jsxs)(r.E.div,{initial:{opacity:0,scale:.96},animate:{opacity:1,scale:1},transition:{duration:.25},onPointerDown:t=>tF(t,e.id),onClick:t=>tU(e.id,t),onDoubleClick:t=>{t.stopPropagation(),tG(e.id)},"data-node":"true",className:"absolute z-10 cursor-grab rounded-2xl border border-white/80 bg-white/90 shadow-lg transition ".concat(el===e.id?"ring-2 ring-slate-900":""),style:{left:e.x,top:e.y,width:240,height:148,opacity:tO&&!tO.nodes.has(e.id)?.25:1},children:[(0,s.jsx)("button",{type:"button",onPointerDown:e=>e.stopPropagation(),onClick:t=>{t.stopPropagation(),tG(e.id)},className:"absolute right-2 top-2 rounded-full border px-2 py-0.5 text-[10px] font-semibold ".concat(tn===e.id?"border-emerald-200 bg-emerald-50 text-emerald-700":"border-slate-200 bg-white text-slate-500"),children:tn===e.id?"Focused":"Focus"}),(0,s.jsx)("div",{className:"rounded-2xl rounded-b-none bg-gradient-to-r px-4 py-2 text-xs font-semibold uppercase tracking-[0.2em] ".concat(n[e.kind]),children:e.kind}),(0,s.jsxs)("div",{className:"flex h-[calc(100%-36px)] flex-col justify-between px-4 py-3",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("h3",{className:"text-sm font-semibold text-slate-900",children:e.label}),(0,s.jsx)("p",{className:"mt-1 text-xs text-slate-500 line-clamp-2",children:e.description})]}),(0,s.jsx)("div",{className:"flex flex-wrap items-center gap-2",children:e.tags.map(e=>{let t="reasoner-output"===e?"bg-rose-100 text-rose-700":"bg-slate-100 text-slate-500";return(0,s.jsx)("span",{className:"rounded-full px-2 py-1 text-[10px] font-semibold ".concat(t),children:e},e)})})]}),(0,s.jsx)("button",{onClick:t=>{t.stopPropagation(),tz(e.id)},className:"absolute -right-2 top-1/2 h-7 w-7 -translate-y-1/2 rounded-full border border-white bg-slate-900 text-xs font-bold text-white shadow-md",type:"button",children:"+"})]},e.id))]}),eO&&(0,s.jsxs)("div",{className:"pointer-events-auto absolute bottom-4 right-4 w-96 rounded-2xl border border-white/60 bg-white/90 p-4 shadow-xl backdrop-blur",children:[(0,s.jsx)("p",{className:"text-xs font-semibold uppercase tracking-[0.2em] text-slate-400",children:"Logic"}),(0,s.jsx)("p",{className:"mt-2 text-xs text-slate-500",children:tm?tm.label:"Select a node"}),(null==tm?void 0:tm.kind)==="derived"&&(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)("textarea",{value:eD,onChange:e=>eA(e.target.value),placeholder:"Define formula or rule...",className:"mt-3 h-32 w-full rounded-2xl border border-slate-200 bg-white px-3 py-2 text-xs text-slate-600"}),(0,s.jsx)("input",{value:eL,readOnly:!0,placeholder:"Auto from expression",className:"mt-2 w-full rounded-2xl border border-slate-200 bg-slate-50 px-3 py-2 text-xs text-slate-600"}),(0,s.jsx)("button",{type:"button",onClick:t2,className:"mt-3 w-full rounded-2xl bg-slate-900 px-3 py-2 text-xs font-semibold text-white shadow",children:"Apply rule"}),(0,s.jsxs)("button",{type:"button",onClick:ab,className:"mt-2 w-full rounded-2xl border border-rose-200 bg-rose-50 px-3 py-2 text-xs font-semibold text-rose-600",children:["Delete ",tm.kind]})]}),(null==tm?void 0:tm.kind)==="reasoner"&&(0,s.jsxs)(s.Fragment,{children:[aj&&(0,s.jsx)("datalist",{id:"reasoner-output-".concat((null==aN?void 0:aN.id)||"unknown"),children:aj.options.map(e=>(0,s.jsx)("option",{value:e},e))}),(0,s.jsxs)("div",{className:"mt-3 flex items-center justify-between",children:[(0,s.jsx)("p",{className:"text-xs font-semibold uppercase tracking-[0.2em] text-slate-400",children:"Signals"}),(0,s.jsx)("button",{type:"button",onClick:ac,className:"rounded-full border border-slate-200 bg-white px-3 py-1 text-xs font-semibold text-slate-600",children:"+ Signal"})]}),(0,s.jsxs)("div",{className:"mt-3 flex items-center justify-between",children:[(0,s.jsx)("p",{className:"text-xs font-semibold uppercase tracking-[0.2em] text-slate-400",children:"Outputs"}),(0,s.jsx)("button",{type:"button",onClick:ar,className:"rounded-full border border-slate-200 bg-white px-3 py-1 text-xs font-semibold text-slate-600",children:"+ Output"})]}),(null==aj?void 0:null===(v=aj.entityNames)||void 0===v?void 0:v.length)?(0,s.jsxs)("p",{className:"mt-2 text-xs text-slate-500",children:["Entity type: ",(null==aN?void 0:aN.entity_type)||"generic"," - Entities:"," ",aj.entityNames.join(", ")]}):(0,s.jsxs)("p",{className:"mt-2 text-xs text-rose-500",children:["No entities found for entity_type ",(null==aN?void 0:aN.entity_type)||"generic","."]}),(0,s.jsxs)("div",{className:"mt-2 space-y-2",children:[0===((null===(S=tu.reasonerMap.get(tm.ref.reasonerId||""))||void 0===S?void 0:S.outputs)||[]).length&&(0,s.jsx)("p",{className:"text-xs text-slate-500",children:"No outputs yet."}),((null===(L=tu.reasonerMap.get(tm.ref.reasonerId||""))||void 0===L?void 0:L.outputs)||[]).map((e,t)=>(0,s.jsxs)("div",{className:"rounded-2xl border border-slate-200 p-3",children:[(0,s.jsxs)("div",{className:"flex items-center gap-2",children:[(0,s.jsx)("input",{value:e,list:"reasoner-output-".concat((null==aN?void 0:aN.id)||"unknown"),onChange:e=>an(t,e.target.value),placeholder:"output_field",className:"flex-1 rounded-xl border border-slate-200 px-2 py-1 text-xs"}),(0,s.jsx)("button",{type:"button",onClick:()=>ai(t),className:"rounded-xl border border-rose-200 bg-rose-50 px-2 py-1 text-xs text-rose-600",children:"Remove"})]}),(()=>{var t;let a=e?null==aj?void 0:aj.fieldMap.get(e):null;return e?a?(0,s.jsxs)("div",{className:"mt-2 text-xs text-slate-500",children:[(0,s.jsxs)("p",{children:[a.field.derived?"derived":"base"," - ",a.entity.name]}),(0,s.jsx)("p",{className:"mt-1 text-slate-600",children:M(K,a.entity.name,a.field)}),(null===(t=a.field.depends_on)||void 0===t?void 0:t.length)?(0,s.jsxs)("p",{className:"mt-1 text-slate-400",children:["depends_on: ",a.field.depends_on.join(", ")]}):null]}):(0,s.jsxs)("p",{className:"mt-2 text-xs text-rose-500",children:["Output not found on entity type ",(null==aN?void 0:aN.entity_type)||"generic","."]}):(0,s.jsx)("p",{className:"mt-2 text-xs text-slate-400",children:"Select an output field."})})()]},"".concat(e,"-").concat(t)))]}),(0,s.jsxs)("div",{className:"mt-2 max-h-56 space-y-3 overflow-auto pr-1",children:[0===eK.length&&(0,s.jsx)("p",{className:"text-xs text-slate-500",children:"No signals yet."}),eK.map((e,t)=>{var a;return(0,s.jsx)("div",{className:"rounded-2xl border border-slate-200 p-3",children:(0,s.jsxs)("div",{className:"grid grid-cols-2 gap-2",children:[(0,s.jsx)("input",{value:e.name,onChange:e=>al(t,{name:e.target.value}),placeholder:"name",className:"rounded-xl border border-slate-200 px-2 py-1 text-xs"}),(0,s.jsx)("input",{value:e.metric_field,onChange:e=>al(t,{metric_field:e.target.value}),placeholder:"metric_field",className:"rounded-xl border border-slate-200 px-2 py-1 text-xs"}),(0,s.jsx)("input",{value:e.threshold,type:"number",onChange:e=>al(t,{threshold:Number(e.target.value)||0}),placeholder:"threshold",className:"rounded-xl border border-slate-200 px-2 py-1 text-xs"}),(0,s.jsxs)("select",{value:e.direction,onChange:e=>al(t,{direction:e.target.value}),className:"rounded-xl border border-slate-200 px-2 py-1 text-xs",children:[(0,s.jsx)("option",{value:"below",children:"below"}),(0,s.jsx)("option",{value:"above",children:"above"}),(0,s.jsx)("option",{value:"equals",children:"equals"})]}),(0,s.jsx)("input",{value:null!==(a=e.weight)&&void 0!==a?a:"",type:"number",onChange:e=>al(t,{weight:""===e.target.value?void 0:Number(e.target.value)}),placeholder:"weight",className:"rounded-xl border border-slate-200 px-2 py-1 text-xs"}),(0,s.jsx)("button",{type:"button",onClick:()=>ax(t),className:"rounded-xl border border-rose-200 bg-rose-50 px-2 py-1 text-xs text-rose-600",children:"Remove"})]})},"".concat(e.name,"-").concat(t))})]}),(0,s.jsx)("button",{type:"button",onClick:t2,className:"mt-3 w-full rounded-2xl bg-slate-900 px-3 py-2 text-xs font-semibold text-white shadow",children:"Apply reasoner rules"}),(0,s.jsxs)("button",{type:"button",onClick:ab,className:"mt-2 w-full rounded-2xl border border-rose-200 bg-rose-50 px-3 py-2 text-xs font-semibold text-rose-600",children:["Delete ",tm.kind]})]}),(null==tm?void 0:tm.kind)==="entity"&&(0,s.jsxs)("button",{type:"button",onClick:ab,className:"mt-3 w-full rounded-2xl border border-rose-200 bg-rose-50 px-3 py-2 text-xs font-semibold text-rose-600",children:["Delete ",tm.kind]}),(0,s.jsx)("p",{className:"mt-3 text-[11px] text-slate-400",children:"Link nodes: click + on a node, then click the target node."})]}),e0&&(0,s.jsxs)("div",{className:"pointer-events-auto absolute left-1/2 top-6 w-[420px] -translate-x-1/2 rounded-3xl border border-white/60 bg-white/95 p-5 shadow-2xl backdrop-blur",children:[(0,s.jsx)("p",{className:"text-xs font-semibold uppercase tracking-[0.2em] text-slate-400",children:"edit"===e0.mode?"Edit Relationship":"Create Relationship"}),(0,s.jsxs)("p",{className:"mt-2 text-xs text-slate-500",children:[e0.from,"  ",e0.to]}),(0,s.jsxs)("div",{className:"mt-4 grid grid-cols-2 gap-2",children:[(0,s.jsx)("select",{value:e0.from,onChange:e=>e2(t=>t?{...t,from:e.target.value}:t),className:"rounded-2xl border border-slate-200 bg-white px-3 py-2 text-xs text-slate-600",children:((null==K?void 0:K.entities)||[]).map(e=>(0,s.jsx)("option",{value:e.name,children:e.name},e.name))}),(0,s.jsx)("select",{value:e0.to,onChange:e=>e2(t=>t?{...t,to:e.target.value}:t),className:"rounded-2xl border border-slate-200 bg-white px-3 py-2 text-xs text-slate-600",children:((null==K?void 0:K.entities)||[]).map(e=>(0,s.jsx)("option",{value:e.name,children:e.name},e.name))})]}),(0,s.jsx)("label",{className:"mt-4 block text-xs font-semibold uppercase tracking-[0.2em] text-slate-400",children:"Name"}),(0,s.jsx)("input",{value:e0.name,onChange:e=>e2(t=>t?{...t,name:e.target.value}:t),className:"mt-2 w-full rounded-2xl border border-slate-200 bg-white px-3 py-2 text-xs text-slate-600"}),(0,s.jsx)("label",{className:"mt-4 block text-xs font-semibold uppercase tracking-[0.2em] text-slate-400",children:"Join Keys"}),(0,s.jsx)("textarea",{value:e0.joinText,onChange:e=>e2(t=>t?{...t,joinText:e.target.value}:t),placeholder:"left_key=right_key",className:"mt-2 h-24 w-full rounded-2xl border border-slate-200 bg-white px-3 py-2 text-xs text-slate-600"}),(0,s.jsx)("label",{className:"mt-4 block text-xs font-semibold uppercase tracking-[0.2em] text-slate-400",children:"Description"}),(0,s.jsx)("textarea",{value:e0.description,onChange:e=>e2(t=>t?{...t,description:e.target.value}:t),className:"mt-2 h-20 w-full rounded-2xl border border-slate-200 bg-white px-3 py-2 text-xs text-slate-600"}),(0,s.jsxs)("div",{className:"mt-4 flex gap-2",children:[(0,s.jsx)("button",{type:"button",onClick:()=>e2(null),className:"flex-1 rounded-2xl border border-slate-200 bg-white px-3 py-2 text-xs font-semibold text-slate-600",children:"Cancel"}),(0,s.jsx)("button",{type:"button",onClick:()=>{if(!K||!e0)return;let e=g(e0.joinText);if(!e.length){eb("Relationship join keys are required.");return}let t=K.relationships.map(e=>({...e}));if("edit"===e0.mode&&e0.originalName){let a=t.findIndex(e=>e.name===e0.originalName);a>=0&&(t[a]={name:e0.name||e0.originalName,from_entity:e0.from,to_entity:e0.to,description:e0.description||"User defined relationship",join_on:e})}else{let a=new Set(t.map(e=>e.name)),s=h(e0.name||"relationship",a);t.push({name:s,from_entity:e0.from,to_entity:e0.to,description:e0.description||"User defined relationship",join_on:e})}tD({...K,relationships:t},!0),e2(null),eb("edit"===e0.mode?"Relationship updated.":"Relationship added.")},className:"flex-1 rounded-2xl bg-slate-900 px-3 py-2 text-xs font-semibold text-white shadow",children:"Create"})]})]})]})]}),(0,s.jsx)(r.E.aside,{initial:{opacity:0,x:20},animate:{opacity:1,x:0},className:"flex w-full flex-col gap-5 rounded-3xl border border-white/60 bg-white/70 p-5 shadow-xl lg:w-80",children:(0,s.jsxs)("div",{children:[(0,s.jsx)("h2",{className:"text-sm font-semibold uppercase tracking-[0.25em] text-slate-400",children:"Inspector"}),tm?(0,s.jsxs)("div",{className:"mt-4 space-y-4",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{className:"text-xs font-semibold uppercase tracking-[0.2em] text-slate-400",children:"Label"}),(0,s.jsx)("input",{value:tm.label,onChange:e=>tK(e.target.value),className:"mt-2 w-full rounded-2xl border border-slate-200 bg-white px-3 py-2 text-sm font-semibold text-slate-700"})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{className:"text-xs font-semibold uppercase tracking-[0.2em] text-slate-400",children:"Description"}),(0,s.jsx)("textarea",{value:tm.description,onChange:e=>tV(tm,e.target.value),className:"mt-2 h-20 w-full rounded-2xl border border-slate-200 bg-white px-3 py-2 text-sm text-slate-600"})]}),(0,s.jsxs)("button",{type:"button",onClick:ab,className:"rounded-2xl border border-rose-200 bg-rose-50 px-3 py-2 text-xs font-semibold text-rose-600",children:["Delete ",tm.kind]}),(0,s.jsxs)("div",{className:"rounded-2xl border border-slate-100 bg-slate-50 px-4 py-3",children:[(0,s.jsx)("p",{className:"text-xs font-semibold text-slate-500",children:"Inputs"}),(0,s.jsx)("p",{className:"mt-2 text-xs text-slate-600",children:tm.inputs.length?tm.inputs.join(", "):"None"}),(0,s.jsx)("p",{className:"mt-4 text-xs font-semibold text-slate-500",children:"Outputs"}),(0,s.jsx)("p",{className:"mt-2 text-xs text-slate-600",children:tm.outputs.length?tm.outputs.join(", "):"None"})]}),ay&&(0,s.jsxs)("div",{className:"rounded-2xl border border-white/60 bg-white/90 px-4 py-4 shadow-sm",children:[(0,s.jsx)("p",{className:"text-xs font-semibold uppercase tracking-[0.2em] text-slate-400",children:"Entity Details"}),(0,s.jsxs)("p",{className:"mt-2 text-xs text-slate-600",children:["Table: ",ay.database?"".concat(ay.database,"."):"",ay.schema?"".concat(ay.schema,"."):"",ay.table]}),(0,s.jsxs)("p",{className:"mt-2 text-xs text-slate-600",children:["Join keys: ",(null===(J=ay.join_keys)||void 0===J?void 0:J.length)?ay.join_keys.join(", "):"None"]}),(0,s.jsxs)("div",{className:"mt-4 space-y-3",children:[(0,s.jsx)("input",{value:ay.database||"",onChange:e=>t4({database:e.target.value}),placeholder:"Database",className:"w-full rounded-2xl border border-slate-200 bg-white px-3 py-2 text-xs text-slate-600"}),(0,s.jsx)("input",{value:ay.schema||"",onChange:e=>t4({schema:e.target.value}),placeholder:"Schema",className:"w-full rounded-2xl border border-slate-200 bg-white px-3 py-2 text-xs text-slate-600"}),(0,s.jsx)("input",{value:ay.table||"",onChange:e=>t4({table:e.target.value}),placeholder:"Table",className:"w-full rounded-2xl border border-slate-200 bg-white px-3 py-2 text-xs text-slate-600"}),(0,s.jsx)("input",{value:(null===(I=ay.join_keys)||void 0===I?void 0:I.join(", "))||"",onChange:e=>t4({join_keys:e.target.value.split(",").map(e=>e.trim()).filter(Boolean)}),placeholder:"Join keys (comma separated)",className:"w-full rounded-2xl border border-slate-200 bg-white px-3 py-2 text-xs text-slate-600"}),(0,s.jsx)("input",{value:ay.entity_type||"",onChange:e=>t4({entity_type:e.target.value}),placeholder:"Entity type",className:"w-full rounded-2xl border border-slate-200 bg-white px-3 py-2 text-xs text-slate-600"}),(0,s.jsx)("input",{value:ay.default_metric||"",onChange:e=>t4({default_metric:e.target.value}),placeholder:"Default metric",className:"w-full rounded-2xl border border-slate-200 bg-white px-3 py-2 text-xs text-slate-600"})]}),(0,s.jsxs)("div",{className:"mt-5 rounded-2xl border border-slate-100 bg-slate-50/60 p-3",children:[(0,s.jsxs)("div",{className:"flex items-center justify-between",children:[(0,s.jsx)("p",{className:"text-xs font-semibold uppercase tracking-[0.2em] text-slate-400",children:"Fields"}),(0,s.jsxs)("div",{className:"flex gap-2",children:[(0,s.jsx)("button",{type:"button",onClick:()=>as(ay.name),className:"rounded-full border border-slate-200 bg-white px-3 py-1 text-[11px] font-semibold text-slate-600",children:"Import"}),(0,s.jsx)("button",{type:"button",onClick:()=>ae(ay.name),className:"rounded-full border border-slate-200 bg-white px-3 py-1 text-[11px] font-semibold text-slate-600",children:"+ Field"})]})]}),(0,s.jsx)("div",{className:"mt-3 flex gap-2",children:["base","derived","all"].map(e=>(0,s.jsx)("button",{type:"button",onClick:()=>e3(e),className:"rounded-full px-3 py-1 text-[11px] font-semibold ".concat(e1===e?"bg-slate-900 text-white":"bg-white text-slate-500"),children:e},e))}),(0,s.jsxs)("div",{className:"mt-3 max-h-64 space-y-2 overflow-auto pr-1",children:[(ay.fields||[]).filter(e=>"all"===e1||("derived"===e1?e.derived:!e.derived)).map(e=>(0,s.jsxs)("div",{className:"rounded-2xl border border-slate-200 bg-white p-2",children:[(0,s.jsxs)("div",{className:"grid grid-cols-2 gap-2",children:[(0,s.jsx)("input",{value:e.name,onChange:t=>t7(ay.name,e.name,{name:t.target.value.toLowerCase()}),placeholder:"name",className:"rounded-xl border border-slate-200 px-2 py-1 text-xs"}),(0,s.jsxs)("div",{className:"flex items-center gap-2",children:[(0,s.jsx)("input",{list:"dtype-presets",value:e.dtype,onChange:t=>t7(ay.name,e.name,{dtype:t.target.value}),placeholder:"dtype",className:"flex-1 rounded-xl border border-slate-200 px-2 py-1 text-xs"}),(0,s.jsxs)("select",{value:"",onChange:t=>t7(ay.name,e.name,{dtype:t.target.value}),className:"rounded-xl border border-slate-200 px-2 py-1 text-xs",children:[(0,s.jsx)("option",{value:"",children:"preset"}),j.map(e=>(0,s.jsx)("option",{value:e.value,children:e.label},e.value))]})]}),(0,s.jsxs)("select",{value:e.role,onChange:t=>{let a=t.target.value;t7(ay.name,e.name,{role:a,default_agg:"metric"===a?e.default_agg||D(e.name,e.dtype):""})},className:"rounded-xl border border-slate-200 px-2 py-1 text-xs",children:[(0,s.jsx)("option",{value:"dimension",children:"dimension"}),(0,s.jsx)("option",{value:"metric",children:"metric"})]}),(0,s.jsxs)("select",{value:e.default_agg||"",onChange:t=>t7(ay.name,e.name,{default_agg:t.target.value}),disabled:"metric"!==e.role,className:"rounded-xl border border-slate-200 px-2 py-1 text-xs text-slate-600 disabled:cursor-not-allowed disabled:bg-slate-100",children:[(0,s.jsx)("option",{value:"",children:"default agg"}),w.filter(Boolean).map(e=>(0,s.jsx)("option",{value:e,children:e},e))]}),(0,s.jsx)("input",{value:e.expr,onChange:t=>t7(ay.name,e.name,{expr:t.target.value}),placeholder:"expr",className:"col-span-2 rounded-xl border border-slate-200 px-2 py-1 text-xs"})]}),(0,s.jsxs)("div",{className:"mt-2 flex items-center justify-between",children:[(0,s.jsxs)("span",{className:"text-[11px] text-slate-400",children:[e.derived?"derived":"base",e.default_agg?" - ".concat(e.default_agg):""]}),(0,s.jsx)("button",{type:"button",onClick:()=>at(ay.name,e.name),className:"rounded-full border border-rose-200 bg-rose-50 px-2 py-1 text-[11px] text-rose-600",children:"Delete"})]}),"last"===e.default_agg&&(0,s.jsxs)("div",{className:"mt-2 rounded-xl border border-slate-100 bg-slate-50 px-3 py-2",children:[(0,s.jsxs)("div",{className:"flex items-center justify-between",children:[(0,s.jsx)("p",{className:"text-[11px] font-semibold uppercase tracking-[0.2em] text-slate-400",children:"Order by"}),(0,s.jsx)("button",{type:"button",onClick:()=>t8(ay.name,e.name,[...e.order_by||[],{field:"",direction:"asc"}]),className:"rounded-full border border-slate-200 bg-white px-2 py-1 text-[11px] text-slate-600",children:"+ Add"})]}),(0,s.jsxs)("div",{className:"mt-2 space-y-2",children:[0===(e.order_by||[]).length&&(0,s.jsx)("p",{className:"text-xs text-slate-500",children:"No order fields set."}),(e.order_by||[]).map((t,a)=>(0,s.jsxs)("div",{className:"grid grid-cols-3 gap-2",children:[(0,s.jsxs)("select",{value:t.field,onChange:t=>{let s=(e.order_by||[]).map((e,s)=>s===a?{...e,field:t.target.value}:e);t8(ay.name,e.name,s)},className:"col-span-2 rounded-xl border border-slate-200 px-2 py-1 text-xs",children:[(0,s.jsx)("option",{value:"",children:"field"}),(ay.fields||[]).map(e=>(0,s.jsx)("option",{value:e.name,children:e.name},e.name))]}),(0,s.jsxs)("div",{className:"flex gap-2",children:[(0,s.jsxs)("select",{value:t.direction||"asc",onChange:t=>{let s=(e.order_by||[]).map((e,s)=>s===a?{...e,direction:t.target.value}:e);t8(ay.name,e.name,s)},className:"flex-1 rounded-xl border border-slate-200 px-2 py-1 text-xs",children:[(0,s.jsx)("option",{value:"asc",children:"asc"}),(0,s.jsx)("option",{value:"desc",children:"desc"})]}),(0,s.jsx)("button",{type:"button",onClick:()=>{let t=(e.order_by||[]).filter((e,t)=>t!==a);t8(ay.name,e.name,t)},className:"rounded-xl border border-rose-200 bg-rose-50 px-2 py-1 text-xs text-rose-600",children:"Remove"})]})]},"".concat(t.field,"-").concat(a)))]})]})]},e.name)),!(null===(T=ay.fields)||void 0===T?void 0:T.length)&&(0,s.jsx)("p",{className:"text-xs text-slate-500",children:"No fields yet."})]}),(0,s.jsxs)("div",{className:"mt-3 rounded-2xl border border-slate-100 bg-slate-50/80 p-3",children:[(0,s.jsxs)("div",{className:"flex items-center justify-between",children:[(0,s.jsx)("p",{className:"text-[11px] font-semibold uppercase tracking-[0.2em] text-slate-400",children:"Prev field metrics"}),(0,s.jsxs)("div",{className:"flex items-center gap-2",children:[(0,s.jsx)("button",{type:"button",onClick:()=>ad(ay.name,ag.map(e=>e.name)),className:"rounded-full border border-slate-200 bg-white px-2 py-1 text-[11px] text-slate-600",children:"Select all"}),(0,s.jsx)("button",{type:"button",onClick:()=>ad(ay.name,[]),className:"rounded-full border border-slate-200 bg-white px-2 py-1 text-[11px] text-slate-600",children:"Clear"})]})]}),(0,s.jsxs)("div",{className:"mt-2 max-h-32 space-y-1 overflow-auto pr-1",children:[!ag.length&&(0,s.jsx)("p",{className:"text-xs text-slate-500",children:"No base metrics available."}),ag.map(e=>(0,s.jsxs)("label",{className:"flex items-center gap-2 text-xs text-slate-600",children:[(0,s.jsx)("input",{type:"checkbox",checked:av.includes(e.name),onChange:()=>ao(ay.name,e.name),className:"h-3.5 w-3.5 rounded border-slate-300"}),e.name]},e.name))]})]}),(0,s.jsx)("button",{type:"button",onClick:()=>aa(ay.name,av),className:"mt-3 w-full rounded-2xl bg-slate-900 px-3 py-2 text-xs font-semibold text-white shadow",children:"Generate prev_ fields"})]})]}),"entity"!==tm.kind&&(0,s.jsxs)("div",{className:"space-y-3 rounded-2xl border border-white/60 bg-white/90 px-4 py-4 shadow-sm",children:[(0,s.jsx)("p",{className:"text-xs font-semibold uppercase tracking-[0.2em] text-slate-400",children:"Logic"}),"derived"===tm.kind?(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)("div",{className:"grid grid-cols-2 gap-2",children:[(0,s.jsxs)("div",{className:"flex items-center gap-2",children:[(0,s.jsx)("input",{list:"dtype-presets",value:(null===(B=tu.entityMap.get(tm.ref.entityName||""))||void 0===B?void 0:null===(P=B.fields.find(e=>e.name===tm.ref.fieldName))||void 0===P?void 0:P.dtype)||"",onChange:e=>t5({dtype:e.target.value}),placeholder:"dtype",className:"flex-1 rounded-xl border border-slate-200 px-2 py-1 text-xs text-slate-600"}),(0,s.jsxs)("select",{value:"",onChange:e=>t5({dtype:e.target.value}),className:"rounded-xl border border-slate-200 px-2 py-1 text-xs text-slate-600",children:[(0,s.jsx)("option",{value:"",children:"preset"}),j.map(e=>(0,s.jsx)("option",{value:e.value,children:e.label},e.value))]})]}),(0,s.jsxs)("select",{value:(null===(Y=tu.entityMap.get(tm.ref.entityName||""))||void 0===Y?void 0:null===(F=Y.fields.find(e=>e.name===tm.ref.fieldName))||void 0===F?void 0:F.role)||"metric",onChange:e=>t5({role:e.target.value}),className:"rounded-xl border border-slate-200 px-2 py-1 text-xs text-slate-600",children:[(0,s.jsx)("option",{value:"metric",children:"metric"}),(0,s.jsx)("option",{value:"dimension",children:"dimension"})]}),(0,s.jsx)("select",{value:(null===(q=tu.entityMap.get(tm.ref.entityName||""))||void 0===q?void 0:null===(z=q.fields.find(e=>e.name===tm.ref.fieldName))||void 0===z?void 0:z.default_agg)||"",onChange:e=>t5({default_agg:e.target.value}),className:"rounded-xl border border-slate-200 px-2 py-1 text-xs text-slate-600",children:w.map(e=>(0,s.jsx)("option",{value:e,children:e||"none"},e||"none"))})]}),(()=>{let e=tu.entityMap.get(tm.ref.entityName||""),t=null==e?void 0:e.fields.find(e=>e.name===tm.ref.fieldName);if(!t||"last"!==t.default_agg)return null;let a=t.order_by||[],l=((null==e?void 0:e.fields)||[]).map(e=>e.name);return(0,s.jsxs)("div",{className:"rounded-2xl border border-slate-100 bg-slate-50 px-3 py-2",children:[(0,s.jsxs)("div",{className:"flex items-center justify-between",children:[(0,s.jsx)("p",{className:"text-[11px] font-semibold uppercase tracking-[0.2em] text-slate-400",children:"Order by"}),(0,s.jsx)("button",{type:"button",onClick:()=>t8(tm.ref.entityName,tm.ref.fieldName,[...a,{field:"",direction:"asc"}]),className:"rounded-full border border-slate-200 bg-white px-2 py-1 text-[11px] text-slate-600",children:"+ Add"})]}),(0,s.jsxs)("div",{className:"mt-2 space-y-2",children:[0===a.length&&(0,s.jsx)("p",{className:"text-xs text-slate-500",children:"No order fields set."}),a.map((e,t)=>(0,s.jsxs)("div",{className:"grid grid-cols-3 gap-2",children:[(0,s.jsxs)("select",{value:e.field,onChange:e=>{let s=a.map((a,s)=>s===t?{...a,field:e.target.value}:a);t8(tm.ref.entityName,tm.ref.fieldName,s)},className:"col-span-2 rounded-xl border border-slate-200 px-2 py-1 text-xs",children:[(0,s.jsx)("option",{value:"",children:"field"}),l.map(e=>(0,s.jsx)("option",{value:e,children:e},e))]}),(0,s.jsxs)("div",{className:"flex gap-2",children:[(0,s.jsxs)("select",{value:e.direction||"asc",onChange:e=>{let s=a.map((a,s)=>s===t?{...a,direction:e.target.value}:a);t8(tm.ref.entityName,tm.ref.fieldName,s)},className:"flex-1 rounded-xl border border-slate-200 px-2 py-1 text-xs",children:[(0,s.jsx)("option",{value:"asc",children:"asc"}),(0,s.jsx)("option",{value:"desc",children:"desc"})]}),(0,s.jsx)("button",{type:"button",onClick:()=>{let e=a.filter((e,a)=>a!==t);t8(tm.ref.entityName,tm.ref.fieldName,e)},className:"rounded-xl border border-rose-200 bg-rose-50 px-2 py-1 text-xs text-rose-600",children:"Remove"})]})]},"".concat(e.field,"-").concat(t)))]})]})})(),(0,s.jsx)("label",{className:"text-xs font-semibold uppercase tracking-[0.2em] text-slate-400",children:"Expression"}),(0,s.jsx)("textarea",{value:eD,onChange:e=>eA(e.target.value),placeholder:"Define formula or rule...",className:"h-24 w-full rounded-2xl border border-slate-200 bg-white px-3 py-2 text-sm text-slate-600"}),(0,s.jsx)("label",{className:"text-xs font-semibold uppercase tracking-[0.2em] text-slate-400",children:"Depends On"}),(0,s.jsx)("input",{value:eL,readOnly:!0,placeholder:"Auto from expression",className:"w-full rounded-2xl border border-slate-200 bg-slate-50 px-3 py-2 text-sm text-slate-600"}),(()=>{let e=tu.entityMap.get(tm.ref.entityName||""),t=new Set(((null==e?void 0:e.fields)||[]).map(e=>e.name)),a=eL.split(",").map(e=>e.trim()).filter(e=>e&&!t.has(e));return a.length?(0,s.jsxs)("p",{className:"text-xs text-rose-500",children:["Missing fields: ",a.join(", ")]}):null})(),(0,s.jsx)("button",{type:"button",onClick:t2,className:"w-full rounded-2xl bg-slate-900 px-3 py-2 text-sm font-semibold text-white shadow",children:"Apply rule"}),(0,s.jsxs)("div",{className:"mt-4 rounded-2xl border border-slate-100 bg-slate-50 px-3 py-3",children:[(0,s.jsx)("p",{className:"text-[11px] font-semibold uppercase tracking-[0.2em] text-slate-400",children:"LLM helper"}),(0,s.jsx)("textarea",{value:eP,onChange:e=>eB(e.target.value),placeholder:"Describe the logic in natural language...",className:"mt-2 h-20 w-full rounded-2xl border border-slate-200 bg-white px-3 py-2 text-sm text-slate-600"}),(0,s.jsxs)("div",{className:"mt-2 flex flex-wrap gap-2",children:[(0,s.jsx)("button",{type:"button",onClick:t1,className:"rounded-xl border border-slate-200 bg-white px-3 py-2 text-xs font-semibold text-slate-700",children:"Generate rule"}),(0,s.jsx)("button",{type:"button",onClick:t3,className:"rounded-xl border border-slate-200 bg-white px-3 py-2 text-xs font-semibold text-slate-700",children:"Validate rule"}),(0,s.jsx)("button",{type:"button",onClick:()=>{K&&(null==tm?void 0:tm.ref.entityName)&&(null==tm?void 0:tm.ref.fieldName)&&"derived"===tm.kind&&(eT(JSON.stringify(E(tm.ref.entityName,tm.ref.fieldName,eD||""),null,2)),eq([]),eY("Rule JSON synced from expression."),eU(""),eQ(""))},className:"rounded-xl border border-slate-200 bg-white px-3 py-2 text-xs font-semibold text-slate-700",children:"Sync from expression"})]}),eF&&(0,s.jsx)("p",{className:"mt-2 text-xs text-slate-500",children:eF})]}),(0,s.jsxs)("div",{className:"mt-4 rounded-2xl border border-slate-100 bg-slate-50 px-3 py-3",children:[(0,s.jsx)("p",{className:"text-[11px] font-semibold uppercase tracking-[0.2em] text-slate-400",children:"Rule JSON"}),(0,s.jsx)("textarea",{value:eI,onChange:e=>eT(e.target.value),placeholder:'{"entity":"...","field":"...","rules":[{"expr":"..."}]}',className:"mt-2 h-40 w-full rounded-2xl border border-slate-200 bg-white px-3 py-2 text-xs text-slate-600"}),(0,s.jsx)("div",{className:"mt-2 flex gap-2",children:(0,s.jsx)("button",{type:"button",onClick:()=>{if(!K||!(null==tm?void 0:tm.ref.entityName)||!(null==tm?void 0:tm.ref.fieldName)||"derived"!==tm.kind)return;let e=null;try{e=JSON.parse(eI||"")}catch(e){eb("Rule JSON is invalid.");return}if(!e||"object"!=typeof e){eb("Rule JSON is invalid.");return}let t={entity:e.entity||tm.ref.entityName,field:e.field||tm.ref.fieldName,rules:e.rules||[],vars:e.vars||{},description:e.description||""};if(!t.rules||0===t.rules.length){eb("Rule JSON must include at least one rule.");return}let a=K.entities.find(e=>e.name===t.entity),s=((null==a?void 0:a.fields)||[]).map(e=>e.name),l=null==a?void 0:a.fields.find(e=>e.name===t.field),r=_(O(t,s,t.field),null==l?void 0:l.order_by),n=1!==t.rules.length||t.rules[0].when?eD:t.rules[0].expr;$({...K,derived_rel_rules:C(K,t),entities:K.entities.map(e=>e.name!==t.entity?e:{...e,fields:e.fields.map(e=>e.name===t.field?{...e,expr:n,depends_on:r}:e)})}),eA(n||""),eJ(r.join(", ")),eT(JSON.stringify(t,null,2)),eq([]),eY("Rule JSON applied."),eU(""),eQ(""),eb("Derived rule updated.")},className:"rounded-xl bg-slate-900 px-3 py-2 text-xs font-semibold text-white shadow",children:"Apply rule JSON"})}),ez.length>0&&(0,s.jsx)("div",{className:"mt-2 rounded-xl border border-rose-200 bg-rose-50 px-3 py-2 text-xs text-rose-600",children:ez.map((e,t)=>(0,s.jsx)("p",{children:e},"".concat(e,"-").concat(t)))})]}),(0,s.jsxs)("div",{className:"mt-4 rounded-2xl border border-slate-100 bg-slate-50 px-3 py-3",children:[(0,s.jsx)("p",{className:"text-[11px] font-semibold uppercase tracking-[0.2em] text-slate-400",children:"Snowflake SQL"}),(0,s.jsx)("textarea",{value:eX,readOnly:!0,placeholder:"Generate SQL from the rule JSON...",className:"mt-2 h-40 w-full rounded-2xl border border-slate-200 bg-white px-3 py-2 text-xs text-slate-600"}),(0,s.jsx)("div",{className:"mt-2 flex gap-2",children:(0,s.jsx)("button",{type:"button",onClick:t6,disabled:ey,className:"rounded-xl border border-slate-200 bg-white px-3 py-2 text-xs font-semibold text-slate-700",children:"Generate SQL"})}),eG&&(0,s.jsx)("p",{className:"mt-2 text-xs text-slate-500",children:eG})]})]}):(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)("div",{className:"grid grid-cols-2 gap-2",children:[(0,s.jsx)("input",{value:(null===(X=tu.reasonerMap.get(tm.ref.reasonerId||""))||void 0===X?void 0:X.entity_type)||"",onChange:e=>t9({entity_type:e.target.value}),placeholder:"Entity type",className:"rounded-xl border border-slate-200 px-2 py-1 text-xs text-slate-600"}),(0,s.jsx)("input",{value:(null===(U=tu.reasonerMap.get(tm.ref.reasonerId||""))||void 0===U?void 0:U.type)||"",onChange:e=>t9({type:e.target.value}),placeholder:"Type",className:"rounded-xl border border-slate-200 px-2 py-1 text-xs text-slate-600"})]}),aj&&(0,s.jsx)("datalist",{id:"reasoner-output-".concat((null==aN?void 0:aN.id)||"unknown"),children:aj.options.map(e=>(0,s.jsx)("option",{value:e},e))}),(0,s.jsxs)("div",{className:"flex items-center justify-between",children:[(0,s.jsx)("p",{className:"text-xs font-semibold uppercase tracking-[0.2em] text-slate-400",children:"Outputs"}),(0,s.jsx)("button",{type:"button",onClick:ar,className:"rounded-full border border-slate-200 bg-white px-3 py-1 text-xs font-semibold text-slate-600",children:"+ Output"})]}),(null==aj?void 0:null===(G=aj.entityNames)||void 0===G?void 0:G.length)?(0,s.jsxs)("p",{className:"mt-2 text-xs text-slate-500",children:["Entity type: ",(null==aN?void 0:aN.entity_type)||"generic"," - Entities:"," ",aj.entityNames.join(", ")]}):(0,s.jsxs)("p",{className:"mt-2 text-xs text-rose-500",children:["No entities found for entity_type ",(null==aN?void 0:aN.entity_type)||"generic","."]}),(0,s.jsxs)("div",{className:"space-y-2",children:[0===((null===(Q=tu.reasonerMap.get(tm.ref.reasonerId||""))||void 0===Q?void 0:Q.outputs)||[]).length&&(0,s.jsx)("p",{className:"text-xs text-slate-500",children:"No outputs yet."}),((null===(V=tu.reasonerMap.get(tm.ref.reasonerId||""))||void 0===V?void 0:V.outputs)||[]).map((e,t)=>(0,s.jsxs)("div",{className:"rounded-2xl border border-slate-200 p-3",children:[(0,s.jsxs)("div",{className:"flex items-center gap-2",children:[(0,s.jsx)("input",{value:e,list:"reasoner-output-".concat((null==aN?void 0:aN.id)||"unknown"),onChange:e=>an(t,e.target.value),placeholder:"output_field",className:"flex-1 rounded-xl border border-slate-200 px-2 py-1 text-xs"}),(0,s.jsx)("button",{type:"button",onClick:()=>ai(t),className:"rounded-xl border border-rose-200 bg-rose-50 px-2 py-1 text-xs text-rose-600",children:"Remove"})]}),(()=>{var t;let a=e?null==aj?void 0:aj.fieldMap.get(e):null;return e?a?(0,s.jsxs)("div",{className:"mt-2 text-xs text-slate-500",children:[(0,s.jsxs)("p",{children:[a.field.derived?"derived":"base"," - ",a.entity.name]}),(0,s.jsx)("p",{className:"mt-1 text-slate-600",children:M(K,a.entity.name,a.field)}),(null===(t=a.field.depends_on)||void 0===t?void 0:t.length)?(0,s.jsxs)("p",{className:"mt-1 text-slate-400",children:["depends_on: ",a.field.depends_on.join(", ")]}):null]}):(0,s.jsxs)("p",{className:"mt-2 text-xs text-rose-500",children:["Output not found on entity type ",(null==aN?void 0:aN.entity_type)||"generic","."]}):(0,s.jsx)("p",{className:"mt-2 text-xs text-slate-400",children:"Select an output field."})})()]},"".concat(e,"-").concat(t)))]}),(0,s.jsxs)("div",{className:"mt-3 flex items-center justify-between",children:[(0,s.jsx)("p",{className:"text-xs font-semibold uppercase tracking-[0.2em] text-slate-400",children:"Signals"}),(0,s.jsx)("button",{type:"button",onClick:ac,className:"rounded-full border border-slate-200 bg-white px-3 py-1 text-xs font-semibold text-slate-600",children:"+ Signal"})]}),(0,s.jsxs)("div",{className:"space-y-3",children:[0===eK.length&&(0,s.jsx)("p",{className:"text-xs text-slate-500",children:"No signals yet."}),eK.map((e,t)=>{var a;return(0,s.jsx)("div",{className:"rounded-2xl border border-slate-200 p-3",children:(0,s.jsxs)("div",{className:"grid grid-cols-2 gap-2",children:[(0,s.jsx)("input",{value:e.name,onChange:e=>al(t,{name:e.target.value}),placeholder:"name",className:"rounded-xl border border-slate-200 px-2 py-1 text-xs"}),(0,s.jsx)("input",{value:e.metric_field,onChange:e=>al(t,{metric_field:e.target.value}),placeholder:"metric_field",className:"rounded-xl border border-slate-200 px-2 py-1 text-xs"}),(0,s.jsx)("input",{value:e.threshold,type:"number",onChange:e=>al(t,{threshold:Number(e.target.value)||0}),placeholder:"threshold",className:"rounded-xl border border-slate-200 px-2 py-1 text-xs"}),(0,s.jsxs)("select",{value:e.direction,onChange:e=>al(t,{direction:e.target.value}),className:"rounded-xl border border-slate-200 px-2 py-1 text-xs",children:[(0,s.jsx)("option",{value:"below",children:"below"}),(0,s.jsx)("option",{value:"above",children:"above"}),(0,s.jsx)("option",{value:"equals",children:"equals"})]}),(0,s.jsx)("input",{value:null!==(a=e.weight)&&void 0!==a?a:"",type:"number",onChange:e=>al(t,{weight:""===e.target.value?void 0:Number(e.target.value)}),placeholder:"weight",className:"rounded-xl border border-slate-200 px-2 py-1 text-xs"}),(0,s.jsx)("button",{type:"button",onClick:()=>ax(t),className:"rounded-xl border border-rose-200 bg-rose-50 px-2 py-1 text-xs text-rose-600",children:"Remove"})]})},"".concat(e.name,"-").concat(t))})]}),(0,s.jsx)("button",{type:"button",onClick:t2,className:"w-full rounded-2xl bg-slate-900 px-3 py-2 text-sm font-semibold text-white shadow",children:"Apply reasoner rules"})]})]})]}):(0,s.jsx)("p",{className:"mt-4 text-sm text-slate-500",children:"Select a node to edit details."})]})})]})]})}}},function(e){e.O(0,[892,971,117,744],function(){return e(e.s=8354)}),_N_E=e.O()}]);