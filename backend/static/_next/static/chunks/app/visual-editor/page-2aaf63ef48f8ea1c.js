(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[213],{8354:function(e,t,a){Promise.resolve().then(a.bind(a,9392))},9392:function(e,t,a){"use strict";a.r(t),a.d(t,{default:function(){return B}});var s=a(7437),l=a(2265),r=a(2892);let n={entity:!0,derived:!0,reasoner:!0,kg:!0,graph:!0},i={data:["entity","derived"],kg:["kg","graph","reasoner"]},o={entity:"from-[#0f172a] to-[#1e293b] text-white",derived:"from-[#0f766e] to-[#14b8a6] text-white",reasoner:"from-[#b45309] to-[#f59e0b] text-white",kg:"from-[#1e3a8a] to-[#3b82f6] text-white",graph:"from-[#111827] to-[#4b5563] text-white"},d={relation:"#0ea5e9",derived:"#14b8a6",reasoner:"#f59e0b",reasoner_signal:"#f97316",reasoner_output:"#ec4899",dependency:"#64748b",kg:"#22c55e",graph:"#6366f1"},c=["summary_full","summary_full_single","summary_chunk","summary_reduce"],p=(e,t)=>"derived::".concat(e,"::").concat(t),x=e=>"reasoner::".concat(e),m=e=>"kg::".concat(e),u=e=>"graph::".concat(e),h=e=>e?{entities:e.entities||[],relationships:(e.relationships||[]).map(e=>({...e,join_on:Array.isArray(e.join_on)?e.join_on:[]})),reasoners:e.reasoners||[],derived_rel_rules:e.derived_rel_rules||[],prompt_templates:e.prompt_templates||{},analysis_config:e.analysis_config||{},config:e.config||{},kg:e.kg||{nodes:[],edges:[],graphs:[]}}:{entities:[],relationships:[],reasoners:[],derived_rel_rules:[],prompt_templates:{},analysis_config:{},config:{},kg:{nodes:[],edges:[],graphs:[]}},f=e=>{let t=(e.join_on||[]).filter(e=>Array.isArray(e)&&e.length>=2).map(e=>"".concat(e[0],"=").concat(e[1])).join(", ");return t?t.length<=80?t:"".concat(t.slice(0,77),"..."):""},g=e=>{let t=(e.join_on||[]).filter(e=>Array.isArray(e)&&e.length>=2).map(e=>"".concat(e[0],"=").concat(e[1])).join(", ");return t?t.length<=80?t:"".concat(t.slice(0,77),"..."):e.name||""},b=e=>(null==e?void 0:e.type)==="graph_reasoner",y=e=>{let t=h(e),a=[],s=[],l=new Set,r=new Map,n=t.derived_rel_rules||[],i=t.kg||{},o=Array.isArray(i.nodes)?i.nodes:[],d=Array.isArray(i.edges)?i.edges:[],c=Array.isArray(i.graphs)?i.graphs:[],y=new Set(c.map(e=>String((null==e?void 0:e.id)||"").trim()).filter(Boolean)),v=e=>{l.has(e.id)||(l.add(e.id),s.push(e))},N=[],j=[],w=[],k=[],_=[],S=new Map,C=new Map,M=new Map,E=(e,t,a)=>{let s="".concat(e,"::").concat(t),l=M.get(s)||[];l.includes(a)||(l.push(a),M.set(s,l))};t.reasoners.forEach(e=>{if(b(e))return;let a=e.outputs||[];a.length&&t.entities.forEach(t=>{((t.applicable_reasoners||[]).includes(e.id)||t.entity_type&&t.entity_type===e.entity_type)&&a.forEach(a=>{let s=(t.fields||[]).find(e=>e.name===a);s&&s.derived&&(E(t.name,a,e.id),v({id:"reasoner-output:".concat(e.id,":").concat(t.name,":").concat(a),from:x(e.id),to:p(t.name,a),label:"output",type:"reasoner_output"}))})})}),t.entities.forEach(e=>{r.set(e.name,e),N.push({id:e.name,label:e.name,kind:"entity",description:e.description||"",tags:[e.entity_type||"entity",e.table||""].filter(Boolean),inputs:e.join_keys||[],outputs:(e.fields||[]).map(e=>e.name),x:0,y:0,ref:{type:"entity",entityName:e.name}});let t=(e.fields||[]).filter(e=>e.derived);t.filter(e=>e.derived).forEach(t=>{let a=(M.get("".concat(e.name,"::").concat(t.name))||[]).length?["reasoner-output"]:[],s=n.some(a=>a.entity===e.name&&a.field===t.name);j.push({id:p(e.name,t.name),label:t.name,kind:"derived",description:t.description||"",tags:["derived",t.default_agg||t.role,s?"rule:ok":"rule:missing",...a].filter(Boolean),inputs:t.depends_on||[],outputs:[t.name],x:0,y:0,ref:{type:"derived",entityName:e.name,fieldName:t.name}}),v({id:"derived:".concat(e.name,":").concat(t.name),from:e.name,to:p(e.name,t.name),label:"derived",type:"derived"})}),t.forEach(a=>{(a.depends_on||[]).forEach(s=>{t.some(e=>e.name===s)&&v({id:"dep:".concat(e.name,":").concat(s,":").concat(a.name),from:p(e.name,s),to:p(e.name,a.name),label:"depends_on",type:"dependency"})})})}),t.reasoners.forEach(e=>{let t=String(e.graph_id||"").trim(),a=t?"graph:".concat(t):"graph:unbound",s=t&&!y.has(t)?"graph:missing":"",l=b(e)?"graph-reasoner":"legacy-reasoner";w.push({id:x(e.id),label:e.name||e.id,kind:"reasoner",description:e.description||"",tags:["reasoner",l,e.entity_type,a,s].filter(Boolean),inputs:(e.signals||[]).map(e=>e.metric_field),outputs:e.outputs||[],x:0,y:0,ref:{type:"reasoner",reasonerId:e.id}})}),o.forEach(e=>{if(!e||"object"!=typeof e)return;let t=String(e.entity||"").trim();if(!t)return;let a=String(e.node_type||"node"),s=e.key_field,l=Array.isArray(s)?s.map(e=>String(e)).filter(Boolean):s?[String(s)]:[],r=e.label_field?String(e.label_field):"",n=Array.isArray(e.properties)?e.properties.map(e=>String(e)).filter(Boolean):[],i=m(t);S.set(t,i),k.push({id:i,label:t,kind:"kg",description:e.description||"KG node: ".concat(a),tags:["kg",a].filter(Boolean),inputs:l,outputs:[r,...n].filter(Boolean),x:0,y:0,ref:{type:"kg",entityName:t}})}),d.forEach(e=>{if(!e||"object"!=typeof e)return;let t=String(e.from_entity||"").trim(),a=String(e.to_entity||"").trim();if(!t||!a)return;let s=S.get(t),l=S.get(a);s&&l&&v({id:"kg:".concat(e.name||"edge",":").concat(t,":").concat(a),from:s,to:l,label:g(e),type:"kg"})});let O=e=>e?S.get(e)||(r.has(e)?e:""):"";return c.forEach(e=>{if(!e||!e.id)return;let t=String(e.id).trim();if(!t)return;let a=u(t);C.set(t,a),_.push({id:a,label:t,kind:"graph",description:e.description||"",tags:["graph",!1===e.directed?"undirected":"directed"].filter(Boolean),inputs:[],outputs:[],x:0,y:0,ref:{type:"graph",graphId:t}}),(e.nodes||[]).forEach(e=>{if(!(null==e?void 0:e.entity))return;let s=O(String(e.entity||"").trim());s&&v({id:"graph:".concat(t,":node:").concat(e.entity),from:a,to:s,label:"node",type:"graph"})}),(e.edges||[]).forEach(e=>{let s=((null==e?void 0:e.relation)||"").toString();if(!s||!s.includes("."))return;let[l,r]=s.split(".",2),n=O(String(l||"").trim());n&&v({id:"graph:".concat(t,":edge:").concat(s),from:a,to:n,label:r||"edge",type:"graph"})})}),t.reasoners.forEach(e=>{if(!b(e))return;let t=String(e.graph_id||"").trim();if(!t)return;let a=C.get(t);a&&v({id:"reasoner-graph:".concat(e.id,":").concat(t),from:x(e.id),to:a,label:"uses graph",type:"graph"})}),t.relationships.forEach(e=>{r.has(e.from_entity)&&r.has(e.to_entity)&&v({id:"rel:".concat(e.name,":").concat(e.from_entity,":").concat(e.to_entity),from:e.from_entity,to:e.to_entity,label:f(e),type:"relation"})}),t.entities.forEach(e=>{t.reasoners.forEach(t=>{((e.applicable_reasoners||[]).includes(t.id)||e.entity_type&&e.entity_type===t.entity_type)&&v({id:"reasoner:".concat(e.name,":").concat(t.id),from:e.name,to:x(t.id),label:t.id,type:"reasoner"})})}),t.reasoners.forEach(e=>{let a=e.signals||[];a.length&&t.entities.forEach(t=>{if(!((t.applicable_reasoners||[]).includes(e.id)||t.entity_type&&t.entity_type===e.entity_type))return;let s=new Set((t.fields||[]).filter(e=>e.derived).map(e=>e.name));a.forEach(a=>{let l=(a.metric_field||"").trim();if(!l)return;let r=null,n=l;if(l.includes(".")){let e=l.split(".");r=e.slice(0,-1).join("."),n=e[e.length-1]}(!r||r===t.name)&&s.has(n)&&v({id:"reasoner-signal:".concat(t.name,":").concat(n,":").concat(e.id),from:p(t.name,n),to:x(e.id),label:a.name||n,type:"reasoner_signal"})})})}),a.push(...N,...k,..._,...j,...w),{nodes:a,edges:s}},v=(e,t)=>{let a=["entity","kg","graph","derived","reasoner"],s=[...e].sort((e,t)=>{let s=a.indexOf(e.kind)-a.indexOf(t.kind);return 0!==s?s:e.label.localeCompare(t.label)}),l={entity:0,kg:0,graph:0,derived:0,reasoner:0},r={entity:120,kg:380,graph:640,derived:900,reasoner:1160};return s.map(e=>{let a=t.get(e.id);if(a)return{...e,x:a.x,y:a.y};let s=l[e.kind]++;return{...e,x:r[e.kind],y:90+190*s}})},N=(e,t)=>{let a=e.filter(e=>"entity"===e.kind),s=new Map(a.map(e=>[e.id,e])),l=new Map;a.forEach(e=>l.set(e.id,new Set)),t.filter(e=>"relation"===e.type).forEach(e=>{l.has(e.from)&&l.has(e.to)&&(l.get(e.from).add(e.to),l.get(e.to).add(e.from))});let r=new Map,n=new Set,i=90;return[...a].sort((e,t)=>{var a,s;let r=(null===(a=l.get(e.id))||void 0===a?void 0:a.size)||0,n=(null===(s=l.get(t.id))||void 0===s?void 0:s.size)||0;return r!==n?n-r:e.label.localeCompare(t.label)}).forEach(e=>{if(n.has(e.id))return;let t=[e.id],a=[];for(n.add(e.id);t.length;){let e=t.shift();a.push(e),(l.get(e)||new Set).forEach(e=>{n.has(e)||(n.add(e),t.push(e))})}let o=a.map(e=>{var t,a;return{id:e,degree:(null===(t=l.get(e))||void 0===t?void 0:t.size)||0,label:(null===(a=s.get(e))||void 0===a?void 0:a.label)||e}}).sort((e,t)=>t.degree-e.degree||e.label.localeCompare(t.label))[0],d=new Map,c=[o.id];for(d.set(o.id,0);c.length;){let e=c.shift(),t=d.get(e)||0;(l.get(e)||new Set).forEach(e=>{d.has(e)||(d.set(e,t+1),c.push(e))})}a.forEach(e=>{d.has(e)||d.set(e,0)});let p=new Map;d.forEach((e,t)=>{let a=p.get(e)||[];a.push(t),p.set(e,a)});let x=i;Array.from(p.keys()).sort((e,t)=>e-t).forEach(e=>{let t=p.get(e)||[];t.sort((e,t)=>{var a,l;let r=(null===(a=s.get(e))||void 0===a?void 0:a.label)||e,n=(null===(l=s.get(t))||void 0===l?void 0:l.label)||t;return r.localeCompare(n)}),t.forEach((t,a)=>{let s=i+180*a;r.set(t,{x:120+320*e,y:s}),s>x&&(x=s)})}),i=x+220}),e.map(e=>{if("entity"===e.kind){let t=r.get(e.id);if(t)return{...e,x:t.x,y:t.y}}return e})},j=(e,t)=>{let a=new Map(t.map(e=>[e.id,{x:e.x,y:e.y}]));return e.map(e=>{let t=a.get(e.id);return t&&(e.x!==t.x||e.y!==t.y)?{...e,x:t.x,y:t.y}:e})},w=(e,t)=>{let a=1,s=e;for(;t.has(s);)a+=1,s="".concat(e,"_").concat(a);return s},k=(e,t,a)=>Math.min(a,Math.max(t,e)),_=e=>e.map(e=>{let[t,a]=e;return"".concat(t,"=").concat(a)}).join("\n"),S=e=>e.split(/\n+/).map(e=>e.trim()).filter(Boolean).map(e=>e.split(/[=,:]/).map(e=>e.trim())).filter(e=>e.length>=2&&e[0]&&e[1]).map(e=>[e[0],e[1]]),C=new Set(["select","from","where","case","when","then","else","end","and","or","not","nullif","coalesce","lag","lead","over","partition","order","by","as","in","on","join","left","right","inner","outer","sum","avg","min","max","count","year","month","date_from_parts"].map(e=>e.toLowerCase())),M=(e,t,a)=>{let s=[...e.match(/[A-Za-z_][A-Za-z0-9_]*(?:\.[A-Za-z_][A-Za-z0-9_]*)+/g)||[],...e.match(/[A-Za-z_][A-Za-z0-9_]*/g)||[]],l=new Set(t.map(e=>e.toLowerCase())),r=(a||"").toLowerCase(),n=new Set;return s.forEach(e=>{var t;let a=(null===(t=e.split(".").pop())||void 0===t?void 0:t.toLowerCase())||"";l.has(a)&&a!==r&&(C.has(a)||n.add(a))}),Array.from(n)},E=[{label:"number",value:"number"},{label:"string",value:"varchar"},{label:"date",value:"date"},{label:"timestamp",value:"timestamp"},{label:"boolean",value:"boolean"}],O=["","sum","avg","min","max","last"],A=(e,t)=>Array.from(new Set([...e,...(t||[]).map(e=>e.field).filter(Boolean)])),R=(e,t,a)=>e&&(e.derived_rel_rules||[]).find(e=>e.entity===t&&e.field===a)||null,J=(e,t)=>{let a=(e.derived_rel_rules||[]).filter(e=>!(e.entity===t.entity&&e.field===t.field));return a.push(t),a},D=e=>{if(!e||!Array.isArray(e.rules))return"";let t=e.rules.map(e=>{let t=String(e.expr||"").trim();if(!t)return"";let a=String(e.when||"").trim();return a?"".concat(a," -> ").concat(t):t}).filter(Boolean).join("; ");return t?t.length>200?"".concat(t.slice(0,197),"..."):t:""},I=(e,t,a)=>{let s=String(a.expr||"").trim();if(s)return s;let l=D(R(e,t,a.name));return l?"rule: ".concat(l):"No expression."},G=(e,t,a)=>({entity:e,field:t,rules:[{expr:a}]}),L=(e,t,a)=>M((e.rules||[]).map(e=>[e.expr,e.when].filter(Boolean).join(" ")).join(" "),t,a),T=e=>{let t=(e||"").toLowerCase();return["char","text","string","varchar","date","time","timestamp","boolean"].some(e=>t.includes(e))?"dimension":"metric"},P=(e,t)=>{let a=(e||"").toLowerCase(),s=(t||"").toLowerCase();return["percent","pct","ratio","rate","avg","mean","score","trend"].some(e=>a.includes(e))?"avg":["float","number","decimal","numeric","int"].some(e=>s.includes(e))?"sum":""},K=e=>[e.database,e.schema,e.table].filter(Boolean).join(".");function B(){var e,t,a,m,f,g,C,D,B,F,q,Y,z,U,X,Q,V,W,Z,H,$,ee,et,ea,es,el,er,en,ei,eo;let ed=(0,l.useRef)(null),ec=(0,l.useRef)(null),ep=(0,l.useMemo)(()=>"/",[]),[ex,em]=(0,l.useState)(null),[eu,eh]=(0,l.useState)([]),[ef,eg]=(0,l.useState)([]),[eb,ey]=(0,l.useState)(null),[ev,eN]=(0,l.useState)(null),[ej,ew]=(0,l.useState)(null),[ek,e_]=(0,l.useState)("data"),[eS,eC]=(0,l.useState)(n),[eM,eE]=(0,l.useState)(""),[eO,eA]=(0,l.useState)(""),[eR,eJ]=(0,l.useState)(""),[eD,eI]=(0,l.useState)(!1),[eG,eL]=(0,l.useState)(""),[eT,eP]=(0,l.useState)(""),[eK,eB]=(0,l.useState)(""),[eF,eq]=(0,l.useState)(""),[eY,ez]=(0,l.useState)(1),[eU,eX]=(0,l.useState)({x:0,y:0}),[eQ,eV]=(0,l.useState)(null),[eW,eZ]=(0,l.useState)(!1),[eH,e$]=(0,l.useState)(""),[e0,e2]=(0,l.useState)(""),[e1,e3]=(0,l.useState)(""),[e6,e4]=(0,l.useState)(""),[e5,e9]=(0,l.useState)(""),[e7,e8]=(0,l.useState)([]),[te,tt]=(0,l.useState)(""),[ta,ts]=(0,l.useState)(""),[tl,tr]=(0,l.useState)(!1),[tn,ti]=(0,l.useState)(""),[to,td]=(0,l.useState)([]),[tc,tp]=(0,l.useState)(""),[tx,tm]=(0,l.useState)(""),[tu,th]=(0,l.useState)(""),[tf,tg]=(0,l.useState)(""),[tb,ty]=(0,l.useState)(!0),[tv,tN]=(0,l.useState)(!1),[tj,tw]=(0,l.useState)(""),[tk,t_]=(0,l.useState)(""),[tS,tC]=(0,l.useState)(""),[tM,tE]=(0,l.useState)(""),[tO,tA]=(0,l.useState)(""),[tR,tJ]=(0,l.useState)(""),[tD,tI]=(0,l.useState)("5"),[tG,tL]=(0,l.useState)(""),[tT,tP]=(0,l.useState)(""),[tK,tB]=(0,l.useState)(null),[tF,tq]=(0,l.useState)("base"),[tY,tz]=(0,l.useState)(!1),[tU,tX]=(0,l.useState)(!0),[tQ,tV]=(0,l.useState)([]),[tW,tZ]=(0,l.useState)(null),[tH,t$]=(0,l.useState)("add"),[t0,t2]=(0,l.useState)({}),[t1,t3]=(0,l.useState)(null),[t6,t4]=(0,l.useState)({entities:{},relationships:{},reasoners:{}}),t5=(0,l.useRef)(""),t9=(0,l.useMemo)(()=>eu.length?{width:Math.max(Math.max(...eu.map(e=>e.x+240))+420,1600),height:Math.max(Math.max(...eu.map(e=>e.y+148))+420,900)}:{width:1600,height:900},[eu]),t7=(0,l.useMemo)(()=>eu.find(e=>e.id===eb)||null,[eu,eb]),t8=(0,l.useMemo)(()=>eu.find(e=>e.id===t1)||null,[t1,eu]),ae=(0,l.useMemo)(()=>{var e,t,a,s;let l=h(ex);return{entities:l.entities,reasoners:l.reasoners,relationships:l.relationships,entityMap:new Map(l.entities.map(e=>[e.name,e])),reasonerMap:new Map(l.reasoners.map(e=>[e.id,e])),kgNodes:(null===(e=l.kg)||void 0===e?void 0:e.nodes)||[],kgEdges:(null===(t=l.kg)||void 0===t?void 0:t.edges)||[],kgGraphs:(null===(a=l.kg)||void 0===a?void 0:a.graphs)||[],kgNodeMap:new Map(((null===(s=l.kg)||void 0===s?void 0:s.nodes)||[]).filter(e=>e&&"object"==typeof e&&e.entity).map(e=>[String(e.entity),e]))}},[ex]);(0,l.useEffect)(()=>{ex&&eP(JSON.stringify(ex.kg||{nodes:[],edges:[],graphs:[]},null,2))},[null==ex?void 0:ex.kg]);let at=(0,l.useMemo)(()=>(null==ex?void 0:ex.prompt_templates)||{},[ex]),aa=(0,l.useMemo)(()=>[...c].sort(),[]),as=(0,l.useMemo)(()=>{var e,t,a,s,l;let r=((null==ex?void 0:ex.analysis_config)||{}).prompt_context;return{business:String(null!==(t=null!==(e=null==r?void 0:r.business_context)&&void 0!==e?e:null==r?void 0:r.business)&&void 0!==t?t:""),data:String(null!==(s=null!==(a=null==r?void 0:r.data_context)&&void 0!==a?a:null==r?void 0:r.data)&&void 0!==s?s:""),expectations:String(null!==(l=null==r?void 0:r.expectations)&&void 0!==l?l:"")}},[ex]),al=(0,l.useCallback)(()=>{if(ex)try{let e=JSON.parse(eT||"{}");if(!e||"object"!=typeof e){eB("KG config must be a JSON object.");return}em({...ex,kg:e}),eB("KG config applied.")}catch(e){eB((null==e?void 0:e.message)||"Failed to parse KG JSON.")}},[eT,ex]),ar=(0,l.useCallback)(()=>{if(!ex||!(null==t7?void 0:t7.ref.graphId))return;let e=[],t=[];try{let a=tj.trim()?JSON.parse(tj):[],s=tk.trim()?JSON.parse(tk):[];if(!Array.isArray(a)||!Array.isArray(s)){tC("Graph nodes/edges must be JSON arrays.");return}e=a,t=s}catch(e){tC((null==e?void 0:e.message)||"Invalid graph JSON.");return}let a=ex.kg||{nodes:[],edges:[],graphs:[]},s=(Array.isArray(a.graphs)?a.graphs:[]).map(a=>a.id===t7.ref.graphId?{...a,description:tf,directed:tb,weighted:tv,nodes:e,edges:t}:a);em({...ex,kg:{...a,graphs:s}}),tC("Graph config applied.")},[ex,t7,tj,tk,tf,tb,tv]),an=(0,l.useCallback)((e,t)=>{var a,s,l,r,n;if(!ex)return;let i={...ex.analysis_config||{}},o=i.prompt_context||{},d={business_context:String(null!==(s=null!==(a=o.business_context)&&void 0!==a?a:o.business)&&void 0!==s?s:""),data_context:String(null!==(r=null!==(l=o.data_context)&&void 0!==l?l:o.data)&&void 0!==r?r:""),expectations:String(null!==(n=o.expectations)&&void 0!==n?n:"")};"business"===e&&(d.business_context=t),"data"===e&&(d.data_context=t),"expectations"===e&&(d.expectations=t),i.prompt_context=d,em({...ex,analysis_config:i})},[ex]),ai=(0,l.useCallback)(e=>{if(!ex)return;let t={...ex.prompt_templates||{}};e in t&&(delete t[e],em({...ex,prompt_templates:t}))},[ex]),ao=(0,l.useCallback)(()=>{if(!ex)return;let e={...ex.prompt_templates||{}};c.forEach(t=>{delete e[t]}),em({...ex,prompt_templates:e}),eJ("Prompt templates reset to defaults.")},[ex]),ad=(0,l.useCallback)(async()=>{if(ex){if(!(as.business.trim()||as.data.trim()||as.expectations.trim())){eJ("Add business/data/expectations to generate prompts.");return}eI(!0),eJ("Generating prompt templates...");try{let e=await fetch("".concat(ep,"/api/registry/prompts/customize"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({business_context:as.business,data_context:as.data,expectations:as.expectations,prompt_keys:c})});if(!e.ok){eJ("Prompt generation failed.");return}let t=(await e.json()).templates||{},a={...ex.prompt_templates||{},...t};em({...ex,prompt_templates:a}),eJ("Prompt templates generated.")}catch(e){eJ("Prompt generation failed.")}finally{eI(!1)}}},[ep,as.business,as.data,as.expectations,ex]),ac=(0,l.useCallback)(async()=>{if(ex){eB("Generating KG config..."),eI(!0);try{let e=await fetch("".concat(ep,"/api/registry/kg/generate"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({registry:ex,instructions:eO})});if(!e.ok){eB("KG generation failed.");return}let t=(await e.json()).kg||{};em({...ex,kg:t}),eP(JSON.stringify(t,null,2)),eB("KG config generated.")}catch(e){eB((null==e?void 0:e.message)||"KG generation failed.")}finally{eI(!1)}}},[ep,ex,eO]),ap=(0,l.useMemo)(()=>{if(!tW)return{entities:[],relationships:[],reasoners:[]};let e=h(ex),t=(e,t)=>JSON.stringify(e)!==JSON.stringify(t),a=(e,t)=>new Map(e.map(e=>[String(e[t]||""),e])),s=a(e.entities,"name"),l=a(e.relationships,"name"),r=a(e.reasoners,"id");return{entities:(tW.entities||[]).map(e=>({name:e.name,status:s.has(e.name)?t(s.get(e.name),e)?"update":"same":"add"})),relationships:(tW.relationships||[]).map(e=>({name:e.name,status:l.has(e.name)?t(l.get(e.name),e)?"update":"same":"add"})),reasoners:(tW.reasoners||[]).map(e=>({name:e.id,status:r.has(e.id)?t(r.get(e.id),e)?"update":"same":"add"}))}},[tW,ex]),ax=(0,l.useMemo)(()=>{let e=new Set;return((null==ex?void 0:ex.relationships)||[]).forEach(t=>{e.add(t.from_entity),e.add(t.to_entity)}),e},[ex]),am=(0,l.useMemo)(()=>i[ek],[ek]),au="data"===ek&&tY,ah=(0,l.useCallback)(e=>{eC(t=>{let a={...t};return Object.keys(a).forEach(e=>{a[e]=!1}),e.forEach(e=>{a[e]=!0}),a})},[]);(0,l.useEffect)(()=>{ah(am),"kg"===ek&&tz(!1)},[ek,am,ah]);let af=(0,l.useMemo)(()=>{if(!t1||!eu.some(e=>e.id===t1))return null;let e=new Map,t=new Map,a=(a,s)=>{e.has(a)||e.set(a,new Set),t.has(s)||t.set(s,new Set),e.get(a).add(s),t.get(s).add(a)};ef.forEach(e=>{a(e.from,e.to),"relation"===e.type&&a(e.to,e.from)});let s=(e,t)=>{let a=new Set,s=[e];for(a.add(e);s.length;){let e=s.pop(),l=t.get(e);l&&l.forEach(e=>{a.has(e)||(a.add(e),s.push(e))})}return a};return{nodes:new Set([...s(t1,e)||[],...s(t1,t)||[]])}},[ef,t1,eu]),ag=(0,l.useMemo)(()=>{let e;if(au){let t=eu.filter(e=>"entity"===e.kind);e=0===ax.size?t:t.filter(e=>ax.has(e.id))}else e=eu.filter(e=>eS[e.kind]);return("kg"===ek&&(e=e.filter(e=>"reasoner"!==e.kind||e.tags.includes("graph-reasoner"))),af)?e.filter(e=>af.nodes.has(e.id)):e},[ek,af,au,ax,eu,eS]),ab=(0,l.useMemo)(()=>new Set(ag.map(e=>e.id)),[ag]),ay=(0,l.useMemo)(()=>am.filter(e=>eS[e]),[am,eS]),av=(0,l.useMemo)(()=>ay.length===am.length&&am.length>0,[ay.length,am.length]),aN=(0,l.useMemo)(()=>av?"all":ay.join(", "),[ay,av]),aj=(0,l.useMemo)(()=>{if(!ex)return[];let e=[],t=new Map(ex.entities.map(e=>[e.name,e]));ex.reasoners.map(e=>e.id),ex.entities.forEach(t=>{let a=new Set(t.fields.map(e=>e.name));t.fields.forEach(s=>{let l=(s.dtype||"").toLowerCase();if(l&&"any"!==l&&"unknown"!==l||e.push({level:"warn",message:"Missing dtype for ".concat(t.name,".").concat(s.name)}),s.derived&&(s.depends_on||[]).forEach(l=>{a.has(l)||e.push({level:"error",message:"Missing dependency ".concat(l," for ").concat(t.name,".").concat(s.name)})}),"last"===s.default_agg){let l=s.order_by||[];l.length||e.push({level:"warn",message:"Missing order_by for ".concat(t.name,".").concat(s.name," (last agg)")}),l.forEach(l=>{l.field&&!a.has(l.field)&&e.push({level:"error",message:"Invalid order_by ".concat(l.field," for ").concat(t.name,".").concat(s.name)})})}})}),ex.relationships.forEach(a=>{let s=t.get(a.from_entity),l=t.get(a.to_entity);if(!s||!l){e.push({level:"error",message:"Relationship ".concat(a.name," references missing entity")});return}if(!a.join_on||0===a.join_on.length){e.push({level:"error",message:"Relationship ".concat(a.name," is missing join_on pairs")});return}let r=new Set(s.fields.map(e=>e.name)),n=new Set(l.fields.map(e=>e.name));(a.join_on||[]).forEach(t=>{let[s,l]=t;r.has(s)&&n.has(l)||e.push({level:"error",message:"Invalid join ".concat(a.name,": ").concat(s,"=").concat(l)})})});let a=new Set(ex.entities.map(e=>e.entity_type));return ex.reasoners.forEach(t=>{if(b(t)){t.graph_id||e.push({level:"warn",message:"Graph reasoner ".concat(t.id," missing graph_id")});return}ex.entities.some(e=>(e.applicable_reasoners||[]).includes(t.id))||a.has(t.entity_type)||e.push({level:"warn",message:"Orphan reasoner ".concat(t.id)})}),ex.entities.forEach(t=>{let a=ex.relationships.some(e=>e.from_entity===t.name||e.to_entity===t.name),s=(t.applicable_reasoners||[]).length>0;a||s||e.push({level:"warn",message:"Unused entity ".concat(t.name)})}),e},[ex]),aw=(0,l.useMemo)(()=>{if(!t7||"derived"!==t7.kind)return null;let e=ef.filter(e=>"dependency"===e.type),t=new Set,a=new Set,s=new Set,l=new Map,r=new Map;e.forEach(e=>{l.set(e.from,[...l.get(e.from)||[],e.to]),r.set(e.to,[...r.get(e.to)||[],e.from])});let n=(e,t,a)=>{let s=[e];for(;s.length;){let e=s.pop();(t.get(e)||[]).forEach(e=>{a.has(e)||(a.add(e),s.push(e))})}};return n(t7.id,l,a),n(t7.id,r,t),e.forEach(e=>{(e.from===t7.id||t.has(e.from)||a.has(e.from))&&(e.to===t7.id||t.has(e.to)||a.has(e.to))&&s.add(e.id)}),{nodes:new Set([t7.id,...t,...a]),edges:s}},[ef,t7]),ak=(0,l.useCallback)(e=>{let t=ed.current;if(!t||0===e.length)return;let a=t.getBoundingClientRect(),s=Math.min(...e.map(e=>e.x)),l=Math.min(...e.map(e=>e.y)),r=Math.max(...e.map(e=>e.x+240)),n=Math.max(...e.map(e=>e.y+148)),i=Math.max(1,r-s),o=Math.max(1,n-l),d=k(Math.min((a.width-120)/i,(a.height-120)/o),.4,1.6),c=(a.width-i*d)/2-s*d,p=(a.height-o*d)/2-l*d;ez(d),eX({x:c,y:p})},[]),a_=function(e){let t=!(arguments.length>1)||void 0===arguments[1]||arguments[1],a=h(e),{nodes:s,edges:l}=y(a),r=v(s,t?new Map(eu.map(e=>[e.id,{x:e.x,y:e.y}])):new Map);if(em(a),eh(r),eg(l),t||requestAnimationFrame(()=>ak(r)),!r.some(e=>e.id===eb)){var n;ey((null===(n=r[0])||void 0===n?void 0:n.id)||null)}},aS=(0,l.useCallback)(()=>{if(!tn.trim()){eJ("Paste registry JSON to import.");return}try{let e=JSON.parse(tn);if(!e||"object"!=typeof e){eJ("Registry JSON is invalid.");return}a_(e,!1),tZ(null),eJ("Registry imported from JSON.")}catch(e){eJ("Registry JSON is invalid.")}},[tn]),aC=async()=>{eI(!0),eJ("Loading registry...");try{let e=await fetch("".concat(ep,"/api/registry/load"));if(!e.ok){eJ("Failed to load registry.");return}let t=await e.json();if(eL(t.path||""),t.registry){a_(t.registry,!1);let e=t.source||(t.exists?"file":"active");eJ("Registry loaded (".concat(e,").")),tZ(null),t5.current=JSON.stringify(t.registry)}else em(null),eh([]),eg([]),eJ("No registry data available yet.");await aM()}catch(e){eJ("Registry load failed.")}finally{eI(!1)}},aM=async()=>{try{let e=await fetch("".concat(ep,"/api/registry/versions"));if(!e.ok)return;let t=await e.json();tV(t.versions||[])}catch(e){}},aE=async()=>{eI(!0),eJ("Reloading API registry...");try{if(!(await fetch("".concat(ep,"/api/registry/reload"),{method:"POST"})).ok){eJ("Reload failed.");return}eJ("API registry reloaded.")}catch(e){eJ("Reload failed.")}finally{eI(!1)}},aO=async()=>{eI(!0),eJ("Rebuilding KG...");try{var e,t;let a=await fetch("".concat(ep,"/api/kg/rebuild"),{method:"POST"}),s=await a.json();if(!a.ok){eJ((null==s?void 0:s.detail)||"KG rebuild failed.");return}eJ("KG rebuilt (entities=".concat(null!==(e=null==s?void 0:s.entities)&&void 0!==e?e:0,", reasoners=").concat(null!==(t=null==s?void 0:s.reasoners)&&void 0!==t?t:0,")."))}catch(e){eJ("KG rebuild failed.")}finally{eI(!1)}},aA=async()=>{let e=eM.split(/[\n,]+/).map(e=>e.trim()).filter(Boolean);if(!e.length){eJ("Enter at least one Snowflake table.");return}eI(!0),eJ("Drafting registry from Snowflake...");try{let l=await fetch("".concat(ep,"/api/registry/draft"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({tables:e,instructions:eO})});if(!l.ok){eJ("Draft failed.");return}let r=await l.json();if(r.registry){var t,a,s;(null==ex?void 0:null===(t=ex.entities)||void 0===t?void 0:t.length)||(null==ex?void 0:null===(a=ex.relationships)||void 0===a?void 0:a.length)||(null==ex?void 0:null===(s=ex.reasoners)||void 0===s?void 0:s.length)?(tZ(r.registry),eJ("Draft ready for merge.")):(a_(r.registry,!1),eJ("Draft loaded into canvas."))}else eJ("Draft returned empty registry.")}catch(e){eJ("Draft failed.")}finally{eI(!1)}},aR=async function(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(!ex){e||eJ("Nothing to save yet.");return}e||(eI(!0),eJ("Saving registry..."));try{let t=await fetch("".concat(ep,"/api/registry/save"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({registry:ex})});if(!t.ok){e||eJ("Save failed.");return}let a=await t.json();eL(a.path||""),eq(a.yaml||""),t5.current=JSON.stringify(ex),e||eJ("Registry saved."),await aM(),e||await aE()}catch(t){e||eJ("Save failed.")}finally{e||eI(!1)}};(0,l.useEffect)(()=>{aC()},[ep]),(0,l.useEffect)(()=>{if(!tU||!ex)return;let e=JSON.stringify(ex);if(e===t5.current)return;let t=window.setTimeout(async()=>{t5.current=e,await aR(!0),eJ("Auto-saved.")},1500);return()=>window.clearTimeout(t)},[tU,ex]),(0,l.useEffect)(()=>{if(!eu.length){ey(null);return}eb&&eu.find(e=>e.id===eb)||ey(eu[0].id)},[eu,eb]),(0,l.useEffect)(()=>{if(!tW)return;let e={};ap.entities.forEach(t=>{e[t.name]="same"!==t.status});let t={};ap.relationships.forEach(e=>{t[e.name]="same"!==e.status});let a={};ap.reasoners.forEach(e=>{a[e.name]="same"!==e.status}),t4({entities:e,relationships:t,reasoners:a})},[ap,tW]),(0,l.useEffect)(()=>{if(!ex||!t7){e$(""),e2(""),td([]),tp(""),tm(""),th(""),e3(""),e8([]),e9(""),tt(""),ts(""),e4("");return}if("derived"===t7.kind){let e=ex.entities.find(e=>e.name===t7.ref.entityName),t=null==e?void 0:e.fields.find(e=>e.name===t7.ref.fieldName);e$((null==t?void 0:t.expr)||""),e2(((null==t?void 0:t.depends_on)||[]).join(", "));let a=R(ex,t7.ref.entityName||"",t7.ref.fieldName||"");e3(a?JSON.stringify(a,null,2):""),e8([]),e9(""),tt(""),ts(""),e4(""),td([]),tp(""),tm(""),th("");return}if("reasoner"===t7.kind){let e=ex.reasoners.find(e=>e.id===t7.ref.reasonerId);td((null==e?void 0:e.signals)||[]),tp((null==e?void 0:e.drilldown_plan)?JSON.stringify(e.drilldown_plan,null,2):""),tm(""),th(""),e$(""),e2(""),e3(""),e8([]),e9(""),tt(""),ts(""),e4(""),tg(""),ty(!0),tN(!1),tw(""),t_(""),tC("");return}if("graph"===t7.kind){var e;let t=((null===(e=ex.kg)||void 0===e?void 0:e.graphs)||[]).find(e=>e.id===t7.ref.graphId);tg((null==t?void 0:t.description)||""),ty((null==t?void 0:t.directed)!==!1),tN(!!(null==t?void 0:t.weighted)),tw((null==t?void 0:t.nodes)?JSON.stringify(t.nodes,null,2):"[]"),t_((null==t?void 0:t.edges)?JSON.stringify(t.edges,null,2):"[]"),tC(""),e$(""),e2(""),td([]),tp(""),tm(""),th(""),e3(""),e8([]),e9(""),tt(""),ts(""),e4("");return}e$(""),e2(""),td([]),tp(""),tm(""),th(""),tg(""),ty(!0),tN(!1),tw(""),t_(""),tC(""),e3(""),e8([]),e9(""),tt(""),ts(""),e4("")},[ex,t7]);let aJ=(e,t)=>{let a=ed.current;if(!a)return{x:0,y:0};let s=a.getBoundingClientRect();return{x:(e-s.left-eU.x)/eY,y:(t-s.top-eU.y)/eY}},aD=(e,t)=>{if(e.stopPropagation(),!ed.current)return;let a=eu.find(e=>e.id===t);if(!a)return;let s=aJ(e.clientX,e.clientY);ew({id:t,offsetX:s.x-a.x,offsetY:s.y-a.y})};(0,l.useEffect)(()=>{if(!ej||!ed.current)return;let e=e=>{let t=aJ(e.clientX,e.clientY),a=t.x-ej.offsetX,s=t.y-ej.offsetY;eh(e=>e.map(e=>e.id===ej.id?{...e,x:Math.max(24,a),y:Math.max(24,s)}:e))},t=()=>ew(null);return window.addEventListener("pointermove",e),window.addEventListener("pointerup",t),()=>{window.removeEventListener("pointermove",e),window.removeEventListener("pointerup",t)}},[ej]),(0,l.useEffect)(()=>{if(!eQ)return;let e=e=>{eX({x:eQ.originX+(e.clientX-eQ.startX),y:eQ.originY+(e.clientY-eQ.startY)})},t=()=>eV(null);return window.addEventListener("pointermove",e),window.addEventListener("pointerup",t),()=>{window.removeEventListener("pointermove",e),window.removeEventListener("pointerup",t)}},[eQ]),(0,l.useEffect)(()=>{let e=()=>{eZ(document.fullscreenElement===ec.current),requestAnimationFrame(()=>ak(eu))};return document.addEventListener("fullscreenchange",e),()=>{document.removeEventListener("fullscreenchange",e)}},[ak,eu]);let aI=(0,l.useMemo)(()=>{let e=new Map;ef.forEach(t=>{let a=e.get(t.from)||[];a.push(t),e.set(t.from,a)});let t=new Map;e.forEach(e=>{let a=(e.length-1)/2;e.forEach((e,s)=>{t.set(e.id,(s-a)*10)})});let a=au?ef.filter(e=>"relation"===e.type):ef;return(au||av?a.filter(e=>ab.has(e.from)&&ab.has(e.to)):a.filter(e=>ab.has(e.from)&&ab.has(e.to))).map(e=>{let a=eu.find(t=>t.id===e.from),s=eu.find(t=>t.id===e.to);if(!a||!s)return null;let l=a.y+74,r=s.y+74,n=a.x+120,i=s.x+120-n,o=t.get(e.id)||0,d=0,c=0,p=0,x=0;if(144>Math.abs(i)){d=a.x+240+0,c=s.x+240+0;let e=Math.max(a.x,s.x)+240+140+o;p=e,x=e}else if(i>0){d=a.x+240+0,c=s.x-0;let e=Math.min(160,.4*Math.abs(i));p=d+e+o,x=c-e+o}else{d=a.x-0,c=s.x+240+0;let e=Math.min(160,.4*Math.abs(i));p=d-e+o,x=c+e+o}let m="M ".concat(d," ").concat(l," C ").concat(p," ").concat(l,", ").concat(x," ").concat(r,", ").concat(c," ").concat(r),u=(d+c)/2,h=(l+r)/2-12;return{...e,path:m,labelX:u,labelY:h}}).filter(Boolean)},[av,ef,au,eu,ab]),aG=e=>{eN(e)},aL=()=>t3(null),aT=e=>{let t=e.target;null!=t&&t.closest('[data-node="true"]')||aL()},aP=(e,t)=>{if((null==t?void 0:t.detail)===2||(null==t?void 0:t.shiftKey)){aK(e);return}if(ev&&ev!==e){let t=eu.find(e=>e.id===ev),a=eu.find(t=>t.id===e);if((null==t?void 0:t.kind)==="entity"&&(null==a?void 0:a.kind)==="entity"&&ex){let e=ae.entityMap.get(t.id),s=ae.entityMap.get(a.id),l=((null==e?void 0:e.join_keys)||[]).filter(e=>((null==s?void 0:s.join_keys)||[]).includes(e)),r="".concat(t.id,"_to_").concat(a.id);tB({from:t.id,to:a.id,name:r,description:"User defined relationship",joinText:_(l.map(e=>[e,e])),mode:"create"})}else eg(t=>[...t,{id:"edge-".concat(Date.now()),from:ev,to:e,label:"custom_link",type:"relation"}]);eN(null)}ey(e)},aK=e=>{t3(t=>t===e?null:e)},aB=e=>{t7&&eh(t=>t.map(t=>t.id===t7.id?{...t,...e}:t))},aF=(e,t)=>{if(aB({description:t}),ex){if("entity"===e.kind&&e.ref.entityName){em({...ex,entities:ex.entities.map(a=>a.name===e.ref.entityName?{...a,description:t}:a)});return}if("derived"===e.kind&&e.ref.entityName&&e.ref.fieldName){em({...ex,entities:ex.entities.map(a=>a.name!==e.ref.entityName?a:{...a,fields:a.fields.map(a=>a.name===e.ref.fieldName?{...a,description:t}:a)})});return}if("reasoner"===e.kind&&e.ref.reasonerId){em({...ex,reasoners:ex.reasoners.map(a=>a.id===e.ref.reasonerId?{...a,description:t}:a)});return}if("graph"===e.kind&&e.ref.graphId){let a=ex.kg||{nodes:[],edges:[],graphs:[]},s=(Array.isArray(a.graphs)?a.graphs:[]).map(a=>a.id===e.ref.graphId?{...a,description:t}:a);em({...ex,kg:{...a,graphs:s}})}}},aq=(e,t)=>{if(!ex||!e.ref.entityName)return;let a=t.trim();if(!a)return;let s=e.ref.entityName;if(a===s){aB({label:a});return}let l=new Map;l.set(s,a);let r=eu.map(e=>{if(e.ref.entityName!==s)return e;let t={...e.ref,entityName:a};if("entity"===e.kind)return{...e,id:a,label:a,ref:t};if("derived"===e.kind&&e.ref.fieldName){let s=p(a,e.ref.fieldName);return l.set(e.id,s),{...e,id:s,ref:t}}return{...e,ref:t}}),n=ef.map(e=>({...e,from:l.get(e.from)||e.from,to:l.get(e.to)||e.to}));em({...ex,entities:ex.entities.map(e=>e.name===s?{...e,name:a}:e),relationships:ex.relationships.map(e=>({...e,from_entity:e.from_entity===s?a:e.from_entity,to_entity:e.to_entity===s?a:e.to_entity}))}),eh(r),eg(n),ey(a)},aY=(e,t)=>{if(!ex||!e.ref.entityName||!e.ref.fieldName)return;let a=t.trim();if(!a)return;let s=e.ref.fieldName;if(a===s){aB({label:a});return}let l=eu.map(t=>t.id!==e.id?t:{...t,id:p(e.ref.entityName,a),label:a,ref:{...t.ref,fieldName:a}}),r=ef.map(t=>t.from!==e.id&&t.to!==e.id?t:{...t,from:t.from===e.id?p(e.ref.entityName,a):t.from,to:t.to===e.id?p(e.ref.entityName,a):t.to});em({...ex,entities:ex.entities.map(t=>t.name!==e.ref.entityName?t:{...t,default_metric:t.default_metric===s?a:t.default_metric,fields:t.fields.map(e=>{let t=(e.depends_on||[]).map(e=>e===s?a:e);if(e.name!==s)return t===e.depends_on?e:{...e,depends_on:t};let l={...e,name:a,depends_on:t};return e.expr===s&&(l.expr=a),l})})}),eh(l),eg(r),ey(p(e.ref.entityName,a))},az=(e,t)=>{if(!ex||!e.ref.reasonerId)return;let a=t.trim();a&&(aB({label:a}),em({...ex,reasoners:ex.reasoners.map(t=>t.id===e.ref.reasonerId?{...t,name:a}:t)}))},aU=(e,t)=>{if(!ex||!e.ref.graphId)return;let a=t.trim();if(!a)return;aB({label:a});let s=ex.kg||{nodes:[],edges:[],graphs:[]},l=(Array.isArray(s.graphs)?s.graphs:[]).map(t=>t.id===e.ref.graphId?{...t,id:a}:t),r=ex.reasoners.map(t=>t.graph_id===e.ref.graphId?{...t,graph_id:a}:t);a_({...ex,reasoners:r,kg:{...s,graphs:l}},!0),ey(u(a))},aX=e=>{if(t7&&"kg"!==t7.kind){if("graph"===t7.kind){aU(t7,e);return}if("entity"===t7.kind){aq(t7,e);return}if("derived"===t7.kind){aY(t7,e);return}az(t7,e)}},aQ=e=>{if(!ex){eJ("Load or draft a registry first.");return}if("kg"===e){eJ("KG nodes are generated from the KG config.");return}if("entity"===e){let e=w("NewEntity",new Set(ex.entities.map(e=>e.name)));a_({...ex,entities:[...ex.entities,{name:e,description:"Describe this entity.",database:"",schema:"",table:"",fields:[],join_keys:[],default_metric:"",entity_type:"generic",applicable_reasoners:[],applicable_derived_metrics:[]}]},!0),ey(e);return}if("derived"===e){var t;let e=(null==t7?void 0:t7.ref.entityName)||(null===(t=ex.entities[0])||void 0===t?void 0:t.name);if(!e)return;let a=ex.entities.find(t=>t.name===e);if(!a)return;let s=w("derived_metric",new Set(a.fields.map(e=>e.name)));a_({...ex,entities:ex.entities.map(t=>t.name!==e?t:{...t,fields:[...t.fields,{name:s,dtype:"number",role:"metric",expr:"",description:"Describe the derived metric.",derived:!0,default_agg:"avg",depends_on:[]}]})},!0),ey(p(e,s));return}if("graph"===e){let e=ex.kg||{nodes:[],edges:[],graphs:[]},t=Array.isArray(e.graphs)?e.graphs:[],a=w("graph",new Set(t.map(e=>e.id)));a_({...ex,kg:{...e,graphs:[...t,{id:a,description:"Describe this graph reasoner.",directed:!0,weighted:!1,nodes:[],edges:[]}]}},!0),ey(u(a));return}let a=w("reasoner",new Set(ex.reasoners.map(e=>e.id)));a_({...ex,reasoners:[...ex.reasoners,{id:a,name:"New Reasoner",description:"Describe this reasoner.",entity_type:"generic",type:"signal_based",signals:[],outputs:[],drilldown_plan:{steps:[]}}]},!0),ey(x(a))},aV=async()=>{let e=ec.current;if(e)try{document.fullscreenElement===e?await document.exitFullscreen():await e.requestFullscreen()}catch(e){eJ("Fullscreen request failed.")}},aW=()=>{if(ex&&t7){if("derived"===t7.kind){if(!t7.ref.entityName||!t7.ref.fieldName)return;let e=ex.entities.find(e=>e.name===t7.ref.entityName),t=null==e?void 0:e.fields.find(e=>e.name===t7.ref.fieldName),a=((null==e?void 0:e.fields)||[]).map(e=>e.name),s=G(t7.ref.entityName,t7.ref.fieldName,eH||""),l=A(L(s,a,t7.ref.fieldName),null==t?void 0:t.order_by);em({...ex,derived_rel_rules:J(ex,s),entities:ex.entities.map(e=>e.name!==t7.ref.entityName?e:{...e,fields:e.fields.map(e=>e.name===t7.ref.fieldName?{...e,expr:eH,depends_on:l}:e)})}),e2(l.join(", ")),e3(JSON.stringify(s,null,2)),tt(""),ts(""),eJ("Derived rule updated.");return}if("reasoner"===t7.kind){if(!t7.ref.reasonerId)return;let e=to.filter(e=>e.name&&e.metric_field);em({...ex,reasoners:ex.reasoners.map(t=>t.id===t7.ref.reasonerId?{...t,signals:e}:t)}),eJ("Reasoner signals updated.")}}},aZ=()=>{if(ex&&(null==t7?void 0:t7.ref.reasonerId)&&"reasoner"===t7.kind){if(!tc.trim()){th("Drilldown plan JSON is empty.");return}try{let e=JSON.parse(tc);a6({drilldown_plan:e}),th("Drilldown plan saved.")}catch(e){th("Drilldown plan JSON is invalid.")}}},aH=async()=>{if(!ex||!(null==t7?void 0:t7.ref.reasonerId)||"reasoner"!==t7.kind)return;let e=ex.reasoners.find(e=>e.id===t7.ref.reasonerId);if(!e)return;let t=tx.trim();eI(!0),th("Generating drilldown plan...");try{let a=await fetch("".concat(ep,"/api/registry/reasoners/drilldown-plan"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({reasoner_id:e.id,name:e.name,description:e.description,entity_type:e.entity_type,outputs:e.outputs||[],signals:e.signals||[],instruction:t,registry:ex})});if(!a.ok){th("Plan generation failed.");return}let s=await a.json();(null==s?void 0:s.drilldown_plan)?(tp(JSON.stringify(s.drilldown_plan,null,2)),th("Plan generated. Review and apply.")):th("No plan generated.")}catch(e){th("Plan generation failed.")}finally{eI(!1)}},a$=async()=>{if(ex&&(null==t7?void 0:t7.ref.entityName)&&(null==t7?void 0:t7.ref.fieldName)&&"derived"===t7.kind){if(!e6.trim()){eJ("Enter a natural-language rule description.");return}eI(!0),e9("Generating rule with LLM...");try{let e=await fetch("".concat(ep,"/api/registry/rules/generate"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({entity:t7.ref.entityName,field:t7.ref.fieldName,instruction:e6,registry:ex})});if(!e.ok){e9("Rule generation failed.");return}let t=await e.json();t.rule?(e3(JSON.stringify(t.rule,null,2)),e9("Rule generated. Review and apply."),tt(""),ts("")):e9("No rule generated.")}catch(e){e9("Rule generation failed.")}finally{eI(!1)}}},a0=async()=>{if(!e1.trim()){e8(["Rule JSON is empty."]);return}let e=null;try{e=JSON.parse(e1||"")}catch(e){e8(["Rule JSON is invalid."]);return}eI(!0),e9("Validating rule...");try{let t=await fetch("".concat(ep,"/api/registry/rules/validate"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({rule:e,registry:ex})});if(!t.ok){e9("Validation failed.");return}let a=await t.json(),s=Array.isArray(a.issues)?a.issues:[];e8(s),e9(a.valid?"Rule is valid.":"Rule has issues.")}catch(e){e9("Validation failed.")}finally{eI(!1)}},a2=async()=>{if(!ex)return;if(!e1.trim()){ts("Rule JSON is empty.");return}let e=null;try{e=JSON.parse(e1||"")}catch(e){ts("Rule JSON is invalid.");return}eI(!0),ts("Generating Snowflake SQL...");try{let t=await fetch("".concat(ep,"/api/registry/rules/sql"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({rule:e,registry:ex})});if(!t.ok){ts("SQL generation failed.");return}let a=await t.json();tt(a.sql||""),ts(a.sql?"SQL generated.":"SQL generation failed.")}catch(e){ts("SQL generation failed.")}finally{eI(!1)}},a1=e=>{ex&&(null==t7?void 0:t7.ref.entityName)&&a_({...ex,entities:ex.entities.map(t=>t.name===t7.ref.entityName?{...t,...e}:t)},!0)},a3=e=>{ex&&(null==t7?void 0:t7.ref.entityName)&&(null==t7?void 0:t7.ref.fieldName)&&a_({...ex,entities:ex.entities.map(t=>t.name!==t7.ref.entityName?t:{...t,fields:t.fields.map(t=>t.name===t7.ref.fieldName?{...t,...e}:t)})},!0)},a6=e=>{ex&&(null==t7?void 0:t7.ref.reasonerId)&&a_({...ex,reasoners:ex.reasoners.map(t=>t.id===t7.ref.reasonerId?{...t,...e}:t)},!0)},a4=(e,t,a)=>{if(!ex)return;let s=(a.name||t).trim(),l=a.name&&s&&s!==t;a_({...ex,entities:ex.entities.map(r=>{if(r.name!==e)return r;let n=r.fields.map(e=>{if(e.name===t)return{...e,...a,name:s||e.name};if(l){let a=(e.depends_on||[]).map(e=>e===t?s:e);return a===e.depends_on?e:{...e,depends_on:a}}return e}),i=l?(r.join_keys||[]).map(e=>e===t?s:e):r.join_keys,o=l&&r.default_metric===t?s:r.default_metric,d=l?(r.applicable_derived_metrics||[]).map(e=>e===t?s:e):r.applicable_derived_metrics;return{...r,fields:n,join_keys:i,default_metric:o,applicable_derived_metrics:d}}),derived_rel_rules:l?(ex.derived_rel_rules||[]).map(a=>a.entity===e&&a.field===t?{...a,field:s}:a):ex.derived_rel_rules,relationships:l?ex.relationships.map(a=>{if(a.from_entity!==e&&a.to_entity!==e)return a;let l=(a.join_on||[]).map(l=>{let[r,n]=l;return[a.from_entity===e&&r===t?s:r,a.to_entity===e&&n===t?s:n]});return{...a,join_on:l}}):ex.relationships},!0)},a5=(e,t,a)=>{if(!ex)return;let s=ex.entities.find(t=>t.name===e),l=null==s?void 0:s.fields.find(e=>e.name===t);if(!s||!l)return;let r=l.depends_on;if(l.derived){let e=s.fields.map(e=>e.name);r=A(M(l.expr||"",e,l.name),a)}a4(e,t,{order_by:a,depends_on:r}),(null==t7?void 0:t7.kind)==="derived"&&t7.ref.entityName===e&&t7.ref.fieldName===t&&l.derived&&e2((r||[]).join(", "))},a9=e=>{if(!ex)return;let t=ex.entities.find(t=>t.name===e);if(!t)return;let a=w("new_column",new Set(t.fields.map(e=>e.name)));a_({...ex,entities:ex.entities.map(t=>t.name!==e?t:{...t,fields:[...t.fields,{name:a,dtype:"",role:"dimension",expr:"",description:"",derived:!1,default_agg:"",depends_on:[]}]})},!0)},a7=(e,t)=>{ex&&window.confirm('Delete field "'.concat(t,'"?'))&&a_({...ex,entities:ex.entities.map(a=>a.name!==e?a:{...a,fields:a.fields.filter(e=>e.name!==t),join_keys:(a.join_keys||[]).filter(e=>e!==t),default_metric:a.default_metric===t?"":a.default_metric,applicable_derived_metrics:(a.applicable_derived_metrics||[]).filter(e=>e!==t)})},!0)},a8=(e,t)=>{if(!ex)return;let a=ex.entities.find(t=>t.name===e);if(!a)return;let s=a.fields||[],l=new Map(s.map(e=>[e.name,e])),r=["posyear","posmon","meet_year","meet_mon","month_date","positiondate","month_date"].filter(e=>l.has(e)),n=["rmid","mandateid","meeting_id","meetingid"].filter(e=>l.has(e)),i=n.length?n:(a.join_keys||[]).filter(e=>!r.includes(e));if(!r.length){eJ("No time keys found (posyear/posmon/meet_year/meet_mon/month_date).");return}let o=s.filter(e=>"metric"===e.role&&!e.derived&&!e.name.startsWith("prev_")),d=new Set(t),c=o.filter(e=>d.has(e.name));if(!c.length){eJ("Select one or more metrics for prev_ fields.");return}let p=[];for(let e of c){let t="prev_".concat(e.name);if(l.has(t))continue;let a=e.expr||e.name.toUpperCase(),s=i.map(e=>{var t;return(null===(t=l.get(e))||void 0===t?void 0:t.expr)||e.toUpperCase()}).filter(Boolean),n=r.map(e=>{var t;return(null===(t=l.get(e))||void 0===t?void 0:t.expr)||e.toUpperCase()}).filter(Boolean),o=[s.length?"PARTITION BY ".concat(s.join(", ")):"",n.length?"ORDER BY ".concat(n.join(", ")):""].filter(Boolean).join(" ");p.push({name:t,dtype:e.dtype,role:"metric",expr:"LAG(".concat(a,") OVER (").concat(o,")"),description:"Previous ".concat(e.name," by ").concat(i.join(", ")||"entity"," over time."),derived:!0,default_agg:"avg",depends_on:[e.name,...i,...r]})}if(!p.length){eJ("No new prev_ fields to add.");return}a_({...ex,entities:ex.entities.map(t=>t.name===e?{...t,fields:[...t.fields,...p]}:t)},!0),eJ("Added ".concat(p.length," prev_ fields."))},se=async e=>{if(!ex)return;let t=ex.entities.find(t=>t.name===e);if(!t)return;let a=K(t);if(!a){eJ("Set database/schema/table before importing.");return}eI(!0),eJ("Importing fields from ".concat(a,"..."));try{let s=await fetch("".concat(ep,"/api/registry/describe"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({table:a})});if(!s.ok){eJ("Describe failed.");return}let l=((await s.json()).columns||[]).map(e=>{let t=String(e.name||"").toLowerCase(),a=String(e.type||""),s=T(a);return{name:t,dtype:a,role:s,expr:t,description:String(e.comment||""),derived:!1,default_agg:"metric"===s?P(t,a):"",depends_on:[]}}),r=(t.fields||[]).filter(e=>e.derived),n=l.map(e=>e.name).filter(e=>e.endsWith("id")||["rmid","mandateid","meeting_id"].includes(e)),i=Array.from(new Set([...t.join_keys||[],...n])),o=l.filter(e=>"metric"===e.role),d=o.length?o[0].name:t.default_metric,c={...ex,entities:ex.entities.map(t=>t.name===e?{...t,fields:[...l,...r],join_keys:i,default_metric:d||""}:t)};a_(c,!0),eJ("Imported ".concat(l.length," fields."))}catch(e){eJ("Describe failed.")}finally{eI(!1)}},st=(e,t)=>{td(a=>a.map((a,s)=>s===e?{...a,...t}:a))},sa=()=>{if(!(null==t7?void 0:t7.ref.reasonerId))return;let e=ae.reasonerMap.get(t7.ref.reasonerId);a6({outputs:[...(null==e?void 0:e.outputs)||[],""]})},ss=(e,t)=>{if(!(null==t7?void 0:t7.ref.reasonerId))return;let a=ae.reasonerMap.get(t7.ref.reasonerId),s=[...(null==a?void 0:a.outputs)||[]];s[e]=t.trim(),a6({outputs:s})},sl=e=>{if(!(null==t7?void 0:t7.ref.reasonerId))return;let t=ae.reasonerMap.get(t7.ref.reasonerId);a6({outputs:((null==t?void 0:t.outputs)||[]).filter((t,a)=>a!=e)})},sr=(e,t)=>{t2(a=>{let s=new Set(a[e]||[]);return s.has(t)?s.delete(t):s.add(t),{...a,[e]:Array.from(s)}})},sn=(e,t)=>{t2(a=>({...a,[e]:t}))},si=()=>{td(e=>[...e,{name:"",description:"",metric_field:"",threshold:0,direction:"below"}])},so=e=>{td(t=>t.filter((t,a)=>a!==e))},sd=e=>{tB({from:e.from_entity,to:e.to_entity,name:e.name,description:e.description||"",joinText:_(e.join_on||[]),mode:"edit",originalName:e.name})},sc=e=>{ex&&window.confirm('Delete relationship "'.concat(e,'"?'))&&a_({...ex,relationships:ex.relationships.filter(t=>t.name!==e)},!0)},sp=e=>{let t=(e.fields||[]).map(e=>e.name);return(e.fields||[]).map(e=>{if(!e.derived)return e;let a=A(M(e.expr||"",t,e.name),e.order_by);return{...e,depends_on:a}})},sx=async e=>{eI(!0),eJ("Rolling back to ".concat(e,"..."));try{if(!(await fetch("".concat(ep,"/api/registry/rollback"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({version:e})})).ok){eJ("Rollback failed.");return}await aC(),eJ("Rollback complete.")}catch(e){eJ("Rollback failed.")}finally{eI(!1)}},sm=async()=>{eI(!0),eJ("Exporting ontology...");try{let e=await fetch("".concat(ep,"/api/registry/ontology/export"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({registry:ex,format:"json",write_file:!0})});if(!e.ok){eJ("Export failed.");return}let t=await e.json();eJ("Ontology exported".concat(t.path?": ".concat(t.path):"","."))}catch(e){eJ("Export failed.")}finally{eI(!1)}},su=()=>{if(!ex||!t7)return;if("kg"===t7.kind){eJ("KG nodes are derived from the KG config. Edit the KG panel instead.");return}let e=t7.label||t7.id;if(window.confirm("Delete ".concat(t7.kind,' "').concat(e,'"?'))){if("entity"===t7.kind&&t7.ref.entityName){a_({...ex,entities:ex.entities.filter(e=>e.name!==t7.ref.entityName),relationships:ex.relationships.filter(e=>e.from_entity!==t7.ref.entityName&&e.to_entity!==t7.ref.entityName)},!0),ey(null);return}if("graph"===t7.kind&&t7.ref.graphId){let e=ex.kg||{nodes:[],edges:[],graphs:[]},t=Array.isArray(e.graphs)?e.graphs:[];a_({...ex,kg:{...e,graphs:t.filter(e=>e.id!==t7.ref.graphId)}},!0),ey(null);return}if("derived"===t7.kind&&t7.ref.entityName&&t7.ref.fieldName){a_({...ex,entities:ex.entities.map(e=>e.name!==t7.ref.entityName?e:{...e,fields:e.fields.filter(e=>e.name!==t7.ref.fieldName)})},!0),ey(null);return}"reasoner"===t7.kind&&t7.ref.reasonerId&&(a_({...ex,reasoners:ex.reasoners.filter(e=>e.id!==t7.ref.reasonerId),entities:ex.entities.map(e=>({...e,applicable_reasoners:(e.applicable_reasoners||[]).filter(e=>e!==t7.ref.reasonerId)}))},!0),ey(null))}},sh=(null==t7?void 0:t7.kind)==="entity"?ae.entityMap.get(t7.ref.entityName||""):null,sf=sh?(sh.fields||[]).filter(e=>"metric"===e.role&&!e.derived&&!e.name.startsWith("prev_")):[],sg=sh&&t0[sh.name]||[],sb=(null==t7?void 0:t7.kind)==="reasoner"?ae.reasonerMap.get(t7.ref.reasonerId||""):null,sy=b(sb),sv=(null==sb?void 0:sb.graph_id)||"",sN=(0,l.useMemo)(()=>{if(!ex||!sb||b(sb))return null;let e=ex.entities.filter(e=>e.entity_type===sb.entity_type),t=new Map;return e.forEach(e=>{(e.fields||[]).forEach(a=>{t.has(a.name)||t.set(a.name,{field:a,entity:e})})}),{entityNames:e.map(e=>e.name),fieldMap:t,options:Array.from(t.keys()).sort()}},[ex,sb]),sj=(0,l.useMemo)(()=>((null==ex?void 0:ex.reasoners)||[]).filter(e=>b(e)),[ex]),sw=(0,l.useMemo)(()=>((null==ex?void 0:ex.reasoners)||[]).filter(e=>!b(e)),[ex]),sk=(0,l.useMemo)(()=>{var e;if(!ex)return{missing:[],unbound:[]};let t=new Set(((null===(e=ex.kg)||void 0===e?void 0:e.graphs)||[]).map(e=>e.id));return{missing:ex.reasoners.filter(e=>b(e)&&e.graph_id&&!t.has(e.graph_id)),unbound:ex.reasoners.filter(e=>b(e)&&!e.graph_id)}},[ex]);return(0,s.jsxs)("div",{className:"min-h-screen bg-gradient-to-br from-slate-50 via-white to-blue-50",children:[(0,s.jsx)("datalist",{id:"dtype-presets",children:E.map(e=>(0,s.jsx)("option",{value:e.value},e.value))}),(0,s.jsx)("div",{className:"border-b border-slate-200/70 bg-white/60 backdrop-blur",children:(0,s.jsxs)("div",{className:"mx-auto flex max-w-7xl items-center justify-between px-6 py-6",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("p",{className:"text-xs font-semibold uppercase tracking-[0.3em] text-slate-400",children:"Registry Studio"}),(0,s.jsx)("h1",{className:"mt-2 text-2xl font-semibold text-slate-900",children:"Visual Semantic Builder"}),(0,s.jsx)("p",{className:"mt-1 text-sm text-slate-500",children:"Draft from Snowflake, refine visually, and export a registry for any client."})]}),(0,s.jsxs)("div",{className:"flex items-center gap-3",children:[(0,s.jsx)("button",{onClick:()=>aR(),disabled:eD,className:"rounded-full border border-slate-200 bg-white px-4 py-2 text-xs font-semibold text-slate-700 shadow-sm",type:"button",children:"Save registry"}),(0,s.jsx)("button",{onClick:aA,disabled:eD,className:"rounded-full bg-slate-900 px-5 py-2 text-xs font-semibold text-white shadow-lg transition hover:-translate-y-0.5",type:"button",children:"Draft from Snowflake"})]})]})}),(0,s.jsxs)("main",{className:"mx-auto flex w-full max-w-7xl flex-col gap-6 px-6 py-8 lg:flex-row",children:[(0,s.jsxs)(r.E.aside,{initial:{opacity:0,x:-20},animate:{opacity:1,x:0},className:"flex w-full flex-col gap-5 rounded-3xl border border-white/60 bg-white/70 p-5 shadow-xl lg:w-80",children:[(0,s.jsxs)("div",{className:"rounded-2xl border border-white/60 bg-white/90 p-4 shadow-sm",children:[(0,s.jsx)("p",{className:"text-xs font-semibold uppercase tracking-[0.2em] text-slate-400",children:"How this fits together"}),(0,s.jsxs)("div",{className:"mt-2 space-y-2 text-xs text-slate-600",children:[(0,s.jsx)("p",{children:"1) Entities + relationships define the schema surface."}),(0,s.jsx)("p",{children:"2) KG nodes/edges describe connectable topology."}),(0,s.jsx)("p",{children:"3) Graphs define traversal maps."}),(0,s.jsx)("p",{children:"4) Graph reasoners execute graphs inside RAI."})]})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("h2",{className:"text-sm font-semibold uppercase tracking-[0.25em] text-slate-400",children:"Snowflake Source"}),(0,s.jsx)("p",{className:"mt-2 text-xs text-slate-500",children:"Paste fully qualified tables (db.schema.table). Drafting will call DESCRIBE and Cortex."}),(0,s.jsx)("textarea",{value:eM,onChange:e=>eE(e.target.value),placeholder:"TFO_TEST.ML_TEST.RAI_MANDATE_MONTHLY_SUMMARY_MODEL",className:"mt-3 h-24 w-full rounded-2xl border border-slate-200 bg-white px-3 py-2 text-xs text-slate-600"}),(0,s.jsx)("label",{className:"mt-4 block text-xs font-semibold uppercase tracking-[0.2em] text-slate-400",children:"Draft Notes"}),(0,s.jsx)("textarea",{value:eO,onChange:e=>eA(e.target.value),placeholder:"Focus on mandate risk + RM performance relationships.",className:"mt-2 h-20 w-full rounded-2xl border border-slate-200 bg-white px-3 py-2 text-xs text-slate-600"}),(0,s.jsxs)("div",{className:"mt-4 flex flex-wrap gap-2",children:[(0,s.jsx)("button",{onClick:aA,disabled:eD,className:"rounded-full bg-slate-900 px-4 py-2 text-xs font-semibold text-white shadow",type:"button",children:"Draft registry"}),(0,s.jsx)("button",{onClick:aC,disabled:eD,className:"rounded-full border border-slate-200 bg-white px-4 py-2 text-xs font-semibold text-slate-600",type:"button",children:"Reload"})]})]}),(0,s.jsxs)("div",{className:"rounded-2xl border border-white/60 bg-white/90 p-4 shadow-sm",children:[(0,s.jsx)("p",{className:"text-xs font-semibold uppercase tracking-[0.2em] text-slate-400",children:"Registry"}),(0,s.jsx)("p",{className:"mt-2 text-xs text-slate-500",children:eG?"Path: ".concat(eG):"Registry path not set yet."}),(0,s.jsxs)("p",{className:"mt-3 text-xs text-slate-500",children:[(null==ex?void 0:null===(e=ex.entities)||void 0===e?void 0:e.length)||0," entities - ",(null==ex?void 0:null===(t=ex.relationships)||void 0===t?void 0:t.length)||0," relationships"," - ".concat(sj.length," graph reasoners").concat(sw.length?" - ".concat(sw.length," legacy reasoners"):"")," - ".concat(((null==ex?void 0:null===(a=ex.kg)||void 0===a?void 0:a.graphs)||[]).length||0," graphs")]}),(0,s.jsx)("button",{onClick:()=>aR(),disabled:eD,className:"mt-3 w-full rounded-2xl bg-slate-900 px-3 py-2 text-xs font-semibold text-white shadow",type:"button",children:"Save registry"}),(0,s.jsx)("button",{onClick:()=>{ex&&(a_({...ex,entities:ex.entities.map(e=>({...e,fields:sp(e)}))},!0),eJ("Dependencies computed for all derived fields."))},disabled:eD,className:"mt-2 w-full rounded-2xl border border-slate-200 bg-white px-3 py-2 text-xs font-semibold text-slate-600",type:"button",children:"Compute deps (all derived)"}),(0,s.jsx)("button",{onClick:aO,disabled:eD,className:"mt-2 w-full rounded-2xl border border-slate-200 bg-white px-3 py-2 text-xs font-semibold text-slate-600",type:"button",children:"Rebuild KG"}),(0,s.jsx)("button",{onClick:sm,disabled:eD,className:"mt-2 w-full rounded-2xl border border-slate-200 bg-white px-3 py-2 text-xs font-semibold text-slate-600",type:"button",children:"Export ontology triples"}),(0,s.jsxs)("div",{className:"mt-4 rounded-2xl border border-slate-200 bg-white p-3",children:[(0,s.jsx)("p",{className:"text-[11px] font-semibold uppercase tracking-[0.2em] text-slate-400",children:"KG Configuration"}),(0,s.jsx)("textarea",{value:eT,onChange:e=>eP(e.target.value),placeholder:'{"nodes":[...],"edges":[...]}',className:"mt-2 h-40 w-full rounded-2xl border border-slate-200 bg-white px-3 py-2 text-xs text-slate-600"}),(0,s.jsxs)("div",{className:"mt-2 flex gap-2",children:[(0,s.jsx)("button",{type:"button",onClick:al,className:"rounded-xl bg-slate-900 px-3 py-2 text-xs font-semibold text-white shadow",children:"Apply KG JSON"}),(0,s.jsx)("button",{type:"button",onClick:ac,disabled:eD,className:"rounded-xl border border-slate-200 bg-white px-3 py-2 text-xs font-semibold text-slate-700",children:"Generate with LLM"})]}),eK&&(0,s.jsx)("p",{className:"mt-2 text-xs text-slate-500",children:eK})]}),(0,s.jsxs)("div",{className:"mt-3 flex items-center justify-between rounded-2xl border border-slate-200 bg-white px-3 py-2",children:[(0,s.jsx)("span",{className:"text-xs font-semibold text-slate-600",children:"Auto-save"}),(0,s.jsx)("button",{type:"button",onClick:()=>tX(e=>!e),className:"rounded-full px-3 py-1 text-[11px] font-semibold ".concat(tU?"bg-slate-900 text-white":"bg-slate-100 text-slate-500"),children:tU?"On":"Off"})]}),(0,s.jsxs)("div",{className:"mt-3 grid grid-cols-2 gap-2",children:[(0,s.jsx)("button",{onClick:aE,disabled:eD,className:"rounded-2xl border border-slate-200 bg-white px-3 py-2 text-xs font-semibold text-slate-600",type:"button",children:"Reload API"}),(0,s.jsx)("button",{onClick:()=>{em({entities:[],relationships:[],reasoners:[],derived_rel_rules:[],prompt_templates:{},analysis_config:{},config:{}}),eh([]),eg([]),ey(null),eq(""),tZ(null),eJ("Started fresh registry.")},disabled:eD,className:"rounded-2xl border border-slate-200 bg-white px-3 py-2 text-xs font-semibold text-slate-600",type:"button",children:"Start fresh"})]})]}),(0,s.jsxs)("div",{className:"rounded-2xl border border-white/60 bg-white/90 p-4 shadow-sm",children:[(0,s.jsxs)("div",{className:"flex items-center justify-between",children:[(0,s.jsx)("p",{className:"text-xs font-semibold uppercase tracking-[0.2em] text-slate-400",children:"Import JSON"}),(0,s.jsx)("button",{type:"button",onClick:()=>ti(""),className:"rounded-full border border-slate-200 bg-white px-3 py-1 text-[11px] font-semibold text-slate-600",children:"Clear"})]}),(0,s.jsx)("p",{className:"mt-2 text-xs text-slate-500",children:"Paste a full registry JSON to replace the current draft."}),(0,s.jsx)("textarea",{value:tn,onChange:e=>ti(e.target.value),placeholder:'{"entities":[...],"relationships":[...],"reasoners":[...]}',className:"mt-2 h-32 w-full rounded-2xl border border-slate-200 bg-white px-3 py-2 text-xs text-slate-600"}),(0,s.jsx)("button",{type:"button",onClick:aS,className:"mt-2 w-full rounded-2xl bg-slate-900 px-3 py-2 text-xs font-semibold text-white shadow",children:"Import registry JSON"})]}),(0,s.jsxs)("div",{className:"rounded-2xl border border-white/60 bg-white/90 p-4 shadow-sm",children:[(0,s.jsxs)("div",{className:"flex items-center justify-between",children:[(0,s.jsx)("p",{className:"text-xs font-semibold uppercase tracking-[0.2em] text-slate-400",children:"Prompt Customization"}),(0,s.jsx)("button",{type:"button",onClick:()=>tr(e=>!e),className:"rounded-full border border-slate-200 bg-white px-3 py-1 text-[11px] font-semibold text-slate-600",children:tl?"Hide previews":"Preview prompts"})]}),(0,s.jsx)("p",{className:"mt-2 text-xs text-slate-500",children:"Provide business, data, and expectations so the LLM can generate customized prompts from the defaults. Full prompt templates are not directly editable."}),(0,s.jsxs)("div",{className:"mt-3 space-y-3",children:[(0,s.jsxs)("div",{className:"rounded-2xl border border-slate-200 bg-white px-3 py-2",children:[(0,s.jsx)("p",{className:"text-xs font-semibold text-slate-700",children:"Business context"}),(0,s.jsx)("textarea",{value:as.business,onChange:e=>an("business",e.target.value),placeholder:"e.g., Wealth management, mandate profitability, RM performance",className:"mt-2 h-20 w-full rounded-2xl border border-slate-200 bg-white px-3 py-2 text-xs text-slate-600"})]}),(0,s.jsxs)("div",{className:"rounded-2xl border border-slate-200 bg-white px-3 py-2",children:[(0,s.jsx)("p",{className:"text-xs font-semibold text-slate-700",children:"Data context"}),(0,s.jsx)("textarea",{value:as.data,onChange:e=>an("data",e.target.value),placeholder:"e.g., Monthly mandate snapshots, meeting sentiment, revenue/cost metrics",className:"mt-2 h-20 w-full rounded-2xl border border-slate-200 bg-white px-3 py-2 text-xs text-slate-600"})]}),(0,s.jsxs)("div",{className:"rounded-2xl border border-slate-200 bg-white px-3 py-2",children:[(0,s.jsx)("p",{className:"text-xs font-semibold text-slate-700",children:"Expectations"}),(0,s.jsx)("textarea",{value:as.expectations,onChange:e=>an("expectations",e.target.value),placeholder:"e.g., Focus on executive summaries, highlight risk, avoid speculation",className:"mt-2 h-20 w-full rounded-2xl border border-slate-200 bg-white px-3 py-2 text-xs text-slate-600"})]}),(0,s.jsxs)("div",{className:"flex flex-wrap items-center gap-2",children:[(0,s.jsx)("button",{type:"button",onClick:ad,disabled:eD,className:"rounded-2xl bg-slate-900 px-3 py-2 text-xs font-semibold text-white shadow",children:"Generate prompts"}),(0,s.jsx)("button",{type:"button",onClick:ao,disabled:eD,className:"rounded-2xl border border-slate-200 bg-white px-3 py-2 text-xs font-semibold text-slate-600",children:"Reset to defaults"})]})]}),tl&&(0,s.jsx)("div",{className:"mt-3 space-y-3",children:aa.map(e=>{let t=Object.prototype.hasOwnProperty.call(at,e);return(0,s.jsxs)("div",{className:"rounded-2xl border border-slate-200 bg-white px-3 py-2",children:[(0,s.jsxs)("div",{className:"flex items-center justify-between",children:[(0,s.jsx)("p",{className:"text-xs font-semibold text-slate-700",children:e}),(0,s.jsxs)("div",{className:"flex items-center gap-2",children:[(0,s.jsx)("span",{className:"rounded-full px-2 py-1 text-[10px] font-semibold ".concat(t?"bg-emerald-50 text-emerald-700":"bg-slate-100 text-slate-500"),children:t?"Custom":"Default"}),t&&(0,s.jsx)("button",{type:"button",onClick:()=>ai(e),className:"rounded-full border border-rose-200 bg-rose-50 px-2 py-1 text-[11px] text-rose-600",children:"Clear"})]})]}),t?(0,s.jsx)("textarea",{value:at[e]||"",readOnly:!0,className:"mt-2 h-28 w-full rounded-2xl border border-slate-200 bg-slate-50 px-3 py-2 text-xs text-slate-600"}):(0,s.jsx)("p",{className:"mt-2 text-[11px] text-slate-500",children:"Using default prompt (not shown here)."})]},e)})})]}),(0,s.jsxs)("div",{className:"rounded-2xl border border-white/60 bg-white/90 p-4 shadow-sm",children:[(0,s.jsxs)("div",{className:"flex items-center justify-between",children:[(0,s.jsx)("p",{className:"text-xs font-semibold uppercase tracking-[0.2em] text-slate-400",children:"Graph Topology"}),(0,s.jsx)("button",{onClick:()=>aQ("graph"),className:"rounded-full border border-slate-200 bg-white px-3 py-1 text-[11px] font-semibold text-slate-600",type:"button",children:"+ Add"})]}),(0,s.jsx)("p",{className:"mt-2 text-[11px] text-slate-500",children:"Graphs describe the traversal map. Graph reasoners execute these graphs inside RAI."}),(0,s.jsxs)("div",{className:"mt-3 max-h-40 space-y-2 overflow-auto pr-1",children:[((null==ex?void 0:null===(m=ex.kg)||void 0===m?void 0:m.graphs)||[]).map(e=>(0,s.jsxs)("button",{type:"button",onClick:()=>ey(u(e.id)),className:"w-full rounded-2xl border border-slate-200 bg-white px-3 py-2 text-left text-xs font-semibold text-slate-700",children:[e.id,(0,s.jsx)("span",{className:"ml-2 text-[10px] font-semibold text-slate-400",children:!1===e.directed?"undirected":"directed"})]},e.id)),!((null==ex?void 0:null===(f=ex.kg)||void 0===f?void 0:f.graphs)||[]).length&&(0,s.jsx)("p",{className:"text-xs text-slate-500",children:"No graphs yet."})]}),(0,s.jsxs)("div",{className:"mt-4 border-t border-slate-200 pt-3",children:[(0,s.jsx)("p",{className:"text-[11px] font-semibold uppercase tracking-[0.2em] text-slate-400",children:"Graph Reasoners"}),(0,s.jsx)("p",{className:"mt-1 text-[11px] text-slate-500",children:"Executable reasoners bound to graphs (type = graph_reasoner)."}),(0,s.jsxs)("div",{className:"mt-2 max-h-32 space-y-2 overflow-auto pr-1",children:[sj.map(e=>(0,s.jsxs)("button",{type:"button",onClick:()=>ey(x(e.id)),className:"w-full rounded-2xl border border-slate-200 bg-white px-3 py-2 text-left text-xs font-semibold text-slate-700",children:[e.name||e.id,e.graph_id?(0,s.jsx)("span",{className:"ml-2 text-[10px] font-semibold text-slate-400",children:e.graph_id}):null]},e.id)),!sj.length&&(0,s.jsx)("p",{className:"text-xs text-slate-500",children:"No graph reasoners yet."})]})]}),sw.length>0&&(0,s.jsxs)("div",{className:"mt-3 rounded-2xl border border-amber-200 bg-amber-50 px-3 py-2 text-xs text-amber-700",children:[(0,s.jsx)("p",{className:"font-semibold",children:"Legacy reasoners present"}),(0,s.jsx)("p",{className:"mt-1 text-[11px]",children:"These are non-graph reasoners and run outside graph traversal logic."})]}),(sk.missing.length>0||sk.unbound.length>0)&&(0,s.jsxs)("div",{className:"mt-3 rounded-2xl border border-amber-200 bg-amber-50 px-3 py-2 text-xs text-amber-700",children:[(0,s.jsx)("p",{className:"font-semibold",children:"Reasoner bindings need attention"}),sk.missing.length>0&&(0,s.jsxs)("p",{className:"mt-1",children:["Missing graph: ",sk.missing.map(e=>e.id).join(", ")]}),sk.unbound.length>0&&(0,s.jsxs)("p",{className:"mt-1",children:["Unbound: ",sk.unbound.map(e=>e.id).join(", ")]})]})]}),(0,s.jsxs)("div",{className:"rounded-2xl border border-white/60 bg-white/90 p-4 shadow-sm",children:[(0,s.jsxs)("div",{className:"flex items-center justify-between",children:[(0,s.jsx)("p",{className:"text-xs font-semibold uppercase tracking-[0.2em] text-slate-400",children:"Relationships"}),(0,s.jsx)("button",{onClick:()=>{if(!ex)return;if(ex.entities.length<2){eJ("Add at least two entities before creating relationships.");return}let[e,t]=ex.entities.map(e=>e.name);tB({from:e,to:t,name:"".concat(e,"_to_").concat(t),description:"",joinText:"",mode:"create"})},className:"rounded-full border border-slate-200 bg-white px-3 py-1 text-[11px] font-semibold text-slate-600",type:"button",children:"+ Add"})]}),(0,s.jsxs)("div",{className:"mt-3 max-h-40 space-y-2 overflow-auto pr-1",children:[((null==ex?void 0:ex.relationships)||[]).map(e=>(0,s.jsxs)("div",{className:"rounded-2xl border border-slate-200 bg-white px-3 py-2",children:[(0,s.jsx)("p",{className:"text-xs font-semibold text-slate-700",children:e.name}),(0,s.jsxs)("p",{className:"text-[11px] text-slate-500",children:[e.from_entity,"  ",e.to_entity]}),(0,s.jsxs)("div",{className:"mt-2 flex gap-2",children:[(0,s.jsx)("button",{type:"button",onClick:()=>sd(e),className:"rounded-full border border-slate-200 bg-white px-2 py-1 text-[11px] text-slate-600",children:"Edit"}),(0,s.jsx)("button",{type:"button",onClick:()=>sc(e.name),className:"rounded-full border border-rose-200 bg-rose-50 px-2 py-1 text-[11px] text-rose-600",children:"Delete"})]})]},e.name)),!(null==ex?void 0:null===(g=ex.relationships)||void 0===g?void 0:g.length)&&(0,s.jsx)("p",{className:"text-xs text-slate-500",children:"No relationships yet."})]})]}),tW&&(0,s.jsxs)("div",{className:"rounded-2xl border border-white/60 bg-white/90 p-4 shadow-sm",children:[(0,s.jsx)("p",{className:"text-xs font-semibold uppercase tracking-[0.2em] text-slate-400",children:"Draft Diff"}),(0,s.jsx)("p",{className:"mt-2 text-xs text-slate-500",children:"Select what to merge from the draft."}),(0,s.jsxs)("div",{className:"mt-3 space-y-3",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("p",{className:"text-xs font-semibold text-slate-600",children:"Entities"}),(0,s.jsx)("div",{className:"mt-2 space-y-1",children:ap.entities.map(e=>(0,s.jsxs)("label",{className:"flex items-center gap-2 text-xs text-slate-600",children:[(0,s.jsx)("input",{type:"checkbox",checked:t6.entities[e.name]||!1,onChange:t=>t4(a=>({...a,entities:{...a.entities,[e.name]:t.target.checked}}))}),e.name," (",e.status,")"]},e.name))})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("p",{className:"text-xs font-semibold text-slate-600",children:"Relationships"}),(0,s.jsx)("div",{className:"mt-2 space-y-1",children:ap.relationships.map(e=>(0,s.jsxs)("label",{className:"flex items-center gap-2 text-xs text-slate-600",children:[(0,s.jsx)("input",{type:"checkbox",checked:t6.relationships[e.name]||!1,onChange:t=>t4(a=>({...a,relationships:{...a.relationships,[e.name]:t.target.checked}}))}),e.name," (",e.status,")"]},e.name))})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("p",{className:"text-xs font-semibold text-slate-600",children:"Reasoners"}),(0,s.jsx)("div",{className:"mt-2 space-y-1",children:ap.reasoners.map(e=>(0,s.jsxs)("label",{className:"flex items-center gap-2 text-xs text-slate-600",children:[(0,s.jsx)("input",{type:"checkbox",checked:t6.reasoners[e.name]||!1,onChange:t=>t4(a=>({...a,reasoners:{...a.reasoners,[e.name]:t.target.checked}}))}),e.name," (",e.status,")"]},e.name))})]}),(0,s.jsxs)("div",{className:"mt-2 flex items-center gap-2",children:[(0,s.jsx)("label",{className:"text-xs text-slate-600",children:"Merge mode"}),(0,s.jsxs)("select",{value:tH,onChange:e=>t$(e.target.value),className:"rounded-xl border border-slate-200 px-2 py-1 text-xs text-slate-600",children:[(0,s.jsx)("option",{value:"add",children:"add only"}),(0,s.jsx)("option",{value:"replace",children:"replace existing"})]})]}),(0,s.jsxs)("div",{className:"flex gap-2",children:[(0,s.jsx)("button",{type:"button",onClick:()=>{if(!ex||!tW)return;let e=h(ex),t=h(tW),a=new Map(e.entities.map(e=>[e.name,e])),s=new Map(e.relationships.map(e=>[e.name,e])),l=new Map(e.reasoners.map(e=>[e.id,e]));(t.entities||[]).forEach(e=>{t6.entities[e.name]&&(a.has(e.name)?"replace"===tH&&a.set(e.name,e):a.set(e.name,e))}),(t.relationships||[]).forEach(e=>{t6.relationships[e.name]&&(s.has(e.name)?"replace"===tH&&s.set(e.name,e):s.set(e.name,e))}),(t.reasoners||[]).forEach(e=>{t6.reasoners[e.id]&&(l.has(e.id)?"replace"===tH&&l.set(e.id,e):l.set(e.id,e))}),t.kg&&Object.keys(t.kg).length&&(e.kg="replace"===tH?t.kg:e.kg||t.kg),a_({entities:Array.from(a.values()),relationships:Array.from(s.values()),reasoners:Array.from(l.values())},!0),tZ(null),eJ("Draft merged.")},className:"flex-1 rounded-2xl bg-slate-900 px-3 py-2 text-xs font-semibold text-white shadow",children:"Merge selected"}),(0,s.jsx)("button",{type:"button",onClick:()=>{tW&&(a_(tW,!1),tZ(null),eJ("Draft applied (replaced)."))},className:"flex-1 rounded-2xl border border-slate-200 bg-white px-3 py-2 text-xs font-semibold text-slate-600",children:"Replace"})]}),(0,s.jsx)("button",{type:"button",onClick:()=>{tZ(null),eJ("Draft discarded.")},className:"w-full rounded-2xl border border-slate-200 bg-white px-3 py-2 text-xs font-semibold text-slate-600",children:"Discard draft"})]})]}),(0,s.jsxs)("div",{className:"rounded-2xl border border-white/60 bg-white/90 p-4 shadow-sm",children:[(0,s.jsx)("p",{className:"text-xs font-semibold uppercase tracking-[0.2em] text-slate-400",children:"Validation"}),(0,s.jsxs)("p",{className:"mt-2 text-xs text-slate-500",children:[aj.length," issues"]}),(0,s.jsxs)("div",{className:"mt-3 max-h-40 space-y-2 overflow-auto pr-1",children:[aj.map((e,t)=>(0,s.jsxs)("div",{className:"rounded-2xl border border-slate-200 bg-white px-3 py-2",children:[(0,s.jsx)("p",{className:"text-xs font-semibold ".concat("error"===e.level?"text-rose-600":"text-amber-600"),children:e.level.toUpperCase()}),(0,s.jsx)("p",{className:"text-[11px] text-slate-600",children:e.message})]},"".concat(e.message,"-").concat(t))),!aj.length&&(0,s.jsx)("p",{className:"text-xs text-slate-500",children:"No validation issues."})]})]}),(0,s.jsxs)("div",{className:"rounded-2xl border border-white/60 bg-white/90 p-4 shadow-sm",children:[(0,s.jsx)("p",{className:"text-xs font-semibold uppercase tracking-[0.2em] text-slate-400",children:"Versions"}),(0,s.jsxs)("div",{className:"mt-3 max-h-40 space-y-2 overflow-auto pr-1",children:[tQ.map(e=>(0,s.jsxs)("div",{className:"rounded-2xl border border-slate-200 bg-white px-3 py-2",children:[(0,s.jsx)("p",{className:"text-xs font-semibold text-slate-700",children:e.name}),(0,s.jsx)("p",{className:"text-[11px] text-slate-500",children:e.created_at}),(0,s.jsx)("button",{type:"button",onClick:()=>sx(e.name),className:"mt-2 rounded-full border border-slate-200 bg-white px-2 py-1 text-[11px] text-slate-600",children:"Rollback"})]},e.name)),!tQ.length&&(0,s.jsx)("p",{className:"text-xs text-slate-500",children:"No versions yet."})]})]}),(0,s.jsxs)("div",{className:"rounded-2xl border border-white/60 bg-white/90 p-4 shadow-sm",children:[(0,s.jsx)("p",{className:"text-xs font-semibold uppercase tracking-[0.2em] text-slate-400",children:"YAML Preview"}),(0,s.jsx)("textarea",{value:eF,readOnly:!0,placeholder:"Save to generate YAML preview.",className:"mt-3 h-32 w-full rounded-2xl border border-slate-200 bg-white px-3 py-2 text-xs text-slate-600"})]}),(0,s.jsxs)("div",{className:"rounded-2xl border border-white/60 bg-white/90 p-4 shadow-sm",children:[(0,s.jsx)("p",{className:"text-xs font-semibold uppercase tracking-[0.2em] text-slate-400",children:"Filters"}),(0,s.jsxs)("div",{className:"mt-3 flex flex-wrap gap-2",children:[(0,s.jsx)("button",{type:"button",onClick:()=>e_("data"),className:"rounded-full px-3 py-1 text-xs font-semibold ".concat("data"===ek?"bg-slate-900 text-white":"bg-slate-100 text-slate-500"),children:"Data model"}),(0,s.jsx)("button",{type:"button",onClick:()=>e_("kg"),className:"rounded-full px-3 py-1 text-xs font-semibold ".concat("kg"===ek?"bg-slate-900 text-white":"bg-slate-100 text-slate-500"),children:"Knowledge graph"})]}),(0,s.jsx)("div",{className:"mt-3 flex flex-wrap gap-2",children:am.map(e=>(0,s.jsx)("button",{onClick:()=>eC(t=>({...t,[e]:!t[e]})),className:"rounded-full px-3 py-1 text-xs font-semibold ".concat(eS[e]?"bg-slate-900 text-white":"bg-slate-100 text-slate-500"),type:"button",children:e},e))}),(0,s.jsx)("button",{onClick:()=>{"kg"!==ek&&tz(e=>!e)},className:"mt-3 rounded-full px-3 py-1 text-xs font-semibold ".concat(au?"bg-slate-900 text-white":"border border-slate-200 bg-white text-slate-600"," ").concat("kg"===ek?"cursor-not-allowed opacity-50":""),type:"button",disabled:"kg"===ek,children:"Joins view"}),(0,s.jsx)("button",{onClick:()=>ah(am),className:"mt-3 rounded-full border border-slate-200 bg-white px-3 py-1 text-xs font-semibold text-slate-600",type:"button",children:"Show all"}),(0,s.jsx)("div",{className:"mt-4 grid grid-cols-2 gap-2",children:am.filter(e=>"kg"!==e).map(e=>(0,s.jsxs)("button",{onClick:()=>aQ(e),className:"rounded-2xl border border-slate-200 bg-white px-3 py-2 text-xs font-semibold text-slate-600",type:"button",children:["Add ",e]},e))})]}),eR&&(0,s.jsx)("p",{className:"text-xs text-slate-500",children:eR})]}),(0,s.jsxs)(r.E.section,{ref:ec,initial:{opacity:0,y:10},animate:{opacity:1,y:0},className:"flex min-h-[560px] w-full flex-1 flex-col gap-4 rounded-3xl border border-white/60 p-4 shadow-2xl ".concat(eW?"bg-white":"bg-white/70"),children:[(0,s.jsxs)("div",{className:"flex flex-wrap items-center justify-between gap-3 px-2",children:[(0,s.jsxs)("div",{className:"flex items-center gap-2 text-xs font-semibold uppercase tracking-[0.2em] text-slate-400",children:["Canvas",ev&&(0,s.jsx)("span",{className:"rounded-full bg-amber-100 px-3 py-1 text-[11px] font-semibold text-amber-700",children:"Linking mode"}),!av&&(0,s.jsxs)("span",{className:"rounded-full bg-slate-200 px-3 py-1 text-[11px] font-semibold text-slate-600",children:["Filter: ",aN||"none"]})]}),(0,s.jsxs)("div",{className:"flex flex-wrap items-center gap-2",children:[(0,s.jsxs)("div",{className:"flex items-center gap-1 rounded-full border border-slate-200 bg-white px-2 py-1",children:[(0,s.jsx)("button",{onClick:()=>e_("data"),className:"rounded-full px-2 py-1 text-[11px] font-semibold ".concat("data"===ek?"bg-slate-900 text-white":"text-slate-500"),type:"button",children:"Data model"}),(0,s.jsx)("button",{onClick:()=>e_("kg"),className:"rounded-full px-2 py-1 text-[11px] font-semibold ".concat("kg"===ek?"bg-slate-900 text-white":"text-slate-500"),type:"button",children:"KG"})]}),(0,s.jsx)("button",{onClick:aV,className:"rounded-full border border-slate-200 bg-white px-3 py-1 text-xs font-semibold text-slate-600",type:"button",children:eW?"Exit full screen":"Full screen"}),(0,s.jsx)("button",{onClick:()=>{"kg"!==ek&&tz(e=>!e)},className:"rounded-full px-3 py-1 text-xs font-semibold ".concat(au?"bg-slate-900 text-white":"border border-slate-200 bg-white text-slate-600"," ").concat("kg"===ek?"cursor-not-allowed opacity-50":""),type:"button",disabled:"kg"===ek,children:"Joins view"}),(0,s.jsx)("div",{className:"flex items-center gap-1 rounded-full border border-slate-200 bg-white px-2 py-1",children:am.map(e=>(0,s.jsx)("button",{onClick:()=>eC(t=>({...t,[e]:!t[e]})),className:"rounded-full px-2 py-1 text-[11px] font-semibold ".concat(eS[e]?"bg-slate-900 text-white":"text-slate-500"),type:"button",children:e},e))}),(0,s.jsx)("div",{className:"flex items-center gap-1 rounded-full border border-slate-200 bg-white px-2 py-1",children:am.filter(e=>"kg"!==e).map(e=>(0,s.jsxs)("button",{onClick:()=>aQ(e),className:"rounded-full px-2 py-1 text-[11px] font-semibold text-slate-600",type:"button",children:["+ ",e]},e))}),!av&&(0,s.jsx)("button",{onClick:()=>{ah(am),requestAnimationFrame(()=>ak(eu))},className:"rounded-full border border-slate-200 bg-white px-3 py-1 text-xs font-semibold text-slate-600",type:"button",children:"Show all"}),(0,s.jsx)("button",{onClick:()=>eN(null),className:"rounded-full border border-slate-200 bg-white px-3 py-1 text-xs font-semibold text-slate-600",type:"button",children:"Cancel link"}),(0,s.jsx)("button",{onClick:()=>{let e=new Set(ag.map(e=>e.id)),t=ef.filter(t=>e.has(t.from)&&e.has(t.to));if(au){let e=N(ag,t);eh(t=>j(t,e));return}let a=v(ag,new Map);eh(e=>j(e,a))},className:"rounded-full bg-slate-900 px-3 py-1 text-xs font-semibold text-white shadow transition hover:-translate-y-0.5",type:"button",children:"Auto layout"}),(0,s.jsx)("button",{onClick:()=>ak(ag.length?ag:eu),className:"rounded-full border border-slate-200 bg-white px-3 py-1 text-xs font-semibold text-slate-600",type:"button",children:"Fit"}),(0,s.jsx)("button",{onClick:()=>{ez(1),eX({x:0,y:0})},className:"rounded-full border border-slate-200 bg-white px-3 py-1 text-xs font-semibold text-slate-600",type:"button",children:"Reset"}),t8&&(0,s.jsx)("button",{onClick:aL,className:"rounded-full border border-emerald-200 bg-emerald-50 px-3 py-1 text-xs font-semibold text-emerald-700",type:"button",children:"Clear focus"}),(0,s.jsxs)("div",{className:"flex items-center gap-2 rounded-full border border-slate-200 bg-white px-3 py-1",children:[(0,s.jsx)("button",{onClick:()=>ez(e=>k(e-.1,.4,2)),className:"text-xs font-semibold text-slate-600",type:"button",children:"-"}),(0,s.jsx)("input",{type:"range",min:.4,max:2,step:.05,value:eY,onChange:e=>ez(Number(e.target.value)),className:"h-1 w-24 accent-slate-700"}),(0,s.jsx)("button",{onClick:()=>ez(e=>k(e+.1,.4,2)),className:"text-xs font-semibold text-slate-600",type:"button",children:"+"}),(0,s.jsxs)("span",{className:"text-[11px] font-semibold text-slate-500",children:[Math.round(100*eY),"%"]})]})]})]}),(0,s.jsxs)("div",{ref:ed,onPointerDown:e=>{e.target.closest("[data-node]")||eV({startX:e.clientX,startY:e.clientY,originX:eU.x,originY:eU.y})},onDoubleClick:aT,onClick:e=>{2===e.detail&&aT(e)},onWheel:e=>{e.preventDefault();let t=k(eY+-(.0015*e.deltaY),.4,2),a=ed.current;if(!a){ez(t);return}let s=a.getBoundingClientRect(),l=e.clientX-s.left,r=e.clientY-s.top,n=(l-eU.x)/eY,i=(r-eU.y)/eY,o=l-n*t,d=r-i*t;ez(t),eX({x:o,y:d})},className:"relative flex-1 overflow-hidden rounded-2xl border border-white/70 ".concat(eW?"bg-white":"bg-gradient-to-br from-white/70 via-white/30 to-white/90"),style:{backgroundImage:"radial-gradient(circle at 1px 1px, rgba(15, 23, 42, 0.08) 1px, transparent 0)",backgroundSize:"28px 28px",cursor:eQ?"grabbing":"grab"},children:[(0,s.jsxs)("div",{className:"absolute left-0 top-0",style:{width:t9.width,height:t9.height,transform:"translate(".concat(eU.x,"px, ").concat(eU.y,"px) scale(").concat(eY,")"),transformOrigin:"0 0"},children:[(0,s.jsxs)("svg",{className:"pointer-events-none absolute left-0 top-0 z-20",width:t9.width,height:t9.height,children:[(0,s.jsx)("defs",{children:(0,s.jsx)("marker",{id:"arrow",markerWidth:"10",markerHeight:"10",refX:"10",refY:"3",orient:"auto",markerUnits:"strokeWidth",children:(0,s.jsx)("path",{d:"M0,0 L0,6 L9,3 z",fill:"#64748b"})})}),aI.map(e=>(0,s.jsxs)("g",{children:[(0,s.jsx)("path",{d:e.path,fill:"none",stroke:d[e.type],strokeWidth:2.2,strokeDasharray:"dependency"===e.type?"5 6":"reasoner_signal"===e.type||"reasoner_output"===e.type?"3 6":void 0,markerEnd:"url(#arrow)",opacity:aw?"dependency"===e.type&&aw.edges.has(e.id)?.9:.12:.75}),(0,s.jsx)("text",{x:e.labelX,y:e.labelY,textAnchor:"middle",className:"fill-slate-500 text-[11px] font-semibold uppercase tracking-[0.15em]",opacity:aw?"dependency"===e.type&&aw.edges.has(e.id)?.9:.12:.75,children:e.label})]},e.id))]}),ag.map(e=>(0,s.jsxs)(r.E.div,{initial:{opacity:0,scale:.96},animate:{opacity:1,scale:1},transition:{duration:.25},onPointerDown:t=>aD(t,e.id),onClick:t=>aP(e.id,t),onDoubleClick:t=>{t.stopPropagation(),aK(e.id)},"data-node":"true",className:"absolute z-10 cursor-grab rounded-2xl border border-white/80 bg-white/90 shadow-lg transition ".concat(eb===e.id?"ring-2 ring-slate-900":""),style:{left:e.x,top:e.y,width:240,height:148,opacity:aw&&!aw.nodes.has(e.id)?.25:1},children:[(0,s.jsx)("button",{type:"button",onPointerDown:e=>e.stopPropagation(),onClick:t=>{t.stopPropagation(),aK(e.id)},className:"absolute right-2 top-2 rounded-full border px-2 py-0.5 text-[10px] font-semibold ".concat(t1===e.id?"border-emerald-200 bg-emerald-50 text-emerald-700":"border-slate-200 bg-white text-slate-500"),children:t1===e.id?"Focused":"Focus"}),(0,s.jsx)("div",{className:"rounded-2xl rounded-b-none bg-gradient-to-r px-4 py-2 text-xs font-semibold uppercase tracking-[0.2em] ".concat(o[e.kind]),children:e.kind}),(0,s.jsxs)("div",{className:"flex h-[calc(100%-36px)] flex-col justify-between px-4 py-3",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("h3",{className:"text-sm font-semibold text-slate-900",children:e.label}),(0,s.jsx)("p",{className:"mt-1 text-xs text-slate-500 line-clamp-2",children:e.description})]}),(0,s.jsx)("div",{className:"flex flex-wrap items-center gap-2",children:e.tags.map(e=>{let t="reasoner-output"===e?"bg-rose-100 text-rose-700":"bg-slate-100 text-slate-500";return(0,s.jsx)("span",{className:"rounded-full px-2 py-1 text-[10px] font-semibold ".concat(t),children:e},e)})})]}),(0,s.jsx)("button",{onClick:t=>{t.stopPropagation(),aG(e.id)},className:"absolute -right-2 top-1/2 h-7 w-7 -translate-y-1/2 rounded-full border border-white bg-slate-900 text-xs font-bold text-white shadow-md",type:"button",children:"+"})]},e.id))]}),eW&&(0,s.jsxs)("div",{className:"pointer-events-auto absolute bottom-4 right-4 w-96 max-h-[calc(100vh-6rem)] overflow-y-auto rounded-2xl border border-white/60 bg-white/90 p-4 pr-3 shadow-xl backdrop-blur",children:[(0,s.jsx)("p",{className:"text-xs font-semibold uppercase tracking-[0.2em] text-slate-400",children:"Logic"}),(0,s.jsx)("p",{className:"mt-2 text-xs text-slate-500",children:t7?t7.label:"Select a node"}),(null==t7?void 0:t7.kind)==="derived"&&(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)("textarea",{value:eH,onChange:e=>e$(e.target.value),placeholder:"Define formula or rule...",className:"mt-3 h-32 w-full rounded-2xl border border-slate-200 bg-white px-3 py-2 text-xs text-slate-600"}),(0,s.jsx)("input",{value:e0,readOnly:!0,placeholder:"Auto from expression",className:"mt-2 w-full rounded-2xl border border-slate-200 bg-slate-50 px-3 py-2 text-xs text-slate-600"}),(0,s.jsx)("button",{type:"button",onClick:aW,className:"mt-3 w-full rounded-2xl bg-slate-900 px-3 py-2 text-xs font-semibold text-white shadow",children:"Apply rule"}),(0,s.jsxs)("button",{type:"button",onClick:su,className:"mt-2 w-full rounded-2xl border border-rose-200 bg-rose-50 px-3 py-2 text-xs font-semibold text-rose-600",children:["Delete ",t7.kind]})]}),(null==t7?void 0:t7.kind)==="reasoner"&&(0,s.jsxs)(s.Fragment,{children:[sN&&(0,s.jsx)("datalist",{id:"reasoner-output-".concat((null==sb?void 0:sb.id)||"unknown"),children:sN.options.map(e=>(0,s.jsx)("option",{value:e},e))}),(0,s.jsxs)("div",{className:"mt-3 flex items-center justify-between",children:[(0,s.jsx)("p",{className:"text-xs font-semibold uppercase tracking-[0.2em] text-slate-400",children:"Signals"}),(0,s.jsx)("button",{type:"button",onClick:si,className:"rounded-full border border-slate-200 bg-white px-3 py-1 text-xs font-semibold text-slate-600",children:"+ Signal"})]}),(0,s.jsxs)("div",{className:"mt-3 flex items-center justify-between",children:[(0,s.jsx)("p",{className:"text-xs font-semibold uppercase tracking-[0.2em] text-slate-400",children:"Outputs"}),(0,s.jsx)("button",{type:"button",onClick:sa,className:"rounded-full border border-slate-200 bg-white px-3 py-1 text-xs font-semibold text-slate-600",children:"+ Output"})]}),(null==sN?void 0:null===(C=sN.entityNames)||void 0===C?void 0:C.length)?(0,s.jsxs)("p",{className:"mt-2 text-xs text-slate-500",children:["Entity type: ",(null==sb?void 0:sb.entity_type)||"generic"," - Entities:"," ",sN.entityNames.join(", ")]}):(0,s.jsxs)("p",{className:"mt-2 text-xs text-rose-500",children:["No entities found for entity_type ",(null==sb?void 0:sb.entity_type)||"generic","."]}),(0,s.jsxs)("div",{className:"mt-2 space-y-2",children:[0===((null===(D=ae.reasonerMap.get(t7.ref.reasonerId||""))||void 0===D?void 0:D.outputs)||[]).length&&(0,s.jsx)("p",{className:"text-xs text-slate-500",children:"No outputs yet."}),((null===(B=ae.reasonerMap.get(t7.ref.reasonerId||""))||void 0===B?void 0:B.outputs)||[]).map((e,t)=>(0,s.jsxs)("div",{className:"rounded-2xl border border-slate-200 p-3",children:[(0,s.jsxs)("div",{className:"flex items-center gap-2",children:[(0,s.jsx)("input",{value:e,list:"reasoner-output-".concat((null==sb?void 0:sb.id)||"unknown"),onChange:e=>ss(t,e.target.value),placeholder:"output_field",className:"flex-1 rounded-xl border border-slate-200 px-2 py-1 text-xs"}),(0,s.jsx)("button",{type:"button",onClick:()=>sl(t),className:"rounded-xl border border-rose-200 bg-rose-50 px-2 py-1 text-xs text-rose-600",children:"Remove"})]}),(()=>{var t;let a=e?null==sN?void 0:sN.fieldMap.get(e):null;return e?a?(0,s.jsxs)("div",{className:"mt-2 text-xs text-slate-500",children:[(0,s.jsxs)("p",{children:[a.field.derived?"derived":"base"," - ",a.entity.name]}),(0,s.jsx)("p",{className:"mt-1 text-slate-600",children:I(ex,a.entity.name,a.field)}),(null===(t=a.field.depends_on)||void 0===t?void 0:t.length)?(0,s.jsxs)("p",{className:"mt-1 text-slate-400",children:["depends_on: ",a.field.depends_on.join(", ")]}):null]}):(0,s.jsxs)("p",{className:"mt-2 text-xs text-rose-500",children:["Output not found on entity type ",(null==sb?void 0:sb.entity_type)||"generic","."]}):(0,s.jsx)("p",{className:"mt-2 text-xs text-slate-400",children:"Select an output field."})})()]},"".concat(e,"-").concat(t)))]}),(0,s.jsxs)("div",{className:"mt-2 max-h-56 space-y-3 overflow-auto pr-1",children:[0===to.length&&(0,s.jsx)("p",{className:"text-xs text-slate-500",children:"No signals yet."}),to.map((e,t)=>{var a;return(0,s.jsx)("div",{className:"rounded-2xl border border-slate-200 p-3",children:(0,s.jsxs)("div",{className:"grid grid-cols-2 gap-2",children:[(0,s.jsx)("input",{value:e.name,onChange:e=>st(t,{name:e.target.value}),placeholder:"name",className:"rounded-xl border border-slate-200 px-2 py-1 text-xs"}),(0,s.jsx)("input",{value:e.metric_field,onChange:e=>st(t,{metric_field:e.target.value}),placeholder:"metric_field",className:"rounded-xl border border-slate-200 px-2 py-1 text-xs"}),(0,s.jsx)("input",{value:e.threshold,type:"number",onChange:e=>st(t,{threshold:Number(e.target.value)||0}),placeholder:"threshold",className:"rounded-xl border border-slate-200 px-2 py-1 text-xs"}),(0,s.jsxs)("select",{value:e.direction,onChange:e=>st(t,{direction:e.target.value}),className:"rounded-xl border border-slate-200 px-2 py-1 text-xs",children:[(0,s.jsx)("option",{value:"below",children:"below"}),(0,s.jsx)("option",{value:"above",children:"above"}),(0,s.jsx)("option",{value:"equals",children:"equals"})]}),(0,s.jsx)("input",{value:null!==(a=e.weight)&&void 0!==a?a:"",type:"number",onChange:e=>st(t,{weight:""===e.target.value?void 0:Number(e.target.value)}),placeholder:"weight",className:"rounded-xl border border-slate-200 px-2 py-1 text-xs"}),(0,s.jsx)("button",{type:"button",onClick:()=>so(t),className:"rounded-xl border border-rose-200 bg-rose-50 px-2 py-1 text-xs text-rose-600",children:"Remove"})]})},"".concat(e.name,"-").concat(t))})]}),(0,s.jsxs)("div",{className:"mt-3 rounded-2xl border border-slate-100 bg-slate-50 px-3 py-3",children:[(0,s.jsx)("p",{className:"text-[11px] font-semibold uppercase tracking-[0.2em] text-slate-400",children:"Drilldown plan"}),(0,s.jsx)("textarea",{value:tc,onChange:e=>tp(e.target.value),placeholder:'{"steps":[...]}',className:"mt-2 h-40 w-full rounded-2xl border border-slate-200 bg-white px-3 py-2 text-xs text-slate-600"}),(0,s.jsxs)("div",{className:"mt-2 flex flex-wrap gap-2",children:[(0,s.jsx)("button",{type:"button",onClick:aZ,className:"rounded-xl bg-slate-900 px-3 py-2 text-xs font-semibold text-white shadow",children:"Apply plan JSON"}),(0,s.jsx)("button",{type:"button",onClick:aH,disabled:eD,className:"rounded-xl border border-slate-200 bg-white px-3 py-2 text-xs font-semibold text-slate-700",children:"Generate plan"})]}),(0,s.jsx)("textarea",{value:tx,onChange:e=>tm(e.target.value),placeholder:"Describe the drilldown steps in natural language...",className:"mt-2 h-16 w-full rounded-2xl border border-slate-200 bg-white px-3 py-2 text-xs text-slate-600"}),tu&&(0,s.jsx)("p",{className:"mt-2 text-xs text-slate-500",children:tu})]}),(0,s.jsxs)("div",{className:"mt-3 rounded-2xl border border-slate-100 bg-slate-50 px-3 py-3",children:[(0,s.jsx)("p",{className:"text-[11px] font-semibold uppercase tracking-[0.2em] text-slate-400",children:"Reasoner sanity query"}),(0,s.jsxs)("div",{className:"mt-2 grid grid-cols-2 gap-2",children:[(0,s.jsx)("input",{value:tM,onChange:e=>tE(e.target.value),placeholder:"step_id (e.g. worst_ops)",className:"rounded-xl border border-slate-200 px-2 py-1 text-xs"}),(0,s.jsx)("input",{value:tD,onChange:e=>tI(e.target.value),placeholder:"limit",className:"rounded-xl border border-slate-200 px-2 py-1 text-xs"}),(0,s.jsx)("input",{value:tO,onChange:e=>tA(e.target.value),placeholder:"window_start (optional)",className:"rounded-xl border border-slate-200 px-2 py-1 text-xs"}),(0,s.jsx)("input",{value:tR,onChange:e=>tJ(e.target.value),placeholder:"window_end (optional)",className:"rounded-xl border border-slate-200 px-2 py-1 text-xs"})]}),(0,s.jsx)("button",{type:"button",onClick:async()=>{if(null==t7?void 0:t7.ref.reasonerId){if(!tM.trim()){tL("step_id is required.");return}tL("Running sanity query..."),tP("");try{let e=await fetch("".concat(ep,"/api/registry/reasoners/sanity"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({reasoner_id:t7.ref.reasonerId,step_id:tM.trim(),window_start:tO||void 0,window_end:tR||void 0,limit:Number(tD)||5})}),t=await e.json();if(!e.ok){tL((null==t?void 0:t.detail)||"Sanity query failed.");return}tL("OK (".concat((null==t?void 0:t.row_count)||0," rows)")),tP(JSON.stringify(t,null,2))}catch(e){tL("Sanity query failed.")}}},className:"mt-2 w-full rounded-xl bg-slate-900 px-3 py-2 text-xs font-semibold text-white shadow",children:"Run sanity query"}),tG&&(0,s.jsx)("p",{className:"mt-2 text-xs text-slate-500",children:tG}),tT&&(0,s.jsx)("textarea",{readOnly:!0,value:tT,className:"mt-2 h-40 w-full rounded-2xl border border-slate-200 bg-white px-3 py-2 text-xs text-slate-600"})]}),(0,s.jsx)("button",{type:"button",onClick:aW,className:"mt-3 w-full rounded-2xl bg-slate-900 px-3 py-2 text-xs font-semibold text-white shadow",children:"Apply reasoner rules"}),(0,s.jsxs)("button",{type:"button",onClick:su,className:"mt-2 w-full rounded-2xl border border-rose-200 bg-rose-50 px-3 py-2 text-xs font-semibold text-rose-600",children:["Delete ",t7.kind]})]}),(null==t7?void 0:t7.kind)==="entity"&&(0,s.jsxs)("button",{type:"button",onClick:su,className:"mt-3 w-full rounded-2xl border border-rose-200 bg-rose-50 px-3 py-2 text-xs font-semibold text-rose-600",children:["Delete ",t7.kind]}),(0,s.jsx)("p",{className:"mt-3 text-[11px] text-slate-400",children:"Link nodes: click + on a node, then click the target node."})]}),tK&&(0,s.jsxs)("div",{className:"pointer-events-auto absolute left-1/2 top-6 w-[420px] -translate-x-1/2 rounded-3xl border border-white/60 bg-white/95 p-5 shadow-2xl backdrop-blur",children:[(0,s.jsx)("p",{className:"text-xs font-semibold uppercase tracking-[0.2em] text-slate-400",children:"edit"===tK.mode?"Edit Relationship":"Create Relationship"}),(0,s.jsxs)("p",{className:"mt-2 text-xs text-slate-500",children:[tK.from,"  ",tK.to]}),(0,s.jsxs)("div",{className:"mt-4 grid grid-cols-2 gap-2",children:[(0,s.jsx)("select",{value:tK.from,onChange:e=>tB(t=>t?{...t,from:e.target.value}:t),className:"rounded-2xl border border-slate-200 bg-white px-3 py-2 text-xs text-slate-600",children:((null==ex?void 0:ex.entities)||[]).map(e=>(0,s.jsx)("option",{value:e.name,children:e.name},e.name))}),(0,s.jsx)("select",{value:tK.to,onChange:e=>tB(t=>t?{...t,to:e.target.value}:t),className:"rounded-2xl border border-slate-200 bg-white px-3 py-2 text-xs text-slate-600",children:((null==ex?void 0:ex.entities)||[]).map(e=>(0,s.jsx)("option",{value:e.name,children:e.name},e.name))})]}),(0,s.jsx)("label",{className:"mt-4 block text-xs font-semibold uppercase tracking-[0.2em] text-slate-400",children:"Name"}),(0,s.jsx)("input",{value:tK.name,onChange:e=>tB(t=>t?{...t,name:e.target.value}:t),className:"mt-2 w-full rounded-2xl border border-slate-200 bg-white px-3 py-2 text-xs text-slate-600"}),(0,s.jsx)("label",{className:"mt-4 block text-xs font-semibold uppercase tracking-[0.2em] text-slate-400",children:"Join Keys"}),(0,s.jsx)("textarea",{value:tK.joinText,onChange:e=>tB(t=>t?{...t,joinText:e.target.value}:t),placeholder:"left_key=right_key",className:"mt-2 h-24 w-full rounded-2xl border border-slate-200 bg-white px-3 py-2 text-xs text-slate-600"}),(0,s.jsx)("label",{className:"mt-4 block text-xs font-semibold uppercase tracking-[0.2em] text-slate-400",children:"Description"}),(0,s.jsx)("textarea",{value:tK.description,onChange:e=>tB(t=>t?{...t,description:e.target.value}:t),className:"mt-2 h-20 w-full rounded-2xl border border-slate-200 bg-white px-3 py-2 text-xs text-slate-600"}),(0,s.jsxs)("div",{className:"mt-4 flex gap-2",children:[(0,s.jsx)("button",{type:"button",onClick:()=>tB(null),className:"flex-1 rounded-2xl border border-slate-200 bg-white px-3 py-2 text-xs font-semibold text-slate-600",children:"Cancel"}),(0,s.jsx)("button",{type:"button",onClick:()=>{if(!ex||!tK)return;let e=S(tK.joinText);if(!e.length){eJ("Relationship join keys are required.");return}let t=ex.relationships.map(e=>({...e}));if("edit"===tK.mode&&tK.originalName){let a=t.findIndex(e=>e.name===tK.originalName);a>=0&&(t[a]={name:tK.name||tK.originalName,from_entity:tK.from,to_entity:tK.to,description:tK.description||"User defined relationship",join_on:e})}else{let a=new Set(t.map(e=>e.name)),s=w(tK.name||"relationship",a);t.push({name:s,from_entity:tK.from,to_entity:tK.to,description:tK.description||"User defined relationship",join_on:e})}a_({...ex,relationships:t},!0),tB(null),eJ("edit"===tK.mode?"Relationship updated.":"Relationship added.")},className:"flex-1 rounded-2xl bg-slate-900 px-3 py-2 text-xs font-semibold text-white shadow",children:"Create"})]})]})]})]}),(0,s.jsx)(r.E.aside,{initial:{opacity:0,x:20},animate:{opacity:1,x:0},className:"flex w-full flex-col gap-5 rounded-3xl border border-white/60 bg-white/70 p-5 shadow-xl lg:max-h-[calc(100vh-9rem)] lg:w-80 lg:overflow-y-auto lg:pr-4",children:(0,s.jsxs)("div",{children:[(0,s.jsx)("h2",{className:"text-sm font-semibold uppercase tracking-[0.25em] text-slate-400",children:"Inspector"}),t7?(0,s.jsxs)("div",{className:"mt-4 space-y-4",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{className:"text-xs font-semibold uppercase tracking-[0.2em] text-slate-400",children:"Label"}),(0,s.jsx)("input",{value:t7.label,onChange:e=>aX(e.target.value),readOnly:"kg"===t7.kind,className:"mt-2 w-full rounded-2xl border border-slate-200 bg-white px-3 py-2 text-sm font-semibold text-slate-700"})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{className:"text-xs font-semibold uppercase tracking-[0.2em] text-slate-400",children:"Description"}),(0,s.jsx)("textarea",{value:t7.description,onChange:e=>aF(t7,e.target.value),readOnly:"kg"===t7.kind||"graph"===t7.kind,className:"mt-2 h-20 w-full rounded-2xl border border-slate-200 bg-white px-3 py-2 text-sm text-slate-600"})]}),"kg"===t7.kind?(0,s.jsx)("p",{className:"rounded-2xl border border-slate-200 bg-slate-50 px-3 py-2 text-xs text-slate-500",children:"KG nodes are read-only. Edit the KG config panel to update them."}):(0,s.jsxs)("button",{type:"button",onClick:su,className:"rounded-2xl border border-rose-200 bg-rose-50 px-3 py-2 text-xs font-semibold text-rose-600",children:["Delete ",t7.kind]}),(0,s.jsxs)("div",{className:"rounded-2xl border border-slate-100 bg-slate-50 px-4 py-3",children:[(0,s.jsx)("p",{className:"text-xs font-semibold text-slate-500",children:"Inputs"}),(0,s.jsx)("p",{className:"mt-2 text-xs text-slate-600",children:t7.inputs.length?t7.inputs.join(", "):"None"}),(0,s.jsx)("p",{className:"mt-4 text-xs font-semibold text-slate-500",children:"Outputs"}),(0,s.jsx)("p",{className:"mt-2 text-xs text-slate-600",children:t7.outputs.length?t7.outputs.join(", "):"None"})]}),"kg"===t7.kind&&(0,s.jsxs)("div",{className:"rounded-2xl border border-white/60 bg-white/90 px-4 py-4 shadow-sm",children:[(0,s.jsx)("p",{className:"text-xs font-semibold uppercase tracking-[0.2em] text-slate-400",children:"KG Node Details"}),(0,s.jsxs)("div",{className:"mt-3 space-y-2 text-xs text-slate-600",children:[(0,s.jsxs)("p",{children:["Entity: ",t7.ref.entityName||t7.label]}),(0,s.jsxs)("p",{children:["Type:"," ",(null===(F=ae.kgNodeMap.get(t7.ref.entityName||""))||void 0===F?void 0:F.node_type)||"node"]}),(0,s.jsxs)("p",{children:["Key field:"," ",(()=>{var e;let t=null===(e=ae.kgNodeMap.get(t7.ref.entityName||""))||void 0===e?void 0:e.key_field;return Array.isArray(t)?t.join(", "):t||"None"})()]}),(0,s.jsxs)("p",{children:["Label field:"," ",(null===(q=ae.kgNodeMap.get(t7.ref.entityName||""))||void 0===q?void 0:q.label_field)||"None"]}),(0,s.jsxs)("p",{children:["Properties:"," ",((null===(Y=ae.kgNodeMap.get(t7.ref.entityName||""))||void 0===Y?void 0:Y.properties)||[]).length?((null===(z=ae.kgNodeMap.get(t7.ref.entityName||""))||void 0===z?void 0:z.properties)||[]).join(", "):"None"]})]})]}),"graph"===t7.kind&&(0,s.jsxs)("div",{className:"rounded-2xl border border-white/60 bg-white/90 px-4 py-4 shadow-sm",children:[(0,s.jsx)("p",{className:"text-xs font-semibold uppercase tracking-[0.2em] text-slate-400",children:"Graph Config"}),(0,s.jsxs)("div",{className:"mt-3 space-y-3 text-xs text-slate-600",children:[(0,s.jsxs)("div",{className:"flex items-center gap-3",children:[(0,s.jsxs)("label",{className:"flex items-center gap-2",children:[(0,s.jsx)("input",{type:"checkbox",checked:tb,onChange:e=>ty(e.target.checked)}),"directed"]}),(0,s.jsxs)("label",{className:"flex items-center gap-2",children:[(0,s.jsx)("input",{type:"checkbox",checked:tv,onChange:e=>tN(e.target.checked)}),"weighted"]})]}),(0,s.jsx)("textarea",{value:tf,onChange:e=>tg(e.target.value),placeholder:"Describe what this graph captures.",className:"h-16 w-full rounded-2xl border border-slate-200 bg-white px-3 py-2 text-xs text-slate-600"}),(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{className:"text-[11px] font-semibold uppercase tracking-[0.2em] text-slate-400",children:"Nodes (JSON array)"}),(0,s.jsx)("textarea",{value:tj,onChange:e=>tw(e.target.value),placeholder:'[{"entity":"dt_operation_metrics","label_field":"pu_id"}]',className:"mt-2 h-28 w-full rounded-2xl border border-slate-200 bg-white px-3 py-2 text-xs text-slate-600"})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{className:"text-[11px] font-semibold uppercase tracking-[0.2em] text-slate-400",children:"Edges (JSON array)"}),(0,s.jsx)("textarea",{value:tk,onChange:e=>t_(e.target.value),placeholder:'[{"relation":"dt_operation_metrics.machine_id"}]',className:"mt-2 h-28 w-full rounded-2xl border border-slate-200 bg-white px-3 py-2 text-xs text-slate-600"})]}),(0,s.jsxs)("div",{className:"flex gap-2",children:[(0,s.jsx)("button",{type:"button",onClick:ar,className:"flex-1 rounded-2xl bg-slate-900 px-3 py-2 text-xs font-semibold text-white shadow",children:"Apply graph"}),(0,s.jsx)("button",{type:"button",onClick:()=>{var e;let t=((null==ex?void 0:null===(e=ex.kg)||void 0===e?void 0:e.graphs)||[]).find(e=>e.id===t7.ref.graphId);tg((null==t?void 0:t.description)||""),ty((null==t?void 0:t.directed)!==!1),tN(!!(null==t?void 0:t.weighted)),tw((null==t?void 0:t.nodes)?JSON.stringify(t.nodes,null,2):"[]"),t_((null==t?void 0:t.edges)?JSON.stringify(t.edges,null,2):"[]"),tC("")},className:"flex-1 rounded-2xl border border-slate-200 bg-white px-3 py-2 text-xs font-semibold text-slate-600",children:"Reset"})]}),tS&&(0,s.jsx)("p",{className:"text-xs text-slate-500",children:tS})]})]}),sh&&(0,s.jsxs)("div",{className:"rounded-2xl border border-white/60 bg-white/90 px-4 py-4 shadow-sm",children:[(0,s.jsx)("p",{className:"text-xs font-semibold uppercase tracking-[0.2em] text-slate-400",children:"Entity Details"}),(0,s.jsxs)("p",{className:"mt-2 text-xs text-slate-600",children:["Table: ",sh.database?"".concat(sh.database,"."):"",sh.schema?"".concat(sh.schema,"."):"",sh.table]}),(0,s.jsxs)("p",{className:"mt-2 text-xs text-slate-600",children:["Join keys: ",(null===(U=sh.join_keys)||void 0===U?void 0:U.length)?sh.join_keys.join(", "):"None"]}),(0,s.jsxs)("div",{className:"mt-4 space-y-3",children:[(0,s.jsx)("input",{value:sh.database||"",onChange:e=>a1({database:e.target.value}),placeholder:"Database",className:"w-full rounded-2xl border border-slate-200 bg-white px-3 py-2 text-xs text-slate-600"}),(0,s.jsx)("input",{value:sh.schema||"",onChange:e=>a1({schema:e.target.value}),placeholder:"Schema",className:"w-full rounded-2xl border border-slate-200 bg-white px-3 py-2 text-xs text-slate-600"}),(0,s.jsx)("input",{value:sh.table||"",onChange:e=>a1({table:e.target.value}),placeholder:"Table",className:"w-full rounded-2xl border border-slate-200 bg-white px-3 py-2 text-xs text-slate-600"}),(0,s.jsx)("input",{value:(null===(X=sh.join_keys)||void 0===X?void 0:X.join(", "))||"",onChange:e=>a1({join_keys:e.target.value.split(",").map(e=>e.trim()).filter(Boolean)}),placeholder:"Join keys (comma separated)",className:"w-full rounded-2xl border border-slate-200 bg-white px-3 py-2 text-xs text-slate-600"}),(0,s.jsx)("input",{value:sh.entity_type||"",onChange:e=>a1({entity_type:e.target.value}),placeholder:"Entity type",className:"w-full rounded-2xl border border-slate-200 bg-white px-3 py-2 text-xs text-slate-600"}),(0,s.jsx)("input",{value:sh.default_metric||"",onChange:e=>a1({default_metric:e.target.value}),placeholder:"Default metric",className:"w-full rounded-2xl border border-slate-200 bg-white px-3 py-2 text-xs text-slate-600"})]}),(0,s.jsxs)("div",{className:"mt-5 rounded-2xl border border-slate-100 bg-slate-50/60 p-3",children:[(0,s.jsxs)("div",{className:"flex items-center justify-between",children:[(0,s.jsx)("p",{className:"text-xs font-semibold uppercase tracking-[0.2em] text-slate-400",children:"Fields"}),(0,s.jsxs)("div",{className:"flex gap-2",children:[(0,s.jsx)("button",{type:"button",onClick:()=>se(sh.name),className:"rounded-full border border-slate-200 bg-white px-3 py-1 text-[11px] font-semibold text-slate-600",children:"Import"}),(0,s.jsx)("button",{type:"button",onClick:()=>a9(sh.name),className:"rounded-full border border-slate-200 bg-white px-3 py-1 text-[11px] font-semibold text-slate-600",children:"+ Field"})]})]}),(0,s.jsx)("div",{className:"mt-3 flex gap-2",children:["base","derived","all"].map(e=>(0,s.jsx)("button",{type:"button",onClick:()=>tq(e),className:"rounded-full px-3 py-1 text-[11px] font-semibold ".concat(tF===e?"bg-slate-900 text-white":"bg-white text-slate-500"),children:e},e))}),(0,s.jsxs)("div",{className:"mt-3 max-h-64 space-y-2 overflow-auto pr-1",children:[(sh.fields||[]).filter(e=>"all"===tF||("derived"===tF?e.derived:!e.derived)).map(e=>(0,s.jsxs)("div",{className:"rounded-2xl border border-slate-200 bg-white p-2",children:[(0,s.jsxs)("div",{className:"grid grid-cols-2 gap-2",children:[(0,s.jsx)("input",{value:e.name,onChange:t=>a4(sh.name,e.name,{name:t.target.value.toLowerCase()}),placeholder:"name",className:"rounded-xl border border-slate-200 px-2 py-1 text-xs"}),(0,s.jsxs)("div",{className:"flex items-center gap-2",children:[(0,s.jsx)("input",{list:"dtype-presets",value:e.dtype,onChange:t=>a4(sh.name,e.name,{dtype:t.target.value}),placeholder:"dtype",className:"flex-1 rounded-xl border border-slate-200 px-2 py-1 text-xs"}),(0,s.jsxs)("select",{value:"",onChange:t=>a4(sh.name,e.name,{dtype:t.target.value}),className:"rounded-xl border border-slate-200 px-2 py-1 text-xs",children:[(0,s.jsx)("option",{value:"",children:"preset"}),E.map(e=>(0,s.jsx)("option",{value:e.value,children:e.label},e.value))]})]}),(0,s.jsxs)("select",{value:e.role,onChange:t=>{let a=t.target.value;a4(sh.name,e.name,{role:a,default_agg:"metric"===a?e.default_agg||P(e.name,e.dtype):""})},className:"rounded-xl border border-slate-200 px-2 py-1 text-xs",children:[(0,s.jsx)("option",{value:"dimension",children:"dimension"}),(0,s.jsx)("option",{value:"metric",children:"metric"})]}),(0,s.jsxs)("select",{value:e.default_agg||"",onChange:t=>a4(sh.name,e.name,{default_agg:t.target.value}),disabled:"metric"!==e.role,className:"rounded-xl border border-slate-200 px-2 py-1 text-xs text-slate-600 disabled:cursor-not-allowed disabled:bg-slate-100",children:[(0,s.jsx)("option",{value:"",children:"default agg"}),O.filter(Boolean).map(e=>(0,s.jsx)("option",{value:e,children:e},e))]}),(0,s.jsx)("input",{value:e.expr,onChange:t=>a4(sh.name,e.name,{expr:t.target.value}),placeholder:"expr",className:"col-span-2 rounded-xl border border-slate-200 px-2 py-1 text-xs"})]}),(0,s.jsxs)("div",{className:"mt-2 flex items-center justify-between",children:[(0,s.jsxs)("span",{className:"text-[11px] text-slate-400",children:[e.derived?"derived":"base",e.default_agg?" - ".concat(e.default_agg):""]}),(0,s.jsx)("button",{type:"button",onClick:()=>a7(sh.name,e.name),className:"rounded-full border border-rose-200 bg-rose-50 px-2 py-1 text-[11px] text-rose-600",children:"Delete"})]}),"last"===e.default_agg&&(0,s.jsxs)("div",{className:"mt-2 rounded-xl border border-slate-100 bg-slate-50 px-3 py-2",children:[(0,s.jsxs)("div",{className:"flex items-center justify-between",children:[(0,s.jsx)("p",{className:"text-[11px] font-semibold uppercase tracking-[0.2em] text-slate-400",children:"Order by"}),(0,s.jsx)("button",{type:"button",onClick:()=>a5(sh.name,e.name,[...e.order_by||[],{field:"",direction:"asc"}]),className:"rounded-full border border-slate-200 bg-white px-2 py-1 text-[11px] text-slate-600",children:"+ Add"})]}),(0,s.jsxs)("div",{className:"mt-2 space-y-2",children:[0===(e.order_by||[]).length&&(0,s.jsx)("p",{className:"text-xs text-slate-500",children:"No order fields set."}),(e.order_by||[]).map((t,a)=>(0,s.jsxs)("div",{className:"grid grid-cols-3 gap-2",children:[(0,s.jsxs)("select",{value:t.field,onChange:t=>{let s=(e.order_by||[]).map((e,s)=>s===a?{...e,field:t.target.value}:e);a5(sh.name,e.name,s)},className:"col-span-2 rounded-xl border border-slate-200 px-2 py-1 text-xs",children:[(0,s.jsx)("option",{value:"",children:"field"}),(sh.fields||[]).map(e=>(0,s.jsx)("option",{value:e.name,children:e.name},e.name))]}),(0,s.jsxs)("div",{className:"flex gap-2",children:[(0,s.jsxs)("select",{value:t.direction||"asc",onChange:t=>{let s=(e.order_by||[]).map((e,s)=>s===a?{...e,direction:t.target.value}:e);a5(sh.name,e.name,s)},className:"flex-1 rounded-xl border border-slate-200 px-2 py-1 text-xs",children:[(0,s.jsx)("option",{value:"asc",children:"asc"}),(0,s.jsx)("option",{value:"desc",children:"desc"})]}),(0,s.jsx)("button",{type:"button",onClick:()=>{let t=(e.order_by||[]).filter((e,t)=>t!==a);a5(sh.name,e.name,t)},className:"rounded-xl border border-rose-200 bg-rose-50 px-2 py-1 text-xs text-rose-600",children:"Remove"})]})]},"".concat(t.field,"-").concat(a)))]})]})]},e.name)),!(null===(Q=sh.fields)||void 0===Q?void 0:Q.length)&&(0,s.jsx)("p",{className:"text-xs text-slate-500",children:"No fields yet."})]}),(0,s.jsxs)("div",{className:"mt-3 rounded-2xl border border-slate-100 bg-slate-50/80 p-3",children:[(0,s.jsxs)("div",{className:"flex items-center justify-between",children:[(0,s.jsx)("p",{className:"text-[11px] font-semibold uppercase tracking-[0.2em] text-slate-400",children:"Prev field metrics"}),(0,s.jsxs)("div",{className:"flex items-center gap-2",children:[(0,s.jsx)("button",{type:"button",onClick:()=>sn(sh.name,sf.map(e=>e.name)),className:"rounded-full border border-slate-200 bg-white px-2 py-1 text-[11px] text-slate-600",children:"Select all"}),(0,s.jsx)("button",{type:"button",onClick:()=>sn(sh.name,[]),className:"rounded-full border border-slate-200 bg-white px-2 py-1 text-[11px] text-slate-600",children:"Clear"})]})]}),(0,s.jsxs)("div",{className:"mt-2 max-h-32 space-y-1 overflow-auto pr-1",children:[!sf.length&&(0,s.jsx)("p",{className:"text-xs text-slate-500",children:"No base metrics available."}),sf.map(e=>(0,s.jsxs)("label",{className:"flex items-center gap-2 text-xs text-slate-600",children:[(0,s.jsx)("input",{type:"checkbox",checked:sg.includes(e.name),onChange:()=>sr(sh.name,e.name),className:"h-3.5 w-3.5 rounded border-slate-300"}),e.name]},e.name))]})]}),(0,s.jsx)("button",{type:"button",onClick:()=>a8(sh.name,sg),className:"mt-3 w-full rounded-2xl bg-slate-900 px-3 py-2 text-xs font-semibold text-white shadow",children:"Generate prev_ fields"})]})]}),"entity"!==t7.kind&&(0,s.jsxs)("div",{className:"space-y-3 rounded-2xl border border-white/60 bg-white/90 px-4 py-4 shadow-sm",children:[(0,s.jsx)("p",{className:"text-xs font-semibold uppercase tracking-[0.2em] text-slate-400",children:"Logic"}),"derived"===t7.kind?(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)("div",{className:"grid grid-cols-2 gap-2",children:[(0,s.jsxs)("div",{className:"flex items-center gap-2",children:[(0,s.jsx)("input",{list:"dtype-presets",value:(null===(W=ae.entityMap.get(t7.ref.entityName||""))||void 0===W?void 0:null===(V=W.fields.find(e=>e.name===t7.ref.fieldName))||void 0===V?void 0:V.dtype)||"",onChange:e=>a3({dtype:e.target.value}),placeholder:"dtype",className:"flex-1 rounded-xl border border-slate-200 px-2 py-1 text-xs text-slate-600"}),(0,s.jsxs)("select",{value:"",onChange:e=>a3({dtype:e.target.value}),className:"rounded-xl border border-slate-200 px-2 py-1 text-xs text-slate-600",children:[(0,s.jsx)("option",{value:"",children:"preset"}),E.map(e=>(0,s.jsx)("option",{value:e.value,children:e.label},e.value))]})]}),(0,s.jsxs)("select",{value:(null===(H=ae.entityMap.get(t7.ref.entityName||""))||void 0===H?void 0:null===(Z=H.fields.find(e=>e.name===t7.ref.fieldName))||void 0===Z?void 0:Z.role)||"metric",onChange:e=>a3({role:e.target.value}),className:"rounded-xl border border-slate-200 px-2 py-1 text-xs text-slate-600",children:[(0,s.jsx)("option",{value:"metric",children:"metric"}),(0,s.jsx)("option",{value:"dimension",children:"dimension"})]}),(0,s.jsx)("select",{value:(null===(ee=ae.entityMap.get(t7.ref.entityName||""))||void 0===ee?void 0:null===($=ee.fields.find(e=>e.name===t7.ref.fieldName))||void 0===$?void 0:$.default_agg)||"",onChange:e=>a3({default_agg:e.target.value}),className:"rounded-xl border border-slate-200 px-2 py-1 text-xs text-slate-600",children:O.map(e=>(0,s.jsx)("option",{value:e,children:e||"none"},e||"none"))})]}),(()=>{let e=ae.entityMap.get(t7.ref.entityName||""),t=null==e?void 0:e.fields.find(e=>e.name===t7.ref.fieldName);if(!t||"last"!==t.default_agg)return null;let a=t.order_by||[],l=((null==e?void 0:e.fields)||[]).map(e=>e.name);return(0,s.jsxs)("div",{className:"rounded-2xl border border-slate-100 bg-slate-50 px-3 py-2",children:[(0,s.jsxs)("div",{className:"flex items-center justify-between",children:[(0,s.jsx)("p",{className:"text-[11px] font-semibold uppercase tracking-[0.2em] text-slate-400",children:"Order by"}),(0,s.jsx)("button",{type:"button",onClick:()=>a5(t7.ref.entityName,t7.ref.fieldName,[...a,{field:"",direction:"asc"}]),className:"rounded-full border border-slate-200 bg-white px-2 py-1 text-[11px] text-slate-600",children:"+ Add"})]}),(0,s.jsxs)("div",{className:"mt-2 space-y-2",children:[0===a.length&&(0,s.jsx)("p",{className:"text-xs text-slate-500",children:"No order fields set."}),a.map((e,t)=>(0,s.jsxs)("div",{className:"grid grid-cols-3 gap-2",children:[(0,s.jsxs)("select",{value:e.field,onChange:e=>{let s=a.map((a,s)=>s===t?{...a,field:e.target.value}:a);a5(t7.ref.entityName,t7.ref.fieldName,s)},className:"col-span-2 rounded-xl border border-slate-200 px-2 py-1 text-xs",children:[(0,s.jsx)("option",{value:"",children:"field"}),l.map(e=>(0,s.jsx)("option",{value:e,children:e},e))]}),(0,s.jsxs)("div",{className:"flex gap-2",children:[(0,s.jsxs)("select",{value:e.direction||"asc",onChange:e=>{let s=a.map((a,s)=>s===t?{...a,direction:e.target.value}:a);a5(t7.ref.entityName,t7.ref.fieldName,s)},className:"flex-1 rounded-xl border border-slate-200 px-2 py-1 text-xs",children:[(0,s.jsx)("option",{value:"asc",children:"asc"}),(0,s.jsx)("option",{value:"desc",children:"desc"})]}),(0,s.jsx)("button",{type:"button",onClick:()=>{let e=a.filter((e,a)=>a!==t);a5(t7.ref.entityName,t7.ref.fieldName,e)},className:"rounded-xl border border-rose-200 bg-rose-50 px-2 py-1 text-xs text-rose-600",children:"Remove"})]})]},"".concat(e.field,"-").concat(t)))]})]})})(),(0,s.jsx)("label",{className:"text-xs font-semibold uppercase tracking-[0.2em] text-slate-400",children:"Expression"}),(0,s.jsx)("textarea",{value:eH,onChange:e=>e$(e.target.value),placeholder:"Define formula or rule...",className:"h-24 w-full rounded-2xl border border-slate-200 bg-white px-3 py-2 text-sm text-slate-600"}),(0,s.jsx)("label",{className:"text-xs font-semibold uppercase tracking-[0.2em] text-slate-400",children:"Depends On"}),(0,s.jsx)("input",{value:e0,readOnly:!0,placeholder:"Auto from expression",className:"w-full rounded-2xl border border-slate-200 bg-slate-50 px-3 py-2 text-sm text-slate-600"}),(()=>{let e=ae.entityMap.get(t7.ref.entityName||""),t=new Set(((null==e?void 0:e.fields)||[]).map(e=>e.name)),a=e0.split(",").map(e=>e.trim()).filter(e=>e&&!t.has(e));return a.length?(0,s.jsxs)("p",{className:"text-xs text-rose-500",children:["Missing fields: ",a.join(", ")]}):null})(),(0,s.jsx)("button",{type:"button",onClick:aW,className:"w-full rounded-2xl bg-slate-900 px-3 py-2 text-sm font-semibold text-white shadow",children:"Apply rule"}),(0,s.jsxs)("div",{className:"mt-4 rounded-2xl border border-slate-100 bg-slate-50 px-3 py-3",children:[(0,s.jsx)("p",{className:"text-[11px] font-semibold uppercase tracking-[0.2em] text-slate-400",children:"LLM helper"}),(0,s.jsx)("textarea",{value:e6,onChange:e=>e4(e.target.value),placeholder:"Describe the logic in natural language...",className:"mt-2 h-20 w-full rounded-2xl border border-slate-200 bg-white px-3 py-2 text-sm text-slate-600"}),(0,s.jsxs)("div",{className:"mt-2 flex flex-wrap gap-2",children:[(0,s.jsx)("button",{type:"button",onClick:a$,className:"rounded-xl border border-slate-200 bg-white px-3 py-2 text-xs font-semibold text-slate-700",children:"Generate rule"}),(0,s.jsx)("button",{type:"button",onClick:a0,className:"rounded-xl border border-slate-200 bg-white px-3 py-2 text-xs font-semibold text-slate-700",children:"Validate rule"}),(0,s.jsx)("button",{type:"button",onClick:()=>{ex&&(null==t7?void 0:t7.ref.entityName)&&(null==t7?void 0:t7.ref.fieldName)&&"derived"===t7.kind&&(e3(JSON.stringify(G(t7.ref.entityName,t7.ref.fieldName,eH||""),null,2)),e8([]),e9("Rule JSON synced from expression."),tt(""),ts(""))},className:"rounded-xl border border-slate-200 bg-white px-3 py-2 text-xs font-semibold text-slate-700",children:"Sync from expression"})]}),e5&&(0,s.jsx)("p",{className:"mt-2 text-xs text-slate-500",children:e5})]}),(0,s.jsxs)("div",{className:"mt-4 rounded-2xl border border-slate-100 bg-slate-50 px-3 py-3",children:[(0,s.jsx)("p",{className:"text-[11px] font-semibold uppercase tracking-[0.2em] text-slate-400",children:"Rule JSON"}),(0,s.jsx)("textarea",{value:e1,onChange:e=>e3(e.target.value),placeholder:'{"entity":"...","field":"...","rules":[{"expr":"..."}]}',className:"mt-2 h-40 w-full rounded-2xl border border-slate-200 bg-white px-3 py-2 text-xs text-slate-600"}),(0,s.jsx)("div",{className:"mt-2 flex gap-2",children:(0,s.jsx)("button",{type:"button",onClick:()=>{if(!ex||!(null==t7?void 0:t7.ref.entityName)||!(null==t7?void 0:t7.ref.fieldName)||"derived"!==t7.kind)return;let e=null;try{e=JSON.parse(e1||"")}catch(e){eJ("Rule JSON is invalid.");return}if(!e||"object"!=typeof e){eJ("Rule JSON is invalid.");return}let t={entity:e.entity||t7.ref.entityName,field:e.field||t7.ref.fieldName,rules:e.rules||[],vars:e.vars||{},description:e.description||""};if(!t.rules||0===t.rules.length){eJ("Rule JSON must include at least one rule.");return}let a=ex.entities.find(e=>e.name===t.entity),s=((null==a?void 0:a.fields)||[]).map(e=>e.name),l=null==a?void 0:a.fields.find(e=>e.name===t.field),r=A(L(t,s,t.field),null==l?void 0:l.order_by),n=1!==t.rules.length||t.rules[0].when?eH:t.rules[0].expr;em({...ex,derived_rel_rules:J(ex,t),entities:ex.entities.map(e=>e.name!==t.entity?e:{...e,fields:e.fields.map(e=>e.name===t.field?{...e,expr:n,depends_on:r}:e)})}),e$(n||""),e2(r.join(", ")),e3(JSON.stringify(t,null,2)),e8([]),e9("Rule JSON applied."),tt(""),ts(""),eJ("Derived rule updated.")},className:"rounded-xl bg-slate-900 px-3 py-2 text-xs font-semibold text-white shadow",children:"Apply rule JSON"})}),e7.length>0&&(0,s.jsx)("div",{className:"mt-2 rounded-xl border border-rose-200 bg-rose-50 px-3 py-2 text-xs text-rose-600",children:e7.map((e,t)=>(0,s.jsx)("p",{children:e},"".concat(e,"-").concat(t)))})]}),(0,s.jsxs)("div",{className:"mt-4 rounded-2xl border border-slate-100 bg-slate-50 px-3 py-3",children:[(0,s.jsx)("p",{className:"text-[11px] font-semibold uppercase tracking-[0.2em] text-slate-400",children:"Snowflake SQL"}),(0,s.jsx)("textarea",{value:te,readOnly:!0,placeholder:"Generate SQL from the rule JSON...",className:"mt-2 h-40 w-full rounded-2xl border border-slate-200 bg-white px-3 py-2 text-xs text-slate-600"}),(0,s.jsx)("div",{className:"mt-2 flex gap-2",children:(0,s.jsx)("button",{type:"button",onClick:a2,disabled:eD,className:"rounded-xl border border-slate-200 bg-white px-3 py-2 text-xs font-semibold text-slate-700",children:"Generate SQL"})}),ta&&(0,s.jsx)("p",{className:"mt-2 text-xs text-slate-500",children:ta})]})]}):(0,s.jsxs)("div",{className:"space-y-3",children:[sy&&(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)("div",{className:"rounded-2xl border border-indigo-100 bg-indigo-50 px-3 py-2 text-xs text-indigo-700",children:"Graph reasoners execute inside RAI using the selected graph topology. Edit the graph node to change traversal and aggregation."}),(0,s.jsxs)("div",{className:"grid grid-cols-2 gap-2",children:[(0,s.jsx)("input",{value:(null===(et=ae.reasonerMap.get(t7.ref.reasonerId||""))||void 0===et?void 0:et.entity_type)||"",onChange:e=>a6({entity_type:e.target.value}),placeholder:"Entity type",className:"rounded-xl border border-slate-200 px-2 py-1 text-xs text-slate-600"}),(0,s.jsx)("input",{value:(null===(ea=ae.reasonerMap.get(t7.ref.reasonerId||""))||void 0===ea?void 0:ea.type)||"",onChange:e=>a6({type:e.target.value}),placeholder:"Type",className:"rounded-xl border border-slate-200 px-2 py-1 text-xs text-slate-600"})]}),(0,s.jsxs)("div",{className:"mt-3",children:[(0,s.jsx)("label",{className:"text-xs font-semibold uppercase tracking-[0.2em] text-slate-400",children:"Graph binding"}),(0,s.jsx)("input",{list:"graph-id-options",value:sv,onChange:e=>a6({graph_id:e.target.value.trim()}),placeholder:"graph id (required)",className:"mt-2 w-full rounded-2xl border border-slate-200 bg-white px-3 py-2 text-xs text-slate-600"}),(0,s.jsx)("datalist",{id:"graph-id-options",children:(ae.kgGraphs||[]).map(e=>(0,s.jsx)("option",{value:e.id},e.id))}),sv?(ae.kgGraphs||[]).some(e=>e.id===sv)?(0,s.jsxs)("p",{className:"mt-2 text-xs text-emerald-600",children:["Bound to graph ",sv,"."]}):(0,s.jsx)("p",{className:"mt-2 text-xs text-rose-600",children:"Graph id not found in KG graphs."}):(0,s.jsx)("p",{className:"mt-2 text-xs text-amber-600",children:"Missing graph id. Graph reasoners must bind to a graph."}),(0,s.jsx)("div",{className:"mt-2 flex gap-2",children:(0,s.jsx)("button",{type:"button",onClick:()=>{sv&&ey(u(sv))},className:"rounded-full border border-slate-200 bg-white px-3 py-1 text-[11px] font-semibold text-slate-600",children:"Open graph"})})]})]}),!sy&&(0,s.jsxs)("div",{className:"space-y-3",children:[(0,s.jsxs)("div",{className:"grid grid-cols-2 gap-2",children:[(0,s.jsx)("input",{value:(null===(es=ae.reasonerMap.get(t7.ref.reasonerId||""))||void 0===es?void 0:es.entity_type)||"",onChange:e=>a6({entity_type:e.target.value}),placeholder:"Entity type",className:"rounded-xl border border-slate-200 px-2 py-1 text-xs text-slate-600"}),(0,s.jsx)("input",{value:(null===(el=ae.reasonerMap.get(t7.ref.reasonerId||""))||void 0===el?void 0:el.type)||"",onChange:e=>a6({type:e.target.value}),placeholder:"Type",className:"rounded-xl border border-slate-200 px-2 py-1 text-xs text-slate-600"})]}),(0,s.jsxs)("div",{className:"mt-3",children:[(0,s.jsx)("label",{className:"text-xs font-semibold uppercase tracking-[0.2em] text-slate-400",children:"Graph binding"}),(0,s.jsx)("input",{list:"graph-id-options",value:(null===(er=ae.reasonerMap.get(t7.ref.reasonerId||""))||void 0===er?void 0:er.graph_id)||"",onChange:e=>a6({graph_id:e.target.value.trim()}),placeholder:"graph id (optional)",className:"mt-2 w-full rounded-2xl border border-slate-200 bg-white px-3 py-2 text-xs text-slate-600"}),(0,s.jsx)("datalist",{id:"graph-id-options",children:(ae.kgGraphs||[]).map(e=>(0,s.jsx)("option",{value:e.id},e.id))}),(()=>{var e;let t=(null===(e=ae.reasonerMap.get(t7.ref.reasonerId||""))||void 0===e?void 0:e.graph_id)||"";return t?(ae.kgGraphs||[]).some(e=>e.id===t)?(0,s.jsxs)("p",{className:"mt-2 text-xs text-emerald-600",children:["Bound to graph ",t,"."]}):(0,s.jsx)("p",{className:"mt-2 text-xs text-rose-600",children:"Graph id not found in KG graphs."}):(0,s.jsx)("p",{className:"mt-2 text-xs text-amber-600",children:"Unbound to graph (legacy reasoner)."})})()]}),sN&&(0,s.jsx)("datalist",{id:"reasoner-output-".concat((null==sb?void 0:sb.id)||"unknown"),children:sN.options.map(e=>(0,s.jsx)("option",{value:e},e))}),(0,s.jsxs)("div",{className:"flex items-center justify-between",children:[(0,s.jsx)("p",{className:"text-xs font-semibold uppercase tracking-[0.2em] text-slate-400",children:"Outputs"}),(0,s.jsx)("button",{type:"button",onClick:sa,className:"rounded-full border border-slate-200 bg-white px-3 py-1 text-xs font-semibold text-slate-600",children:"+ Output"})]}),(null==sN?void 0:null===(en=sN.entityNames)||void 0===en?void 0:en.length)?(0,s.jsxs)("p",{className:"mt-2 text-xs text-slate-500",children:["Entity type: ",(null==sb?void 0:sb.entity_type)||"generic"," - Entities:"," ",sN.entityNames.join(", ")]}):(0,s.jsxs)("p",{className:"mt-2 text-xs text-rose-500",children:["No entities found for entity_type ",(null==sb?void 0:sb.entity_type)||"generic","."]}),(0,s.jsxs)("div",{className:"space-y-2",children:[0===((null===(ei=ae.reasonerMap.get(t7.ref.reasonerId||""))||void 0===ei?void 0:ei.outputs)||[]).length&&(0,s.jsx)("p",{className:"text-xs text-slate-500",children:"No outputs yet."}),((null===(eo=ae.reasonerMap.get(t7.ref.reasonerId||""))||void 0===eo?void 0:eo.outputs)||[]).map((e,t)=>(0,s.jsxs)("div",{className:"rounded-2xl border border-slate-200 p-3",children:[(0,s.jsxs)("div",{className:"flex items-center gap-2",children:[(0,s.jsx)("input",{value:e,list:"reasoner-output-".concat((null==sb?void 0:sb.id)||"unknown"),onChange:e=>ss(t,e.target.value),placeholder:"output_field",className:"flex-1 rounded-xl border border-slate-200 px-2 py-1 text-xs"}),(0,s.jsx)("button",{type:"button",onClick:()=>sl(t),className:"rounded-xl border border-rose-200 bg-rose-50 px-2 py-1 text-xs text-rose-600",children:"Remove"})]}),(()=>{var t;let a=e?null==sN?void 0:sN.fieldMap.get(e):null;return e?a?(0,s.jsxs)("div",{className:"mt-2 text-xs text-slate-500",children:[(0,s.jsxs)("p",{children:[a.field.derived?"derived":"base"," - ",a.entity.name]}),(0,s.jsx)("p",{className:"mt-1 text-slate-600",children:I(ex,a.entity.name,a.field)}),(null===(t=a.field.depends_on)||void 0===t?void 0:t.length)?(0,s.jsxs)("p",{className:"mt-1 text-slate-400",children:["depends_on: ",a.field.depends_on.join(", ")]}):null]}):(0,s.jsxs)("p",{className:"mt-2 text-xs text-rose-500",children:["Output not found on entity type ",(null==sb?void 0:sb.entity_type)||"generic","."]}):(0,s.jsx)("p",{className:"mt-2 text-xs text-slate-400",children:"Select an output field."})})()]},"".concat(e,"-").concat(t)))]}),(0,s.jsxs)("div",{className:"mt-3 flex items-center justify-between",children:[(0,s.jsx)("p",{className:"text-xs font-semibold uppercase tracking-[0.2em] text-slate-400",children:"Signals"}),(0,s.jsx)("button",{type:"button",onClick:si,className:"rounded-full border border-slate-200 bg-white px-3 py-1 text-xs font-semibold text-slate-600",children:"+ Signal"})]}),(0,s.jsxs)("div",{className:"space-y-3",children:[0===to.length&&(0,s.jsx)("p",{className:"text-xs text-slate-500",children:"No signals yet."}),to.map((e,t)=>{var a;return(0,s.jsx)("div",{className:"rounded-2xl border border-slate-200 p-3",children:(0,s.jsxs)("div",{className:"grid grid-cols-2 gap-2",children:[(0,s.jsx)("input",{value:e.name,onChange:e=>st(t,{name:e.target.value}),placeholder:"name",className:"rounded-xl border border-slate-200 px-2 py-1 text-xs"}),(0,s.jsx)("input",{value:e.metric_field,onChange:e=>st(t,{metric_field:e.target.value}),placeholder:"metric_field",className:"rounded-xl border border-slate-200 px-2 py-1 text-xs"}),(0,s.jsx)("input",{value:e.threshold,type:"number",onChange:e=>st(t,{threshold:Number(e.target.value)||0}),placeholder:"threshold",className:"rounded-xl border border-slate-200 px-2 py-1 text-xs"}),(0,s.jsxs)("select",{value:e.direction,onChange:e=>st(t,{direction:e.target.value}),className:"rounded-xl border border-slate-200 px-2 py-1 text-xs",children:[(0,s.jsx)("option",{value:"below",children:"below"}),(0,s.jsx)("option",{value:"above",children:"above"}),(0,s.jsx)("option",{value:"equals",children:"equals"})]}),(0,s.jsx)("input",{value:null!==(a=e.weight)&&void 0!==a?a:"",type:"number",onChange:e=>st(t,{weight:""===e.target.value?void 0:Number(e.target.value)}),placeholder:"weight",className:"rounded-xl border border-slate-200 px-2 py-1 text-xs"}),(0,s.jsx)("button",{type:"button",onClick:()=>so(t),className:"rounded-xl border border-rose-200 bg-rose-50 px-2 py-1 text-xs text-rose-600",children:"Remove"})]})},"".concat(e.name,"-").concat(t))})]}),(0,s.jsxs)("div",{className:"mt-3 rounded-2xl border border-slate-100 bg-slate-50 px-3 py-3",children:[(0,s.jsx)("p",{className:"text-[11px] font-semibold uppercase tracking-[0.2em] text-slate-400",children:"Drilldown plan"}),(0,s.jsx)("textarea",{value:tc,onChange:e=>tp(e.target.value),placeholder:'{"steps":[...]}',className:"mt-2 h-40 w-full rounded-2xl border border-slate-200 bg-white px-3 py-2 text-xs text-slate-600"}),(0,s.jsxs)("div",{className:"mt-2 flex flex-wrap gap-2",children:[(0,s.jsx)("button",{type:"button",onClick:aZ,className:"rounded-xl bg-slate-900 px-3 py-2 text-xs font-semibold text-white shadow",children:"Apply plan JSON"}),(0,s.jsx)("button",{type:"button",onClick:aH,disabled:eD,className:"rounded-xl border border-slate-200 bg-white px-3 py-2 text-xs font-semibold text-slate-700",children:"Generate plan"})]}),(0,s.jsx)("textarea",{value:tx,onChange:e=>tm(e.target.value),placeholder:"Describe the drilldown steps in natural language...",className:"mt-2 h-16 w-full rounded-2xl border border-slate-200 bg-white px-3 py-2 text-xs text-slate-600"}),tu&&(0,s.jsx)("p",{className:"mt-2 text-xs text-slate-500",children:tu})]}),(0,s.jsx)("button",{type:"button",onClick:aW,className:"w-full rounded-2xl bg-slate-900 px-3 py-2 text-sm font-semibold text-white shadow",children:"Apply reasoner rules"})]})]})]})]}):(0,s.jsx)("p",{className:"mt-4 text-sm text-slate-500",children:"Select a node to edit details."})]})})]})]})}}},function(e){e.O(0,[892,971,117,744],function(){return e(e.s=8354)}),_N_E=e.O()}]);